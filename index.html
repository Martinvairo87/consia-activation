<!-- index.html (PEGAR TODO) -->
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#070a10" />
  <title>CONSIA ‚àû</title>

  <!-- PWA (si ya lo ten√©s, queda) -->
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png" />
  <link rel="apple-touch-icon" href="icon-192.png" />

  <style>
    :root{
      --bg:#05070b;
      --panel:rgba(10,14,22,.62);
      --panel2:rgba(10,14,22,.42);
      --stroke:rgba(255,255,255,.12);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.62);
      --good:#28d17c;
      --warn:#f0b429;
      --bad:#ff4d5e;
      --shadow: 0 24px 80px rgba(0,0,0,.55);
      --r:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background: radial-gradient(1200px 800px at 25% 10%, rgba(60,120,255,.12), transparent 60%),
                  radial-gradient(900px 650px at 80% 60%, rgba(255,255,255,.06), transparent 55%),
                  var(--bg);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      overflow:hidden;
    }

    /* FULLSCREEN AVATAR STAGE */
    #stage{
      position:fixed; inset:0;
      display:flex;
      align-items:flex-end;
      justify-content:center;
      background: #02040a;
    }
    #videoWrap{
      position:absolute; inset:0;
      overflow:hidden;
      background:#02040a;
    }
    #avatarVideo{
      position:absolute; inset:0;
      width:100%; height:100%;
      object-fit:cover;
      filter: saturate(1.05) contrast(1.05) brightness(.98);
      transform: translateZ(0);
      will-change: transform, opacity;
      opacity:1;
    }

    /* TOP BAR */
    #topbar{
      position:absolute; top:14px; left:14px; right:14px;
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      pointer-events:none;
      z-index:6;
    }
    #brand{
      pointer-events:auto;
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border-radius:999px;
      background:linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.05));
      border:1px solid var(--stroke);
      box-shadow: var(--shadow);
      backdrop-filter: blur(16px);
    }
    #dot{
      width:10px; height:10px; border-radius:999px;
      background:var(--good);
      box-shadow:0 0 18px rgba(40,209,124,.6);
    }
    #brand b{letter-spacing:.6px}
    #badges{
      pointer-events:auto;
      display:flex; align-items:center; gap:10px;
    }
    .badge{
      display:flex; align-items:center; gap:8px;
      padding:10px 12px;
      border-radius:999px;
      background:linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.05));
      border:1px solid var(--stroke);
      box-shadow: var(--shadow);
      backdrop-filter: blur(16px);
      color:var(--muted);
      font-size:13px;
      white-space:nowrap;
    }
    .badge strong{color:var(--text); font-weight:700}
    .btnTop{
      pointer-events:auto;
      cursor:pointer;
      user-select:none;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      box-shadow: var(--shadow);
      backdrop-filter: blur(16px);
      color:var(--text);
      font-size:13px;
      font-weight:650;
    }
    .btnTop:active{transform:translateY(1px)}
    #testApi{opacity:.92}
    #ownerBtn{opacity:.92}

    /* INTRO OVERLAY (AUTOPLAY VIDEO + EXPLAIN) */
    #intro{
      position:absolute; inset:0;
      display:flex;
      align-items:flex-end;
      justify-content:center;
      padding:16px;
      z-index:7;
      pointer-events:none;
    }
    #introPanel{
      pointer-events:auto;
      width:min(980px, calc(100% - 12px));
      border-radius:24px;
      border:1px solid rgba(255,255,255,.14);
      background:linear-gradient(180deg, rgba(0,0,0,.55), rgba(10,14,22,.55));
      box-shadow: 0 30px 120px rgba(0,0,0,.62);
      backdrop-filter: blur(18px);
      padding:14px 14px 12px;
      overflow:hidden;
    }
    #introRow{
      display:flex; gap:12px; align-items:flex-start; justify-content:space-between;
      flex-wrap:wrap;
    }
    #introTitle{
      display:flex; flex-direction:column; gap:6px;
      min-width:240px;
    }
    #introTitle b{font-size:16px; letter-spacing:.5px}
    #introTitle span{font-size:13px; color:var(--muted)}
    #introText{
      flex:1;
      font-size:14px;
      line-height:1.35;
      color:rgba(255,255,255,.86);
      padding:8px 10px;
      border-radius:16px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      min-height:56px;
    }
    #introActions{
      display:flex; gap:10px; align-items:center;
      flex-wrap:wrap;
    }
    .cta{
      cursor:pointer; user-select:none;
      padding:12px 14px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background:linear-gradient(180deg, rgba(40,209,124,.24), rgba(40,209,124,.10));
      color:#eafff3;
      font-weight:800;
      letter-spacing:.3px;
    }
    .ghost{
      cursor:pointer; user-select:none;
      padding:12px 14px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      color:rgba(255,255,255,.90);
      font-weight:750;
    }
    .cta:active,.ghost:active{transform:translateY(1px)}
    #hint{
      margin-top:10px;
      font-size:12px;
      color:rgba(255,255,255,.62);
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    #hint kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      padding:2px 8px; border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:rgba(255,255,255,.84);
    }

    /* MAIN UI PANEL */
    #ui{
      position:absolute;
      left:14px; right:14px; bottom:14px;
      width:min(980px, calc(100% - 28px));
      z-index:8;
      border-radius:24px;
      border:1px solid rgba(255,255,255,.14);
      background:linear-gradient(180deg, rgba(10,14,22,.60), rgba(10,14,22,.44));
      box-shadow: 0 30px 120px rgba(0,0,0,.62);
      backdrop-filter: blur(18px);
      overflow:hidden;
    }

    #toolbar{
      display:flex; gap:10px; flex-wrap:wrap;
      align-items:center;
      padding:12px 12px 10px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
    }
    .chip{
      cursor:pointer; user-select:none;
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:rgba(255,255,255,.90);
      font-weight:700;
      font-size:13px;
      white-space:nowrap;
    }
    .chip:active{transform:translateY(1px)}
    .chip.primary{
      border:1px solid rgba(40,209,124,.30);
      background:linear-gradient(180deg, rgba(40,209,124,.22), rgba(40,209,124,.10));
    }
    .chip.danger{
      border:1px solid rgba(255,77,94,.30);
      background:linear-gradient(180deg, rgba(255,77,94,.18), rgba(255,77,94,.08));
    }
    .chip.lock{
      border:1px solid rgba(255,255,255,.16);
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      opacity:.9;
    }

    #log{
      height:260px;
      overflow:auto;
      padding:12px;
      background:rgba(0,0,0,.12);
    }
    .msg{
      display:flex;
      gap:10px;
      margin:10px 0;
    }
    .tag{
      min-width:44px;
      height:24px;
      display:inline-flex; align-items:center; justify-content:center;
      border-radius:999px;
      font-size:12px;
      font-weight:900;
      letter-spacing:.4px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:rgba(255,255,255,.78);
    }
    .bubble{
      flex:1;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.05);
      color:rgba(255,255,255,.90);
      white-space:pre-wrap;
      line-height:1.35;
      font-size:14px;
    }
    .bubble.ai{
      border:1px solid rgba(40,209,124,.22);
      background:linear-gradient(180deg, rgba(40,209,124,.10), rgba(255,255,255,.04));
    }

    #composer{
      display:flex; gap:10px; align-items:flex-end;
      padding:12px;
      border-top:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.10);
    }
    #input{
      flex:1;
      min-height:50px;
      max-height:140px;
      resize:none;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:rgba(255,255,255,.92);
      padding:12px 12px;
      font-size:14px;
      outline:none;
    }
    #send{
      cursor:pointer; user-select:none;
      padding:14px 16px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.16);
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      color:rgba(255,255,255,.92);
      font-weight:900;
    }
    #send:active{transform:translateY(1px)}

    /* CAMERA MODAL */
    #camModal{
      position:absolute; inset:0;
      display:none;
      align-items:center; justify-content:center;
      padding:14px;
      z-index:9;
      background:rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
    }
    #camCard{
      width:min(980px, 100%);
      border-radius:24px;
      border:1px solid rgba(255,255,255,.16);
      background:linear-gradient(180deg, rgba(10,14,22,.75), rgba(10,14,22,.58));
      box-shadow: 0 30px 120px rgba(0,0,0,.62);
      overflow:hidden;
    }
    #camTop{
      display:flex; justify-content:space-between; align-items:center;
      padding:12px 12px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    #camTop b{letter-spacing:.4px}
    #camView{
      width:100%;
      aspect-ratio: 16/9;
      background:#000;
      object-fit:cover;
    }
    #camActions{
      display:flex; gap:10px; flex-wrap:wrap;
      padding:12px;
      border-top:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.18);
    }

    /* SMALL */
    @media (max-width: 640px){
      #log{height:220px}
      #introText{min-height:72px}
    }
  </style>
</head>

<body>
  <div id="stage">
    <div id="videoWrap">
      <!-- USAR TU AVATAR EXISTENTE COMO VIDEO INICIAL (autoplay muted) -->
      <video id="avatarVideo"
             src="avatar.mp4"
             autoplay
             muted
             loop
             playsinline
             preload="auto"></video>
    </div>

    <div id="topbar">
      <div id="brand">
        <span id="dot"></span>
        <b>CONSIA ‚àû</b>
      </div>

      <div id="badges">
        <div class="badge"><strong id="rtLabel">Realtime</strong> <span id="rtState">desconectado</span></div>
        <div class="badge"><strong>API</strong> <span id="apiHost">api.consia.world</span></div>
        <button class="btnTop" id="testApi">Test API</button>
        <button class="btnTop" id="ownerBtn">Owner</button>
      </div>
    </div>

    <!-- INTRO: VIDEO + EXPLICACI√ìN AUTO + 1 CLICK PARA EMPEZAR -->
    <div id="intro">
      <div id="introPanel">
        <div id="introRow">
          <div id="introTitle">
            <b>ENTIDAD CONSIA</b>
            <span>Gu√≠a inmediata. M√≠nimos clicks. Resultado m√°ximo.</span>
          </div>

          <div id="introText">Iniciando‚Ä¶</div>

          <div id="introActions">
            <button class="cta" id="startBtn">EMPEZAR</button>
            <button class="ghost" id="audioBtn">AUDIO</button>
            <button class="ghost" id="skipBtn">SALTEAR</button>
          </div>
        </div>

        <div id="hint">
          <span><kbd>.</kbd> abre gu√≠a</span>
          <span><kbd>Enter</kbd> env√≠a</span>
          <span><kbd>Voz</kbd> = hablar sin escribir</span>
          <span><kbd>C√°mara</kbd> = frontal + an√°lisis</span>
        </div>
      </div>
    </div>

    <!-- UI -->
    <div id="ui">
      <div id="toolbar">
        <button class="chip" id="guideBtn">üß≠ Guiame (3 opciones)</button>
        <button class="chip" id="whatBtn">üß† ¬øQu√© puede hacer?</button>
        <button class="chip" id="hyperBtn">üñºÔ∏è Hiperrealismo</button>
        <button class="chip primary" id="voiceBtn">üéôÔ∏è Voz</button>
        <button class="chip" id="camBtn">üì∑ C√°mara (vivo 100%)</button>
        <button class="chip" id="upBtn">üìé Subir archivo</button>
        <button class="chip" id="readBtn">üëÅÔ∏è Leer</button>
        <button class="chip" id="clearBtn">üßπ Limpiar</button>
        <button class="chip danger" id="stopVoiceBtn">‚õî Stop voz</button>
        <button class="chip lock" id="ownerChip">üîí Owner</button>
      </div>

      <div id="log" aria-live="polite"></div>

      <div id="composer">
        <textarea id="input" placeholder='Dec√≠ lo que quer√©s (o escrib√≠ ".")' rows="2"></textarea>
        <button id="send">Enviar</button>
      </div>
    </div>

    <!-- CAMERA MODAL -->
    <div id="camModal">
      <div id="camCard">
        <div id="camTop">
          <b>CONSIA C√°mara (frontal)</b>
          <button class="btnTop" id="closeCam">Cerrar</button>
        </div>
        <video id="camView" autoplay muted playsinline></video>
        <div id="camActions">
          <button class="chip primary" id="snapBtn">üì∏ Capturar & Enviar</button>
          <button class="chip" id="stopCamBtn">‚õî Detener c√°mara</button>
        </div>
      </div>
    </div>

    <input id="fileInput" type="file" multiple hidden
           accept="image/*,video/*,application/pdf,.pdf,.txt,.doc,.docx,.ppt,.pptx,.xls,.xlsx" />
  </div>

  <script>
    /* ===== CONFIG ===== */
    const API_BASE = "https://api.consia.world";
    const ASK_ENDPOINT = API_BASE + "/ask";
    const HEALTH_ENDPOINT = API_BASE + "/health";
    const REALTIME_WS = API_BASE.replace("https://","wss://") + "/realtime";

    /* ===== STATE ===== */
    const $ = (id)=>document.getElementById(id);
    const avatarVideo = $("avatarVideo");
    const intro = $("intro");
    const introText = $("introText");
    const startBtn = $("startBtn");
    const audioBtn = $("audioBtn");
    const skipBtn = $("skipBtn");
    const rtState = $("rtState");
    const rtLabel = $("rtLabel");
    const apiHost = $("apiHost");
    const logEl = $("log");
    const inputEl = $("input");
    const ownerChip = $("ownerChip");

    apiHost.textContent = new URL(API_BASE).host;

    let ownerMode = false;
    let ws = null;
    let wsTimer = null;

    /* ===== INTRO SCRIPT (AUTO EXPLAIN) ===== */
    const INTRO_LINES = [
      "Soy CONSIA. Tu entidad de ejecuci√≥n: texto, voz, archivos, c√°mara y realtime.",
      "Te gu√≠o con lo m√≠nimo: 1 pregunta, 1 frase tuya, y ejecuto.",
      "Pod√©s subir fotos, videos y documentos para an√°lisis completo.",
      "Con c√°mara frontal, analizo en vivo y genero hiperrealismo seg√∫n tus indicaciones.",
      "Reglas madre: CONSIA siempre. Privacy-first. Fail-closed. Owner-Only para cambios.",
      "Toc√° EMPEZAR y dec√≠: ‚ÄúHola CONSIA‚Äù o escrib√≠ ‚Äú.‚Äù."
    ];
    let introIdx = 0;
    let introPlaying = true;

    function runIntroText(){
      introText.textContent = INTRO_LINES[introIdx] || INTRO_LINES[INTRO_LINES.length-1];
      introIdx = Math.min(introIdx + 1, INTRO_LINES.length-1);
      if(introPlaying) setTimeout(runIntroText, 1800);
    }

    /* ===== VIDEO STABILITY (NO FLASH / NO DISAPPEAR) ===== */
    function keepVideoAlive(){
      avatarVideo.playsInline = true;
      avatarVideo.muted = true;
      avatarVideo.loop = true;
      const tryPlay = ()=>avatarVideo.play().catch(()=>{});
      tryPlay();
      document.addEventListener("visibilitychange", ()=>{ if(!document.hidden) tryPlay(); });
      window.addEventListener("focus", tryPlay);
      window.addEventListener("pageshow", tryPlay);
      avatarVideo.addEventListener("error", ()=>{ setTimeout(tryPlay, 600); });
    }

    /* ===== LOG ===== */
    function addMsg(tag, text, cls=""){
      const row = document.createElement("div");
      row.className = "msg";
      const t = document.createElement("div");
      t.className = "tag";
      t.textContent = tag;
      const b = document.createElement("div");
      b.className = "bubble" + (cls ? (" " + cls) : "");
      b.textContent = text;
      row.appendChild(t);
      row.appendChild(b);
      logEl.appendChild(row);
      logEl.scrollTop = logEl.scrollHeight;
    }

    /* ===== OWNER MODE (UI GATE; BACKEND DEBE ENFORZAR) ===== */
    async function toggleOwner(){
      // Minimal: 1 prompt (texto o dictado) -> backend valida. (No guardamos nada ac√°.)
      const code = prompt("OWNER CODE:");
      if(!code) return;
      // Se manda al backend como header. El backend decide.
      try{
        const res = await fetch(HEALTH_ENDPOINT, { headers: { "x-consia-owner": code } });
        if(res.ok){
          ownerMode = true;
          ownerChip.textContent = "üîí Owner: ON";
          addMsg("SYS","Owner mode activo.");
        }else{
          ownerMode = false;
          ownerChip.textContent = "üîí Owner";
          addMsg("SYS","Owner rechazado.");
        }
      }catch{
        addMsg("SYS","Owner: error de conexi√≥n.");
      }
    }

    /* ===== API CALL (TEXT + OPTIONAL ATTACHMENTS) ===== */
    async function askConsia(text, files=[]) {
      const form = new FormData();
      form.append("message", text);
      form.append("lang", "ES");
      form.append("realtime", "auto");
      form.append("owner", ownerMode ? "1" : "0");
      for (const f of files) form.append("files", f, f.name);

      const headers = {};
      // Si quer√©s device/session headers, agregalos ac√°:
      // headers["x-consia-device"] = "...";
      // headers["x-consia-session"] = "...";

      const res = await fetch(ASK_ENDPOINT, { method:"POST", body: form, headers });
      const data = await res.json().catch(()=>({ ok:false, error:"bad_json" }));
      return data;
    }

    /* ===== REALTIME (AUTO RECONNECT) ===== */
    function setRT(ok){
      rtState.textContent = ok ? "conectado" : "desconectado";
      rtLabel.style.color = ok ? "rgba(255,255,255,.92)" : "rgba(255,255,255,.72)";
    }

    function rtConnect(){
      try{
        if(ws) ws.close();
        ws = new WebSocket(REALTIME_WS);
        ws.onopen = ()=>{ setRT(true); addMsg("SYS","Realtime conectado."); };
        ws.onmessage = (ev)=>{
          // Si tu backend manda JSON, lo mostramos; si no, string.
          let txt = ev.data;
          try{ txt = JSON.stringify(JSON.parse(ev.data), null, 0); }catch{}
          addMsg("SYS", txt);
        };
        ws.onclose = ()=>{ setRT(false); scheduleRT(); };
        ws.onerror = ()=>{ setRT(false); scheduleRT(); };
      }catch{
        setRT(false); scheduleRT();
      }
    }
    function scheduleRT(){
      clearTimeout(wsTimer);
      wsTimer = setTimeout(rtConnect, 1500);
    }

    /* ===== VOICE (ASR) ===== */
    let rec = null;
    let recognizing = false;

    function getRecognizer(){
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if(!SR) return null;
      const r = new SR();
      r.lang = "es-AR";
      r.continuous = false;
      r.interimResults = true;
      return r;
    }

    function voiceStart(){
      if(recognizing) return;
      if(!rec) rec = getRecognizer();
      if(!rec){ addMsg("SYS","Voz: no soportado en este navegador."); return; }

      let finalText = "";
      recognizing = true;
      addMsg("SYS","Voz: listo. Habl√°.");

      rec.onresult = (e)=>{
        let t = "";
        for(let i=e.resultIndex;i<e.results.length;i++){
          t += e.results[i][0].transcript;
          if(e.results[i].isFinal) finalText += e.results[i][0].transcript + " ";
        }
        // feedback m√≠nimo
        if(t.trim()) $("input").value = (finalText + t).trim();
      };

      rec.onend = async ()=>{
        recognizing = false;
        const msg = ($("input").value || "").trim();
        if(msg) await sendText(msg);
      };

      rec.onerror = ()=>{ recognizing=false; addMsg("SYS","Voz: error."); };
      rec.start();
    }

    function voiceStop(){
      try{ rec && rec.stop(); }catch{}
      recognizing = false;
      addMsg("SYS","Voz: stop.");
    }

    /* ===== CAMERA (FRONTAL) ===== */
    const camModal = $("camModal");
    const camView = $("camView");
    let camStream = null;

    async function openCamera(){
      try{
        camStream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "user", width: { ideal: 1280 }, height: { ideal: 720 } },
          audio: false
        });
        camView.srcObject = camStream;
        camModal.style.display = "flex";
      }catch{
        addMsg("SYS","C√°mara: permiso denegado o no disponible.");
      }
    }

    function stopCamera(){
      if(camStream){
        camStream.getTracks().forEach(t=>t.stop());
        camStream = null;
      }
      camView.srcObject = null;
      camModal.style.display = "none";
    }

    async function snapAndSend(){
      if(!camStream) return;
      const v = camView;
      const c = document.createElement("canvas");
      const w = v.videoWidth || 1280;
      const h = v.videoHeight || 720;
      c.width = w; c.height = h;
      const ctx = c.getContext("2d");
      ctx.drawImage(v, 0, 0, w, h);
      const blob = await new Promise(res=>c.toBlob(res, "image/jpeg", 0.92));
      const file = new File([blob], "camera.jpg", { type:"image/jpeg" });

      addMsg("YOU","[C√°mara frontal] Analiz√° y ejecut√° seg√∫n mi instrucci√≥n.");
      const data = await askConsia("C√°mara frontal (vivo 100%): analiz√° esta imagen y ejecut√°.", [file]);
      addMsg("AI", (data.reply || JSON.stringify(data)).toString(), "ai");
      // c√°mara queda abierta
    }

    /* ===== FILE UPLOAD ===== */
    const fileInput = $("fileInput");
    function pickFiles(){ fileInput.click(); }
    fileInput.addEventListener("change", async ()=>{
      const files = [...fileInput.files];
      if(!files.length) return;
      addMsg("YOU", `Adjuntos: ${files.map(f=>f.name).join(", ")}`);
      const msg = (inputEl.value || "Analiz√° estos archivos al 100% y devolv√© lo esencial.").trim();
      const data = await askConsia(msg, files);
      addMsg("AI", (data.reply || JSON.stringify(data)).toString(), "ai");
      fileInput.value = "";
    });

    /* ===== SEND ===== */
    async function sendText(text){
      addMsg("YOU", text);
      inputEl.value = "";
      const data = await askConsia(text);
      addMsg("AI", (data.reply || JSON.stringify(data)).toString(), "ai");
    }

    /* ===== QUICK ACTIONS (MIN CLICKS) ===== */
    function oneQuestion3Options(topic){
      if(topic==="guide"){
        return `Guiame: dame 3 opciones y pedime lo m√≠nimo en 1 sola pregunta. Luego esper√° mi 1 frase y ejecut√°.`;
      }
      if(topic==="what"){
        return `¬øQu√© puede hacer CONSIA hoy? List√° funciones reales disponibles (texto/voz/realtime/archivos/c√°mara) y pedime lo m√≠nimo.`;
      }
      if(topic==="hyper"){
        return `Hiperrealismo: 3 opciones (Imagen/Video/Avatar). Pedime lo m√≠nimo en 1 sola pregunta. Luego esper√° mi 1 frase y ejecut√°.`;
      }
      if(topic==="read"){
        return `Le√© el contexto visible y decime lo esencial. Pedime 1 dato m√≠nimo si falta.`;
      }
      return `.`;
    }

    /* ===== INTRO CONTROL ===== */
    function closeIntro(){
      introPlaying = false;
      intro.style.display = "none";
      addMsg("SYS","CONSIA UI activo. Input siempre visible. Idioma ES.");
      // Autoinstrucci√≥n m√≠nima
      addMsg("SYS",'Dec√≠ "Hola CONSIA" o escrib√≠ "."');
    }

    function speakIntro(){
      // iOS/Safari requiere gesto: esto lo dispara el bot√≥n AUDIO (1 click)
      const text = INTRO_LINES.join(" ");
      try{
        const u = new SpeechSynthesisUtterance(text);
        u.lang = "es-AR";
        u.rate = 1.02;
        u.pitch = 1.0;
        speechSynthesis.cancel();
        speechSynthesis.speak(u);
        addMsg("SYS","Audio: ON.");
      }catch{
        addMsg("SYS","Audio: no disponible.");
      }
    }

    /* ===== WIRE UI ===== */
    $("send").onclick = ()=>{ const t=(inputEl.value||"").trim(); if(t) sendText(t); };
    inputEl.addEventListener("keydown",(e)=>{
      if(e.key==="Enter" && !e.shiftKey){
        e.preventDefault();
        const t=(inputEl.value||"").trim();
        if(t) sendText(t);
      }
      if(e.key==="." && inputEl.value.trim()===""){
        // s√≥lo si empieza con "."
      }
    });

    $("guideBtn").onclick = ()=>sendText(oneQuestion3Options("guide"));
    $("whatBtn").onclick = ()=>sendText(oneQuestion3Options("what"));
    $("hyperBtn").onclick = ()=>sendText(oneQuestion3Options("hyper"));
    $("readBtn").onclick = ()=>sendText(oneQuestion3Options("read"));
    $("clearBtn").onclick = ()=>{ logEl.innerHTML=""; addMsg("SYS","Limpio."); };
    $("voiceBtn").onclick = voiceStart;
    $("stopVoiceBtn").onclick = voiceStop;
    $("camBtn").onclick = openCamera;
    $("upBtn").onclick = pickFiles;
    $("closeCam").onclick = stopCamera;
    $("stopCamBtn").onclick = stopCamera;
    $("snapBtn").onclick = snapAndSend;

    $("testApi").onclick = async ()=>{
      try{
        const r = await fetch(HEALTH_ENDPOINT);
        const j = await r.json().catch(()=>({ok:r.ok}));
        addMsg("SYS", "Test API: " + (j.service || (r.ok ? "OK" : "FAIL")));
      }catch{
        addMsg("SYS","Test API: error.");
      }
    };

    $("ownerBtn").onclick = toggleOwner;
    ownerChip.onclick = toggleOwner;

    startBtn.onclick = closeIntro;
    skipBtn.onclick = closeIntro;
    audioBtn.onclick = speakIntro;

    /* ===== INIT ===== */
    (function init(){
      keepVideoAlive();
      setRT(false);
      rtConnect();

      // Intro autoplay text (video ya corre en background)
      runIntroText();

      // One-tap anywhere (optional) => unlock audio/video if user wants
      document.addEventListener("click", ()=>{ avatarVideo.play().catch(()=>{}); }, { once:true });

      // "." comando
      window.addEventListener("keydown",(e)=>{
        if(e.key==="." && document.activeElement!==inputEl){
          inputEl.focus();
          inputEl.value=".";
        }
      });
    })();
  </script>

  <script>
    // SW (si existe) - no rompe nada
    if("serviceWorker" in navigator){
      navigator.serviceWorker.register("./sw.js").catch(()=>{});
    }
  </script>
</body>
</html>
