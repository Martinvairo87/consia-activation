<!-- index.html ‚Äî CONSIA_UI_SEALED v1.0 ‚Äî pegar TODO -->
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#070A10" />
  <title>CONSIA ‚àû</title>
  <style>
    :root{
      --bg:#05070c;
      --panel:rgba(255,255,255,.04);
      --panel2:rgba(255,255,255,.06);
      --stroke:rgba(255,255,255,.10);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.64);
      --good:#2ef2a3;
      --warn:#ffd36b;
      --bad:#ff5b7a;
      --shadow: 0 18px 70px rgba(0,0,0,.55);
      --radius:18px;
      --radius2:26px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:radial-gradient(1200px 600px at 20% -10%, rgba(80,140,255,.18), transparent 60%),
      radial-gradient(900px 500px at 90% 10%, rgba(255,210,120,.10), transparent 55%),
      radial-gradient(1000px 700px at 60% 120%, rgba(80,255,200,.08), transparent 60%),
      var(--bg);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      overflow-x:hidden;
    }
    .wrap{max-width:1200px; margin:0 auto; padding:18px 18px 22px}
    header{
      display:flex; align-items:center; justify-content:space-between; gap:14px; padding:10px 2px 14px;
    }
    .brand{display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.5px}
    .dot{width:10px; height:10px; border-radius:999px; background:var(--good); box-shadow:0 0 20px rgba(46,242,163,.6)}
    .pill{
      display:flex; align-items:center; gap:10px;
      background:rgba(255,255,255,.03); border:1px solid var(--stroke);
      padding:9px 12px; border-radius:999px; box-shadow:var(--shadow);
      color:var(--muted); font-size:13px;
    }
    .pill b{color:var(--text); font-weight:700}
    .btn{
      appearance:none; border:1px solid var(--stroke); background:rgba(255,255,255,.03);
      color:var(--text); padding:10px 12px; border-radius:999px; cursor:pointer;
      display:inline-flex; align-items:center; gap:8px;
      transition:transform .06s ease, background .2s ease, border-color .2s ease;
      user-select:none;
    }
    .btn:hover{background:rgba(255,255,255,.05)}
    .btn:active{transform:translateY(1px)}
    .btn.primary{border-color:rgba(46,242,163,.35); background:rgba(46,242,163,.07)}
    .btn.gold{border-color:rgba(255,211,107,.35); background:rgba(255,211,107,.08)}
    .btn.bad{border-color:rgba(255,91,122,.35); background:rgba(255,91,122,.08)}
    .grid{display:grid; grid-template-columns: 1.2fr .8fr; gap:16px}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }
    .hero{
      position:relative; border-radius:var(--radius2);
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--stroke); overflow:hidden; box-shadow:var(--shadow);
      min-height: 320px;
    }
    .hero video, .hero img{
      position:absolute; inset:0; width:100%; height:100%;
      object-fit:cover;           /* FIX: nunca cortado feo */
      object-position:center;     /* centro */
      transform:scale(1.02);
      filter:saturate(1.12) contrast(1.08);
    }
    .hero::after{
      content:""; position:absolute; inset:0;
      background: radial-gradient(700px 250px at 55% 65%, rgba(0,0,0,.10), rgba(0,0,0,.75));
      pointer-events:none;
    }
    .heroHUD{
      position:absolute; left:18px; right:18px; bottom:14px;
      display:flex; align-items:flex-end; justify-content:space-between; gap:12px; z-index:2;
    }
    .heroLeft{display:flex; flex-direction:column; gap:6px}
    .heroLeft .small{color:rgba(255,255,255,.72); font-size:13px}
    .heroLeft .small .ok{color:var(--good)}
    .heroLeft .small .ko{color:var(--bad)}
    .heroSpeak{
      background:rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.12);
      padding:10px 12px; border-radius:999px; color:rgba(255,255,255,.82);
      backdrop-filter: blur(10px);
      max-width: 72%;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .panel{
      border-radius:var(--radius);
      background:rgba(255,255,255,.03);
      border:1px solid var(--stroke);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .panelHead{
      padding:12px 14px; display:flex; align-items:center; justify-content:space-between; gap:10px;
      background:rgba(255,255,255,.02);
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .panelBody{padding:12px 14px}
    .rowBtns{display:flex; flex-wrap:wrap; gap:10px}
    .chat{
      height: 420px; overflow:auto; padding:12px 14px;
      background:linear-gradient(180deg, rgba(0,0,0,.22), rgba(0,0,0,.35));
    }
    .msg{display:flex; gap:10px; margin:10px 0}
    .tag{
      min-width:44px; height:26px; padding:0 10px; border-radius:999px;
      display:inline-flex; align-items:center; justify-content:center;
      font-size:12px; font-weight:800; letter-spacing:.4px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      color:rgba(255,255,255,.75);
    }
    .bubble{
      flex:1;
      border-radius:14px;
      padding:12px 12px;
      background:rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.08);
      color:rgba(255,255,255,.90);
      line-height:1.35;
      white-space:pre-wrap;
      word-break:break-word;
    }
    .bubble.ai{background:rgba(46,242,163,.06); border-color:rgba(46,242,163,.18)}
    .bubble.sys{background:rgba(255,255,255,.03)}
    .composer{
      display:flex; gap:10px; padding:12px; border-top:1px solid rgba(255,255,255,.06);
      background:rgba(255,255,255,.02);
    }
    textarea{
      flex:1; resize:none; height:56px; max-height:140px;
      background:rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.12);
      color:var(--text);
      padding:12px 12px;
      border-radius:14px;
      outline:none;
    }
    .meta{display:flex; gap:14px; flex-wrap:wrap; font-size:12px; color:rgba(255,255,255,.62); padding:8px 12px}
    .kbd{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; padding:.5px 6px; border-radius:7px; border:1px solid rgba(255,255,255,.12); background:rgba(0,0,0,.25)}
    .camPreview{
      width:100%;
      aspect-ratio: 16/9;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
      background:rgba(0,0,0,.35);
      display:none;
      margin-top:10px;
    }
    .camPreview video{width:100%; height:100%; object-fit:cover; object-position:center; transform:scale(1.02)}
    .hint{color:rgba(255,255,255,.70); font-size:13px}
    .smallnote{color:rgba(255,255,255,.55); font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand"><span class="dot" id="dot"></span> CONSIA ‚àû</div>
      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap">
        <div class="pill"><span id="rtBadge">REALTIME</span> ¬∑ <b id="rtState">auto</b></div>
        <button class="btn" id="btnTest">Test API</button>
      </div>
    </header>

    <div class="grid">
      <div class="hero" aria-label="Avatar CONSIA">
        <video id="avatarVideo" src="avatar.mp4" autoplay muted loop playsinline></video>
        <img id="avatarImg" alt="" style="display:none" />
        <div class="heroHUD">
          <div class="heroLeft">
            <div class="small">
              <span id="realtimeText" class="ok">‚óè</span>
              <span id="realtimeLabel">Realtime conectando...</span>
            </div>
            <div class="small">API: <span id="apiLabel">api.consia.world</span></div>
          </div>
          <div class="heroSpeak" id="heroSpeak">Dec√≠ ‚ÄúHola CONSIA‚Äù o escrib√≠ abajo. (voz si el navegador soporta)</div>
        </div>
      </div>

      <div class="panel">
        <div class="panelHead">
          <div class="hint">Control ultra (click / voz / texto)</div>
          <div class="rowBtns">
            <button class="btn primary" id="btnSpeak">Hablar</button>
            <button class="btn" id="btnStopVoice">Stop voz</button>
            <button class="btn" id="btnClear">Limpiar</button>
          </div>
        </div>
        <div class="panelBody">
          <div class="rowBtns">
            <button class="btn" id="btnGuide">üß≠ Guiame (3 opciones)</button>
            <button class="btn" id="btnCanDo">üß† ¬øQu√© puede hacer?</button>
            <button class="btn" id="btnHyper">üñºÔ∏è Hiperrealismo</button>
            <button class="btn gold" id="btnAscend">‚ö° ASCEND</button>
          </div>

          <div style="height:10px"></div>

          <div class="rowBtns">
            <label class="btn" style="cursor:pointer">
              üìé Subir archivo
              <input id="fileInput" type="file" multiple style="display:none" />
            </label>
            <button class="btn" id="btnCamera">üì∑ C√°mara (frontal)</button>
            <button class="btn" id="btnCameraLive">üé• C√°mara (vivo 10%)</button>
            <button class="btn" id="btnAvatarMorph">‚ú® Avatar (morph)</button>
          </div>

          <div class="camPreview" id="camBox">
            <video id="camVideo" autoplay muted playsinline></video>
          </div>

          <div style="height:10px"></div>
          <div class="smallnote" id="attachNote">Adjuntos: 0</div>
          <div class="smallnote">Archivos/c√°mara se env√≠an como contexto al endpoint <span class="kbd">/ask</span>.</div>
        </div>
      </div>
    </div>

    <div style="height:14px"></div>

    <div class="panel">
      <div class="chat" id="chat"></div>

      <div class="composer">
        <textarea id="input" placeholder='Dec√≠ lo que quer√©s (o escrib√≠ ".")'></textarea>
        <button class="btn primary" id="send">Enviar</button>
      </div>

      <div class="meta">
        <div>Idioma: <b id="lang">ES</b></div>
        <div>Realtime: <b id="rtMode">auto</b></div>
        <div>Adjuntos: <b id="attachCount">0</b></div>
        <div>Voz: <b id="voiceState">listo</b></div>
      </div>
    </div>
  </div>

<script>
(() => {
  const API_BASE = (localStorage.getItem("CONSIA_API_BASE") || "https://api.consia.world").replace(/\/+$/,"");
  const ASK_URL = API_BASE + "/ask";
  const WS_URL  = API_BASE.replace(/^http/,"ws") + "/realtime";

  const chat = document.getElementById("chat");
  const input = document.getElementById("input");
  const sendBtn = document.getElementById("send");
  const btnTest = document.getElementById("btnTest");

  const attachCount = document.getElementById("attachCount");
  const attachNote = document.getElementById("attachNote");

  const rtLabel = document.getElementById("realtimeLabel");
  const rtDot = document.getElementById("realtimeText");

  const camBox = document.getElementById("camBox");
  const camVideo = document.getElementById("camVideo");

  const heroSpeak = document.getElementById("heroSpeak");

  let files = [];
  let ws = null;

  // Voice (STT + TTS) ‚Äî ejecuta real, no depende del modelo
  const voiceState = document.getElementById("voiceState");
  const btnSpeak = document.getElementById("btnSpeak");
  const btnStopVoice = document.getElementById("btnStopVoice");

  const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
  const canSTT = !!SpeechRec;
  const rec = canSTT ? new SpeechRec() : null;
  let listening = false;

  if (rec) {
    rec.lang = "es-AR";
    rec.interimResults = false;
    rec.maxAlternatives = 1;
    rec.onresult = (e) => {
      const text = (e.results?.[0]?.[0]?.transcript || "").trim();
      if (text) {
        input.value = text;
        send();
      }
    };
    rec.onend = () => {
      listening = false;
      voiceState.textContent = "listo";
      btnSpeak.textContent = "Hablar";
    };
  }

  function speak(text){
    try{
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text.slice(0, 1200));
      u.lang = "es-ES";
      u.rate = 1.0;
      u.pitch = 1.0;
      window.speechSynthesis.speak(u);
    }catch{}
  }

  btnSpeak.onclick = () => {
    if (!rec) { pushSys("SYS", "Voz: navegador sin SpeechRecognition."); return; }
    if (listening) { rec.stop(); return; }
    listening = true;
    voiceState.textContent = "escuchando";
    btnSpeak.textContent = "Escuchando‚Ä¶";
    rec.start();
  };

  btnStopVoice.onclick = () => {
    try { window.speechSynthesis.cancel(); } catch {}
    if (rec && listening) { try { rec.stop(); } catch {} }
    voiceState.textContent = "listo";
    btnSpeak.textContent = "Hablar";
  };

  // Chat UI
  function pushMsg(tag, text, cls="") {
    const row = document.createElement("div");
    row.className = "msg";
    const t = document.createElement("div");
    t.className = "tag";
    t.textContent = tag;
    const b = document.createElement("div");
    b.className = "bubble " + cls;
    b.textContent = (text || "").replaceAll("Concia","CONSIA").replaceAll("concia","CONSIA");
    row.appendChild(t); row.appendChild(b);
    chat.appendChild(row);
    chat.scrollTop = chat.scrollHeight;
  }
  function pushSys(tag, text){ pushMsg(tag, text, "sys"); }
  function pushAI(text){ pushMsg("AI", text, "ai"); heroSpeak.textContent = (text || "").slice(0, 120); speak(text || ""); }

  // Realtime
  function connectWS(){
    try{
      ws = new WebSocket(WS_URL);
      ws.onopen = () => { rtDot.textContent="‚óè"; rtDot.className="ok"; rtLabel.textContent="Realtime conectado."; };
      ws.onclose = () => { rtDot.textContent="‚óè"; rtDot.className="ko"; rtLabel.textContent="Realtime desconectado."; setTimeout(connectWS, 1800); };
      ws.onmessage = (e) => {
        try{
          const j = JSON.parse(e.data);
          if (j?.type === "hello") pushSys("SYS", JSON.stringify(j));
        }catch{}
      };
    }catch{
      rtDot.textContent="‚óè"; rtDot.className="ko"; rtLabel.textContent="Realtime no disponible.";
    }
  }
  connectWS();

  // Test API
  btnTest.onclick = async () => {
    const r = await fetch(API_BASE + "/health").catch(()=>null);
    if (!r) return pushSys("SYS","API offline.");
    const j = await r.json().catch(()=>({}));
    pushSys("SYS", JSON.stringify(j, null, 2));
  };

  // Attachments
  const fileInput = document.getElementById("fileInput");
  fileInput.onchange = () => {
    files = Array.from(fileInput.files || []);
    attachCount.textContent = String(files.length);
    attachNote.textContent = "Adjuntos: " + files.length;
    pushSys("SYS", `Adjuntos cargados: ${files.map(f=>f.name).join(", ") || "0"}`);
  };

  // Camera (FRONTAL)
  let camStream = null;
  async function startCam(){
    if (camStream) return;
    camStream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "user" },  // FIX: frontal
      audio: false
    });
    camVideo.srcObject = camStream;
    camBox.style.display = "block";
  }
  function stopCam(){
    if (!camStream) return;
    camStream.getTracks().forEach(t=>t.stop());
    camStream = null;
    camVideo.srcObject = null;
    camBox.style.display = "none";
  }
  async function snapJpegBlob(){
    const v = camVideo;
    const c = document.createElement("canvas");
    const w = Math.max(640, v.videoWidth || 640);
    const h = Math.max(360, v.videoHeight || 360);
    c.width = w; c.height = h;
    const ctx = c.getContext("2d");
    ctx.drawImage(v, 0, 0, w, h);
    return await new Promise(res => c.toBlob(res, "image/jpeg", 0.86));
  }

  document.getElementById("btnCamera").onclick = async () => {
    try{
      await startCam();
      pushSys("SYS","C√°mara frontal lista.");
    }catch{
      pushSys("SYS","C√°mara bloqueada. Permit√≠ acceso.");
    }
  };

  // Camera live 10% (env√≠a 1 frame por acci√≥n, SAFE)
  document.getElementById("btnCameraLive").onclick = async () => {
    try{
      await startCam();
      const blob = await snapJpegBlob();
      files = [new File([blob], "camera_live.jpg", { type:"image/jpeg" })];
      attachCount.textContent = "1";
      attachNote.textContent = "Adjuntos: 1 (camera_live.jpg)";
      pushSys("SYS","Frame tomado (vivo 10%). Decime 1 frase: d√≥nde/qu√© quer√©s ‚Äúteletransportar‚Äù en hiperrealismo.");
    }catch{
      pushSys("SYS","No se pudo usar c√°mara.");
    }
  };

  // Avatar morph (env√≠a prompt al backend)
  document.getElementById("btnAvatarMorph").onclick = async () => {
    const p = (input.value || "").trim();
    if (!p) { pushSys("SYS","Escrib√≠ 1 frase del nuevo aspecto del avatar y toc√° Avatar (morph)."); return; }
    const r = await fetch(API_BASE + "/avatar/transform", {
      method:"POST",
      headers:{ "content-type":"application/json" },
      body: JSON.stringify({ prompt: p })
    }).catch(()=>null);
    if (!r) return pushSys("SYS","Backend offline para morph.");
    const j = await r.json().catch(()=>({}));
    pushSys("SYS", (j?.reply || "Avatar actualizado."));
    if (j?.avatar?.url) {
      // si hay url renderizada, la usamos
      const av = document.getElementById("avatarVideo");
      av.pause();
      av.removeAttribute("src");
      const img = document.getElementById("avatarImg");
      img.src = j.avatar.url;
      img.style.display = "block";
      av.style.display = "none";
    }
  };

  // Buttons preset
  document.getElementById("btnGuide").onclick = () => { input.value = "Guiame: dame 3 opciones y pedime lo m√≠nimo en 1 sola pregunta. Luego esper√° mi 1 frase y ejecut√°."; send(); };
  document.getElementById("btnCanDo").onclick = () => { input.value = "¬øQu√© puede hacer CONSIA hoy? List√° funciones reales disponibles (texto/voz/realtime/archivos/c√°mara) y pedime lo m√≠nimo."; send(); };
  document.getElementById("btnHyper").onclick = () => { input.value = "Hiperrealismo: dame 3 opciones (Imagen/Video/Avatar). Pedime lo m√≠nimo en 1 sola pregunta. Luego esper√° mi 1 frase y ejecut√°."; send(); };
  document.getElementById("btnAscend").onclick = () => { input.value = "ASCEND: modo ultra. Respuestas cortas. 1 pregunta m√≠nima. Checklist inmediato."; send(); };

  // Clear
  document.getElementById("btnClear").onclick = () => {
    chat.innerHTML = "";
    pushSys("SYS","CONSIA UI HOTFIX activo. Input siempre visible. Idioma ES.");
  };

  // Send
  async function send(){
    let msg = (input.value || "").trim();
    if (!msg && files.length === 0) return;

    msg = msg.replaceAll("Concia","CONSIA").replaceAll("concia","CONSIA");
    pushMsg("YO", msg || "(adjuntos)", "");

    input.value = "";

    let res = null;

    // multipart si hay adjuntos, sino JSON
    if (files.length > 0) {
      const fd = new FormData();
      fd.append("message", msg || "Analiz√° adjuntos.");
      fd.append("mode", "mixed");
      fd.append("lang", "ES");
      files.forEach((f,i)=>fd.append("file"+i, f, f.name));
      res = await fetch(ASK_URL, { method:"POST", body: fd }).catch(()=>null);
    } else {
      res = await fetch(ASK_URL, {
        method:"POST",
        headers:{ "content-type":"application/json" },
        body: JSON.stringify({ message: msg, mode:"text", lang:"ES" })
      }).catch(()=>null);
    }

    // reset adjuntos post env√≠o
    files = [];
    fileInput.value = "";
    attachCount.textContent = "0";
    attachNote.textContent = "Adjuntos: 0";

    if (!res) return pushAI("CONSIA: backend offline. Decime 1 objetivo y lo ejecuto en modo local.");

    const j = await res.json().catch(()=>({}));
    if (!j?.ok) return pushAI("CONSIA: error: " + (j?.error || "unknown"));

    pushAI(j.reply || "CONSIA: listo.");
  }

  sendBtn.onclick = send;
  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); send(); }
  });

  // Boot
  document.getElementById("apiLabel").textContent = API_BASE.replace(/^https?:\/\//,"");
  pushSys("SYS","CONSIA UI HOTFIX activo. Input siempre visible. Idioma ES.");
})();
</script>
</body>
</html>
