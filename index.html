<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>CONSIA âˆž</title>
  <meta name="theme-color" content="#06070b" />
  <style>
    :root{
      --bg:#05070c; --card:rgba(10,14,22,.62); --stroke:rgba(255,255,255,.08);
      --text:#e9f2ff; --muted:rgba(233,242,255,.72);
      --glow: 0 0 24px rgba(90,200,255,.18), 0 0 60px rgba(90,200,255,.10);
      --r:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%; margin:0; background:var(--bg); color:var(--text); font-family: system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;}
    .wrap{max-width:1180px; margin:0 auto; padding:18px 14px 24px;}
    .top{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px;}
    .brand{display:flex; align-items:center; gap:10px; font-weight:700; letter-spacing:.6px;}
    .dot{width:9px; height:9px; border-radius:50%; background:#25ffb1; box-shadow:0 0 14px rgba(37,255,177,.35);}
    .pill{display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border:1px solid var(--stroke); border-radius:999px; background:rgba(0,0,0,.25); backdrop-filter: blur(10px); box-shadow: var(--glow);}
    .pill small{opacity:.85}
    .hero{
      position:relative; overflow:hidden; border-radius:22px;
      border:1px solid var(--stroke); background:rgba(0,0,0,.25);
      box-shadow: 0 18px 70px rgba(0,0,0,.55);
    }
    .avatar{
      width:100%;
      height:min(48vh,420px);
      background: radial-gradient(1200px 420px at 50% 10%, rgba(90,200,255,.15), transparent 60%),
                  radial-gradient(900px 380px at 20% 70%, rgba(37,255,177,.10), transparent 55%),
                  linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,.55));
    }
    video{
      width:100%; height:100%; display:block;
      object-fit:cover; object-position:center center; /* NO CORTA */
      filter: contrast(1.08) saturate(1.06);
    }
    .overlay{
      position:absolute; inset:0; pointer-events:none;
      background: radial-gradient(1200px 440px at 55% 15%, rgba(255,255,255,.10), transparent 55%),
                  radial-gradient(800px 340px at 25% 65%, rgba(90,200,255,.10), transparent 55%),
                  radial-gradient(700px 320px at 78% 70%, rgba(37,255,177,.08), transparent 55%),
                  linear-gradient(180deg, rgba(0,0,0,.15), rgba(0,0,0,.55));
      mix-blend-mode: screen;
      opacity:.9;
    }
    .hud{
      position:absolute; left:14px; bottom:14px; right:14px;
      display:flex; flex-wrap:wrap; align-items:center; justify-content:space-between; gap:10px;
      pointer-events:auto;
    }
    .hud-left{display:flex; flex-direction:column; gap:6px}
    .hud-row{display:flex; flex-wrap:wrap; gap:8px; align-items:center}
    .btn{
      appearance:none; border:1px solid var(--stroke);
      background:rgba(10,14,22,.72); color:var(--text);
      padding:10px 12px; border-radius:999px; cursor:pointer;
      box-shadow: var(--glow);
      font-weight:650;
    }
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:rgba(18,34,56,.78)}
    .btn.warn{background:rgba(64,26,26,.70)}
    .btn.ok{background:rgba(18,44,34,.72)}
    .hint{color:var(--muted); font-size:13px}
    .panel{
      margin-top:12px;
      border:1px solid var(--stroke); border-radius:22px;
      background:var(--card); backdrop-filter: blur(12px);
      box-shadow: var(--glow);
      overflow:hidden;
    }
    .bar{
      display:flex; gap:8px; flex-wrap:wrap; padding:12px; border-bottom:1px solid var(--stroke);
    }
    .chat{padding:12px; max-height:44vh; overflow:auto}
    .msg{border:1px solid var(--stroke); border-radius:18px; padding:12px; margin:10px 0; background:rgba(0,0,0,.18)}
    .sys{opacity:.85}
    .you{background:rgba(18,34,56,.25)}
    .ai{background:rgba(12,44,34,.22)}
    .inputRow{display:flex; gap:10px; padding:12px; border-top:1px solid var(--stroke); align-items:flex-end}
    textarea{
      flex:1; min-height:54px; max-height:140px; resize:vertical;
      border-radius:18px; border:1px solid var(--stroke);
      padding:12px; background:rgba(0,0,0,.22); color:var(--text);
      outline:none;
    }
    .send{min-width:120px; padding:14px 16px; border-radius:18px;}
    .row2{display:flex; gap:10px; flex-wrap:wrap; padding:12px; border-top:1px solid var(--stroke)}
    .file{display:flex; align-items:center; gap:10px}
    input[type=file]{color:var(--muted)}
    .kbd{opacity:.72; font-size:12px}
    .badge{font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid var(--stroke); background:rgba(0,0,0,.22)}
    .spacer{flex:1}
    .camWrap{display:none; margin-top:10px}
    .camWrap.active{display:block}
    #camVideo{width:100%; border-radius:18px; border:1px solid var(--stroke); background:#000}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand"><span class="dot"></span><span>CONSIA âˆž</span></div>
      <div class="pill"><span class="dot" id="onlineDot" style="background:#ff4d4d; box-shadow:0 0 14px rgba(255,77,77,.35)"></span>
        <small id="onlineTxt">OFFLINE</small>
        <span class="badge" id="rtTxt">realtime: auto</span>
        <button class="btn" id="testApiBtn">Test API</button>
      </div>
    </div>

    <div class="hero">
      <div class="avatar" id="avatarBox">
        <video id="avatarVideo" autoplay muted playsinline loop preload="auto">
          <source src="consia-entity.mp4" type="video/mp4">
        </video>
      </div>
      <div class="overlay"></div>

      <div class="hud">
        <div class="hud-left">
          <div class="hud-row">
            <span class="badge">API: <b id="apiHost">api.consia.world</b></span>
            <span class="badge" id="rtState">Realtime: â€”</span>
          </div>
          <div class="hint" id="voiceHint">Voz: listo. TocÃ¡ ðŸŽ™ Hablar (si el navegador soporta).</div>
        </div>
        <div class="hud-row">
          <button class="btn primary" id="btnGuide">Guiame (3 opciones)</button>
          <button class="btn" id="btnCan">Â¿QuÃ© puede hacer?</button>
          <button class="btn" id="btnHyper">Hiperrealismo</button>
          <button class="btn" id="btnVoice">Voz</button>
          <button class="btn" id="btnCam">CÃ¡mara</button>
          <button class="btn ok" id="btnAscend">âš¡ ASCEND</button>
        </div>
      </div>
    </div>

    <div class="panel">
      <div class="bar">
        <button class="btn" id="btnUpload">Subir archivo</button>
        <button class="btn" id="btnCamLive">CÃ¡mara (vivo 10%)</button>
        <button class="btn primary" id="btnTalk">ðŸŽ™ Hablar</button>
        <button class="btn" id="btnRead">Leer</button>
        <button class="btn" id="btnClear">Limpiar</button>
        <button class="btn warn" id="btnStopVoice">Stop voz</button>
        <span class="spacer"></span>
        <span class="kbd">Tip: escribÃ­ <b>Avatar:</b> para transformar entidad</span>
      </div>

      <div class="chat" id="chat"></div>

      <div class="row2">
        <div class="file">
          <input id="fileInput" type="file" multiple />
          <span class="badge" id="attCount">Adjuntos: 0</span>
        </div>
      </div>

      <div class="camWrap" id="camWrap">
        <video id="camVideo" autoplay playsinline muted></video>
      </div>

      <div class="inputRow">
        <textarea id="msg" placeholder='DecÃ­ lo que querÃ©s (o escribÃ­ ".")'></textarea>
        <button class="btn primary send" id="send">Enviar</button>
      </div>
    </div>
  </div>

<script>
(() => {
  const API = "https://api.consia.world";
  const chat = document.getElementById("chat");
  const msg = document.getElementById("msg");
  const send = document.getElementById("send");
  const fileInput = document.getElementById("fileInput");
  const attCount = document.getElementById("attCount");

  const avatarVideo = document.getElementById("avatarVideo");
  const onlineDot = document.getElementById("onlineDot");
  const onlineTxt = document.getElementById("onlineTxt");
  const rtState = document.getElementById("rtState");

  const camWrap = document.getElementById("camWrap");
  const camVideo = document.getElementById("camVideo");

  let attachments = [];
  let mediaStream = null;

  function add(role, text){
    const d = document.createElement("div");
    d.className = "msg " + (role==="SYS"?"sys":role==="YOU"?"you":"ai");
    d.textContent = text;
    chat.appendChild(d);
    chat.scrollTop = chat.scrollHeight;
  }

  function setOnline(ok){
    onlineDot.style.background = ok ? "#25ffb1" : "#ff4d4d";
    onlineDot.style.boxShadow = ok ? "0 0 14px rgba(37,255,177,.35)" : "0 0 14px rgba(255,77,77,.35)";
    onlineTxt.textContent = ok ? "ONLINE" : "OFFLINE";
  }

  async function apiJSON(path, body){
    const res = await fetch(API + path, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(body || {})
    });
    const data = await res.json().catch(()=>({ok:false,error:"bad_json"}));
    if(!res.ok) throw new Error(data?.error || ("HTTP "+res.status));
    return data;
  }

  async function refreshAvatar(){
    try{
      const r = await fetch(API + "/avatar/latest", { method:"GET" });
      const data = await r.json();
      if(data?.url){
        avatarVideo.pause();
        avatarVideo.querySelector("source").src = data.url;
        avatarVideo.load();
        await avatarVideo.play().catch(()=>{});
      }
    }catch(e){}
  }

  async function testAPI(){
    try{
      const r = await fetch(API + "/health", { method:"GET" });
      const data = await r.json();
      setOnline(!!data?.ok);
      add("SYS", JSON.stringify(data));
    }catch(e){
      setOnline(false);
      add("SYS", "API OFFLINE");
    }
  }

  function filesToBase64(files){
    const tasks = Array.from(files).map(f => new Promise((resolve)=>{
      const r = new FileReader();
      r.onload = () => resolve({ name:f.name, type:f.type||"application/octet-stream", data:String(r.result).split(",")[1] });
      r.readAsDataURL(f);
    }));
    return Promise.all(tasks);
  }

  async function startCamFront(){
    if(mediaStream) return;
    mediaStream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "user" }, audio:false
    });
    camVideo.srcObject = mediaStream;
    camWrap.classList.add("active");
  }

  function stopCam(){
    if(!mediaStream) return;
    mediaStream.getTracks().forEach(t=>t.stop());
    mediaStream = null;
    camWrap.classList.remove("active");
  }

  async function captureFrameBase64(){
    if(!camVideo.videoWidth) return null;
    const c = document.createElement("canvas");
    c.width = camVideo.videoWidth; c.height = camVideo.videoHeight;
    const ctx = c.getContext("2d");
    ctx.drawImage(camVideo,0,0,c.width,c.height);
    const dataUrl = c.toDataURL("image/jpeg", 0.82);
    return dataUrl.split(",")[1];
  }

  async function sendMessage(text){
    const t = (text||"").trim();
    if(!t) return;

    // AVATAR TRANSFORM (infinito): "Avatar: ..."
    if(/^avatar\s*:/i.test(t)){
      add("YOU", t);
      const instruction = t.replace(/^avatar\s*:/i,"").trim();
      const out = await apiJSON("/avatar/transform", { instruction });
      add("AI", out?.reply || "OK");
      await refreshAvatar();
      msg.value="";
      return;
    }

    // CÃMARA 10%: "Cam:" o botÃ³n
    const useCam = /^cam\s*:/i.test(t);

    add("YOU", t);
    const payload = { message: t, attachments };

    if(useCam){
      await startCamFront().catch(()=>{});
      const frame = await captureFrameBase64();
      if(frame) payload.camera_frame_b64 = frame;
    }

    const out = await apiJSON("/ask", payload);
    add("AI", out?.reply ? out.reply : JSON.stringify(out));
    msg.value="";
    attachments = [];
    attCount.textContent = "Adjuntos: 0";
    fileInput.value = "";
  }

  // Buttons
  document.getElementById("testApiBtn").onclick = testAPI;

  document.getElementById("btnGuide").onclick = () =>
    sendMessage("Guiame: dame 3 opciones y pedime lo mÃ­nimo en 1 sola pregunta. Luego esperÃ¡ mi 1 frase y ejecutÃ¡.");

  document.getElementById("btnCan").onclick = () =>
    sendMessage("Â¿QuÃ© puede hacer CONSIA hoy? ListÃ¡ funciones reales disponibles (texto/voz/realtime/archivos/cÃ¡mara) y pedime lo mÃ­nimo.");

  document.getElementById("btnHyper").onclick = () =>
    sendMessage("Hiperrealismo: dame 3 opciones (Imagen/Video/Avatar). Pedime lo mÃ­nimo en 1 sola pregunta. Luego esperÃ¡ mi 1 frase y ejecutÃ¡.");

  document.getElementById("btnVoice").onclick = () =>
    sendMessage("Voz: modo ultra. Preguntas cortas. Confirmaciones sÃ­/no.");

  document.getElementById("btnCam").onclick = async () => {
    await startCamFront().catch(()=>add("SYS","CÃ¡mara no disponible"));
    add("SYS","CÃ¡mara frontal activa.");
  };

  document.getElementById("btnAscend").onclick = () =>
    sendMessage("ASCEND: modo ultra. Respuestas cortas, plan inmediato y checklist.");

  document.getElementById("btnUpload").onclick = () => fileInput.click();
  document.getElementById("btnCamLive").onclick = async () => { await startCamFront().catch(()=>{}); };
  document.getElementById("btnTalk").onclick = () => sendMessage("Voz: activÃ¡ escucha y respondÃ©. (Si no hay soporte, contestÃ¡ por texto).");
  document.getElementById("btnRead").onclick = () => sendMessage("LeÃ© el historial y resumÃ­ en 7 bullets + acciones.");
  document.getElementById("btnClear").onclick = () => { chat.innerHTML=""; add("SYS","CONSIA UI listo."); };
  document.getElementById("btnStopVoice").onclick = () => sendMessage("Stop voz.");

  fileInput.addEventListener("change", async (e)=>{
    const files = e.target.files;
    if(!files || !files.length) return;
    attachments = await filesToBase64(files);
    attCount.textContent = "Adjuntos: " + attachments.length;
    add("SYS", "Adjuntos listos: " + attachments.map(a=>a.name).join(", "));
  });

  send.onclick = () => sendMessage(msg.value);
  msg.addEventListener("keydown", (e)=>{
    if(e.key==="Enter" && !e.shiftKey){
      e.preventDefault();
      sendMessage(msg.value);
    }
  });

  // boot
  add("SYS", "CONSIA UI HOTFIX activo. Input siempre visible. Idioma ES.");
  testAPI();
  refreshAvatar();
  rtState.textContent = "Realtime: auto";
})();
</script>
</body>
</html>
