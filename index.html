<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#000000" />
  <title>CONSIA</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.webmanifest" />
  <link rel="apple-touch-icon" href="./icon-192.png" />

  <style>
    :root{
      --bg:#000;
      --glass: rgba(20,20,20,.40);
      --glass2: rgba(10,10,10,.55);
      --line: rgba(255,255,255,.10);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.65);
      --accent: rgba(160, 220, 255, .95);
      --shadow: rgba(0,0,0,.6);
    }
    *{box-sizing:border-box}
    html,body{height:100%; margin:0; background:var(--bg); color:var(--text); font-family: -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial;}
    body{overflow:hidden}

    /* Fullscreen stage */
    .stage{position:fixed; inset:0; background:#000;}
    video, img{display:block}

    /* Background video (teleport scene) */
    #bgVideo{
      position:absolute; inset:0;
      width:100%; height:100%;
      object-fit:cover;
      filter: contrast(1.05) saturate(1.08);
      background:#000;
    }

    /* Avatar video (center, responsive) */
    #avatarVideo{
      position:absolute; inset:0;
      width:100%; height:100%;
      object-fit:contain;       /* NO corta: se adapta al dispositivo */
      pointer-events:none;
      background:transparent;
      filter: drop-shadow(0 18px 60px var(--shadow));
    }

    /* Loader */
    .loader{
      position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
      background:#000;
      transition: opacity .45s ease;
      z-index:50;
    }
    .loader.hidden{opacity:0; pointer-events:none}
    .logo{
      letter-spacing:.55em; text-indent:.55em;
      font-weight:300; font-size:18px;
      color:rgba(255,255,255,.86);
    }

    /* HUD */
    .hud{
      position:absolute; inset:0;
      display:flex; flex-direction:column;
      padding: env(safe-area-inset-top) 14px env(safe-area-inset-bottom) 14px;
      z-index:30;
      pointer-events:none;
    }

    /* Top mini status */
    .topbar{
      pointer-events:none;
      display:flex; gap:10px; align-items:center; justify-content:flex-end;
      padding-top: 8px;
      min-height:36px;
    }
    .pill{
      pointer-events:auto;
      background: rgba(0,0,0,.35);
      border:1px solid var(--line);
      backdrop-filter: blur(10px);
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      color:var(--muted);
      display:flex; gap:8px; align-items:center;
    }
    .dot{width:8px; height:8px; border-radius:50%; background: rgba(0,255,180,.75); box-shadow:0 0 12px rgba(0,255,180,.65)}
    .dot.busy{background: rgba(255,210,90,.85); box-shadow:0 0 12px rgba(255,210,90,.65)}
    .dot.err{background: rgba(255,90,90,.85); box-shadow:0 0 12px rgba(255,90,90,.65)}

    /* Chat panel */
    .panel{
      pointer-events:auto;
      margin-top:auto;
      align-self:flex-end;
      width:min(520px, 100%);
      background: linear-gradient(180deg, var(--glass), var(--glass2));
      border:1px solid var(--line);
      border-radius:18px;
      overflow:hidden;
      backdrop-filter: blur(14px);
      box-shadow: 0 20px 60px rgba(0,0,0,.45);
    }
    .panelHeader{
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 12px;
      border-bottom:1px solid var(--line);
      font-size:13px;
      color:var(--muted);
    }
    .panelHeader b{color:var(--text); font-weight:600}
    .actions{display:flex; gap:8px}
    .btn{
      appearance:none; border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      color:var(--text);
      padding:8px 10px;
      border-radius:12px;
      font-size:13px;
      cursor:pointer;
      transition: transform .06s ease, background .2s ease, border .2s ease;
    }
    .btn:active{transform: scale(.98)}
    .btn.primary{
      border-color: rgba(160,220,255,.35);
      background: rgba(160,220,255,.12);
    }

    .log{
      height:min(34vh, 260px);
      overflow:auto;
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .msg{
      max-width:100%;
      display:flex; flex-direction:column; gap:4px;
      font-size:14px;
      line-height:1.35;
    }
    .tag{
      font-size:11px; color:var(--muted);
      letter-spacing:.03em;
    }
    .bubble{
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      white-space:pre-wrap;
    }
    .bubble.me{
      background: rgba(160,220,255,.10);
      border-color: rgba(160,220,255,.20);
    }

    .composer{
      border-top:1px solid var(--line);
      padding:10px;
      display:flex; gap:10px; align-items:center;
    }
    .input{
      flex:1;
      background: rgba(0,0,0,.20);
      border:1px solid var(--line);
      color:var(--text);
      border-radius:14px;
      padding:12px 12px;
      font-size:14px;
      outline:none;
    }
    .iconBtn{
      width:44px; height:44px;
      display:grid; place-items:center;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      cursor:pointer;
      user-select:none;
    }
    .iconBtn.primary{
      border-color: rgba(160,220,255,.35);
      background: rgba(160,220,255,.12);
    }

    /* Bottom quick controls */
    .quick{
      pointer-events:auto;
      display:flex; gap:10px; align-items:center; justify-content:center;
      margin-top:10px;
      padding-bottom: 6px;
    }

    /* iOS autoplay guard overlay */
    .tapToStart{
      position:absolute; inset:0;
      display:flex; flex-direction:column; gap:12px;
      align-items:center; justify-content:center;
      background: radial-gradient(1200px 800px at 50% 60%, rgba(30,40,70,.35), rgba(0,0,0,.92));
      z-index:60;
      transition: opacity .3s ease;
    }
    .tapToStart.hidden{opacity:0; pointer-events:none}
    .tapTitle{letter-spacing:.6em; text-indent:.6em; font-weight:300; font-size:16px; color:rgba(255,255,255,.86)}
    .tapHint{font-size:13px; color:rgba(255,255,255,.70)}
  </style>
</head>

<body>
  <div class="stage">
    <!-- Scene background -->
    <video id="bgVideo" playsinline muted loop preload="auto"></video>

    <!-- Avatar -->
    <video id="avatarVideo" playsinline muted loop preload="auto"></video>

    <!-- Loader -->
    <div id="loader" class="loader">
      <div class="logo">CONSIA</div>
    </div>

    <!-- Tap-to-start (necesario en iOS para autoplay con audio/voz) -->
    <div id="tapToStart" class="tapToStart">
      <div class="tapTitle">CONSIA</div>
      <button id="startBtn" class="btn primary" style="padding:12px 16px;border-radius:16px;font-size:14px">
        Activar (1 toque)
      </button>
      <div class="tapHint">Habilita video + voz + micr√≥fono.</div>
    </div>

    <!-- HUD -->
    <div class="hud">
      <div class="topbar">
        <div class="pill"><span id="statusDot" class="dot"></span><span id="statusTxt">LISTO</span></div>
      </div>

      <div class="panel" id="panel">
        <div class="panelHeader">
          <div><b>CONSIA</b> ¬∑ voz natural ¬∑ multi-idioma</div>
          <div class="actions">
            <button class="btn" id="sceneBtn">Teleport</button>
            <button class="btn" id="resetBtn">Reset</button>
          </div>
        </div>

        <div class="log" id="log"></div>

        <div class="composer">
          <input id="textIn" class="input" placeholder="Escrib√≠‚Ä¶" autocomplete="off" />
          <div class="iconBtn" id="micBtn" title="Hablar">üéôÔ∏è</div>
          <div class="iconBtn primary" id="sendBtn" title="Enviar">‚û§</div>
        </div>
      </div>

      <div class="quick">
        <button class="btn" id="audioToggle">Audio: ON</button>
        <button class="btn" id="voiceToggle">Voz: ON</button>
      </div>
    </div>
  </div>

  <script>
    // ========= CONFIG =========
    const API_BASE = "https://api.consia.world"; // tu dominio ya ruteado al worker
    const ENDPOINT_ASK = API_BASE + "/ask";
    const ENDPOINT_SCENE = API_BASE + "/scene";
    const ENDPOINT_HEALTH = API_BASE + "/health";

    // Assets (ponelos en el mismo folder)
    const DEFAULT_BG = "./bg.mp4";         // video fondo (loop)
    const DEFAULT_AVATAR = "./avatar.mp4"; // video avatar (loop)

    // ========= STATE =========
    const el = (id) => document.getElementById(id);
    const bgVideo = el("bgVideo");
    const avatarVideo = el("avatarVideo");
    const loader = el("loader");
    const tapToStart = el("tapToStart");
    const startBtn = el("startBtn");
    const log = el("log");
    const textIn = el("textIn");
    const sendBtn = el("sendBtn");
    const micBtn = el("micBtn");
    const sceneBtn = el("sceneBtn");
    const resetBtn = el("resetBtn");
    const statusDot = el("statusDot");
    const statusTxt = el("statusTxt");
    const audioToggle = el("audioToggle");
    const voiceToggle = el("voiceToggle");

    let audioOn = true;
    let voiceOn = true;
    let busy = false;

    // session id estable
    const sessionId = localStorage.getItem("consia_session") || ("s_" + cryptoRandom(20));
    localStorage.setItem("consia_session", sessionId);

    // Web Speech Recognition (si est√° disponible)
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let rec = null;
    let listening = false;

    // ========= HELPERS =========
    function cryptoRandom(n){
      const a = new Uint8Array(n);
      crypto.getRandomValues(a);
      return [...a].map(b => b.toString(16).padStart(2,"0")).join("").slice(0,n);
    }
    function setStatus(mode, text){
      statusTxt.textContent = text || "";
      statusDot.classList.remove("busy","err");
      if (mode === "busy") statusDot.classList.add("busy");
      if (mode === "err") statusDot.classList.add("err");
    }
    function addMsg(who, text){
      const wrap = document.createElement("div");
      wrap.className = "msg";
      const tag = document.createElement("div");
      tag.className = "tag";
      tag.textContent = who;
      const bubble = document.createElement("div");
      bubble.className = "bubble" + (who === "Usuario" ? " me" : "");
      bubble.textContent = text;
      wrap.appendChild(tag);
      wrap.appendChild(bubble);
      log.appendChild(wrap);
      log.scrollTop = log.scrollHeight;
    }

    function b64ToBlob(b64, mime){
      const bytes = Uint8Array.from(atob(b64), c => c.charCodeAt(0));
      return new Blob([bytes], { type: mime });
    }

    async function playAudioFromB64(audio_b64, mime){
      if (!audioOn || !audio_b64) return;
      const blob = b64ToBlob(audio_b64, mime || "audio/mpeg");
      const url = URL.createObjectURL(blob);
      const a = new Audio(url);
      a.preload = "auto";
      a.onended = () => URL.revokeObjectURL(url);
      await a.play().catch(()=>{});
    }

    function userLang(){
      // idioma del navegador (auto)
      return (navigator.language || "es").slice(0,2);
    }

    // ========= INIT MEDIA =========
    async function loadVideo(v, src){
      v.src = src;
      v.load();
      // intentar autoplay (iOS necesita gesto; por eso tapToStart)
      try { await v.play(); } catch(e) {}
    }

    async function boot(){
      // carga visual primero
      await loadVideo(bgVideo, DEFAULT_BG);
      await loadVideo(avatarVideo, DEFAULT_AVATAR);

      // fade loader
      setTimeout(()=> loader.classList.add("hidden"), 350);
    }

    // ========= TELEPORT =========
    async function teleport(prompt){
      setStatus("busy","TELEPORT‚Ä¶");
      const r = await fetch(ENDPOINT_SCENE, {
        method:"POST",
        headers:{
          "Content-Type":"application/json",
          "x-consia-session": sessionId
        },
        body: JSON.stringify({ prompt })
      }).catch(()=>null);
      const data = r ? await r.json().catch(()=>null) : null;
      const scene = data?.scene;

      const bg = scene?.bg?.src || DEFAULT_BG;
      const av = scene?.avatar?.src || DEFAULT_AVATAR;

      await loadVideo(bgVideo, bg);
      await loadVideo(avatarVideo, av);

      setStatus("", "LISTO");
    }

    // ========= ASK (chat/voz) =========
    async function ask(message){
      if (!message || busy) return;
      busy = true;
      setStatus("busy","PENSANDO‚Ä¶");
      addMsg("Usuario", message);

      const payload = {
        message,
        lang: "auto",
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone || "",
        proactive: true
      };

      const r = await fetch(ENDPOINT_ASK, {
        method:"POST",
        headers:{
          "Content-Type":"application/json",
          "x-consia-session": sessionId
        },
        body: JSON.stringify(payload)
      }).catch(()=>null);

      if (!r || !r.ok){
        busy = false;
        setStatus("err","ERROR");
        addMsg("CONSIA", "No pude responder. Prob√° de nuevo.");
        return;
      }

      const data = await r.json().catch(()=> ({}));
      const text = data.text || "CONSIA activo. Te escucho.";
      addMsg("CONSIA", text);

      // voz natural
      if (voiceOn) await playAudioFromB64(data.audio_b64, data.audio_mime);

      busy = false;
      setStatus("", "LISTO");
    }

    // ========= MIC =========
    function setupMic(){
      if (!SpeechRecognition) return;

      rec = new SpeechRecognition();
      rec.continuous = false;
      rec.interimResults = false;
      rec.lang = navigator.language || "es-ES";

      rec.onstart = () => {
        listening = true;
        micBtn.style.borderColor = "rgba(160,220,255,.55)";
        micBtn.style.background = "rgba(160,220,255,.18)";
        setStatus("busy","ESCUCHANDO‚Ä¶");
      };
      rec.onend = () => {
        listening = false;
        micBtn.style.borderColor = "";
        micBtn.style.background = "";
        if (!busy) setStatus("", "LISTO");
      };
      rec.onerror = () => {
        listening = false;
        micBtn.style.borderColor = "";
        micBtn.style.background = "";
        if (!busy) setStatus("err","MIC");
      };
      rec.onresult = (ev) => {
        const t = ev?.results?.[0]?.[0]?.transcript || "";
        if (t.trim()) ask(t.trim());
      };
    }

    // ========= EVENTS =========
    sendBtn.onclick = () => {
      const v = textIn.value.trim();
      textIn.value = "";
      ask(v);
    };
    textIn.addEventListener("keydown", (e)=> {
      if (e.key === "Enter") sendBtn.click();
    });

    micBtn.onclick = async () => {
      if (!rec) return;
      if (listening) { try{ rec.stop(); }catch(e){} return; }
      try { rec.start(); } catch(e) {}
    };

    sceneBtn.onclick = () => {
      const p = prompt("Teleport (ej: cosmos, playa, oficina, noche):", "cosmos");
      if (p) teleport(p);
    };

    resetBtn.onclick = async () => {
      localStorage.removeItem("consia_session");
      location.reload();
    };

    audioToggle.onclick = () => {
      audioOn = !audioOn;
      audioToggle.textContent = "Audio: " + (audioOn ? "ON" : "OFF");
    };
    voiceToggle.onclick = () => {
      voiceOn = !voiceOn;
      voiceToggle.textContent = "Voz: " + (voiceOn ? "ON" : "OFF");
    };

    // ========= START (1 toque) =========
    startBtn.onclick = async () => {
      tapToStart.classList.add("hidden");

      // habilita autoplay correcto en iOS: reproducir videos tras gesto
      bgVideo.muted = true;
      avatarVideo.muted = true;
      try { await bgVideo.play(); } catch(e){}
      try { await avatarVideo.play(); } catch(e){}

      // salud API
      fetch(ENDPOINT_HEALTH).catch(()=>{});

      addMsg("CONSIA", "Listo. Pod√©s hablar (üéôÔ∏è) o escribir en el chat.");
      setStatus("", "LISTO");
    };

    // ========= PWA SW =========
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("./sw.js").catch(()=>{});
      });
    }

    // ========= BOOT =========
    (async ()=>{
      await boot();
      setupMic();
      // si el navegador permite autoplay silencioso, se ve sin tocar,
      // pero el audio/voz siempre requiere el bot√≥n en iOS.
      setStatus("", "LISTO");
    })();
  </script>
</body>
</html>
