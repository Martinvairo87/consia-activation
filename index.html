<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#05070b" />
  <title>CONSIA ‚àû</title>
  <style>
    :root{
      --bg:#05070b;
      --panel:#0b1018;
      --panel2:#0f1622;
      --text:#e8eef8;
      --muted:#9aa6b2;
      --line:rgba(255,255,255,.10);
      --ok:#19d37d;
      --warn:#ffcc00;
      --bad:#ff4d4d;
      --pill:#0c1a2a;
      --btn:#0e223a;
      --btn2:#123055;
      --shadow:0 18px 60px rgba(0,0,0,.55);
      --radius:18px;
      --mono:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      --sans:-apple-system,BlinkMacSystemFont,"SF Pro Display","SF Pro Text",system-ui,Segoe UI,Roboto,Helvetica,Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      background:radial-gradient(1200px 600px at 15% 10%, rgba(36,88,255,.08), transparent 55%),
                 radial-gradient(900px 500px at 90% 0%, rgba(25,211,125,.06), transparent 55%),
                 var(--bg);
      color:var(--text);
      overflow-x:hidden;
    }

    /* Top bar */
    .topbar{
      position:sticky; top:0; z-index:30;
      padding:14px 14px 10px;
      backdrop-filter: blur(10px);
      background: linear-gradient(to bottom, rgba(5,7,11,.92), rgba(5,7,11,.55));
      border-bottom:1px solid var(--line);
    }
    .toprow{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      max-width:1100px; margin:0 auto;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:700; letter-spacing:.4px;
    }
    .dot{width:9px;height:9px;border-radius:999px;background:var(--ok);box-shadow:0 0 16px rgba(25,211,125,.6)}
    .badge{
      display:flex; align-items:center; gap:8px;
      font-size:12px; color:var(--muted);
      border:1px solid var(--line);
      background:rgba(11,16,24,.6);
      padding:8px 10px; border-radius:999px;
      white-space:nowrap;
    }
    .toggle{
      display:flex; align-items:center; gap:8px;
    }
    .pill{
      border:1px solid var(--line);
      background:rgba(11,16,24,.55);
      padding:8px 12px;
      border-radius:999px;
      color:var(--text);
      font-size:12px;
      cursor:pointer;
      user-select:none;
    }
    .pill:hover{background:rgba(15,22,34,.75)}
    .pill:active{transform:translateY(1px)}
    .pill[disabled]{opacity:.5; cursor:not-allowed}

    /* Layout */
    .wrap{
      max-width:1100px;
      margin:0 auto;
      padding:14px;
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:14px;
    }
    @media (max-width: 980px){
      .wrap{grid-template-columns:1fr}
    }

    /* Avatar hero */
    .hero{
      position:relative;
      border:1px solid var(--line);
      border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(11,16,24,.72), rgba(11,16,24,.35));
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .heroHeader{
      padding:12px 12px 0;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .heroTitle{
      display:flex; flex-direction:column; gap:4px;
    }
    .heroTitle b{font-size:14px}
    .heroTitle span{font-size:12px;color:var(--muted)}
    .heroBody{
      position:relative;
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      padding:12px;
    }
    .avatarStage{
      position:relative;
      border:1px solid rgba(255,255,255,.08);
      background:radial-gradient(900px 500px at 20% 20%, rgba(36,88,255,.10), transparent 60%),
                 radial-gradient(700px 420px at 75% 10%, rgba(25,211,125,.06), transparent 55%),
                 rgba(0,0,0,.35);
      border-radius:16px;
      overflow:hidden;
      min-height:260px;
    }
    .avatarVideo{
      position:absolute; inset:0;
      width:100%; height:100%;
      object-fit:cover;
      filter:contrast(1.03) saturate(1.05);
    }
    .avatarOverlay{
      position:absolute; inset:0;
      background:linear-gradient(to top, rgba(0,0,0,.62), rgba(0,0,0,.10) 55%, rgba(0,0,0,.30));
      pointer-events:none;
    }
    .avatarHUD{
      position:absolute; left:12px; right:12px; bottom:12px;
      display:flex; align-items:flex-end; justify-content:space-between; gap:10px;
      pointer-events:none;
    }
    .hudLeft{
      display:flex; flex-direction:column; gap:6px;
      pointer-events:none;
    }
    .statusLine{
      display:flex; align-items:center; gap:8px;
      font-size:12px; color:rgba(232,238,248,.95);
      pointer-events:none;
    }
    .liveDot{
      width:8px; height:8px; border-radius:99px;
      background:var(--ok);
      box-shadow:0 0 14px rgba(25,211,125,.65);
    }
    .kbdHint{
      font-size:12px;
      color:rgba(232,238,248,.85);
      padding:8px 10px;
      border:1px solid rgba(255,255,255,.10);
      border-radius:12px;
      background:rgba(11,16,24,.45);
      pointer-events:none;
    }
    .kbdHint span{color:var(--muted)}

    /* Right panel (controls) */
    .panel{
      border:1px solid var(--line);
      border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(11,16,24,.72), rgba(11,16,24,.35));
      box-shadow:var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:520px;
    }
    .panelHeader{
      padding:12px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid var(--line);
    }
    .panelHeader .title{
      display:flex; flex-direction:column; gap:4px;
    }
    .panelHeader .title b{font-size:13px}
    .panelHeader .title span{font-size:12px;color:var(--muted)}
    .chips{
      padding:10px 12px 0;
      display:flex; flex-wrap:wrap; gap:8px;
    }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(12,26,42,.55);
      color:var(--text);
      font-size:12px;
      cursor:pointer;
      user-select:none;
    }
    .chip:hover{background:rgba(18,48,85,.65)}
    .chip:active{transform:translateY(1px)}

    .log{
      flex:1;
      padding:12px;
      overflow:auto;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .msg{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(11,16,24,.55);
      border-radius:16px;
      padding:10px 12px;
      white-space:pre-wrap;
      word-break:break-word;
    }
    .msg .tag{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-family:var(--mono);
      font-size:11px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      margin-right:8px;
      color:rgba(232,238,248,.9);
      background:rgba(0,0,0,.25);
    }
    .msg.sys{border-color:rgba(255,255,255,.08); background:rgba(11,16,24,.45); color:rgba(232,238,248,.92)}
    .msg.you{background:rgba(18,48,85,.30); border-color:rgba(36,88,255,.22)}
    .msg.ai{background:rgba(25,211,125,.08); border-color:rgba(25,211,125,.18)}
    .msg.err{background:rgba(255,77,77,.08); border-color:rgba(255,77,77,.20)}

    /* Composer */
    .composer{
      border-top:1px solid var(--line);
      padding:12px;
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:end;
      background:rgba(5,7,11,.35);
    }
    .inputWrap{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(11,16,24,.55);
      border-radius:16px;
      padding:10px 10px 8px;
    }
    textarea{
      width:100%;
      min-height:44px;
      max-height:180px;
      resize:none;
      border:0;
      outline:none;
      background:transparent;
      color:var(--text);
      font-size:14px;
      font-family:var(--sans);
    }
    .row2{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding-top:6px;
    }
    .meta{
      display:flex;
      align-items:center;
      gap:10px;
      font-size:12px;
      color:var(--muted);
    }
    .smallBtn{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(12,26,42,.55);
      color:var(--text);
      padding:8px 10px;
      border-radius:12px;
      cursor:pointer;
      font-size:12px;
      user-select:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .smallBtn:hover{background:rgba(18,48,85,.65)}
    .smallBtn:active{transform:translateY(1px)}
    .smallBtn[disabled]{opacity:.5; cursor:not-allowed}
    .send{
      border:1px solid rgba(255,255,255,.12);
      background:linear-gradient(180deg, rgba(18,48,85,.95), rgba(14,34,58,.92));
      padding:14px 16px;
      border-radius:16px;
      color:var(--text);
      cursor:pointer;
      font-weight:700;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
      user-select:none;
      min-width:128px;
      text-align:center;
    }
    .send:hover{filter:brightness(1.05)}
    .send:active{transform:translateY(1px)}
    .subnote{font-size:12px;color:var(--muted);padding:0 12px 12px}

    /* Upload / Camera */
    .tools{
      display:flex; flex-wrap:wrap; gap:8px;
      padding:10px 12px 0;
    }
    input[type="file"]{display:none}
    .kbd{
      font-family:var(--mono);
      font-size:11px;
      padding:2px 7px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.25);
      color:rgba(232,238,248,.9);
    }

    /* Camera modal */
    .modal{
      position:fixed; inset:0; z-index:100;
      background:rgba(0,0,0,.65);
      display:none;
      align-items:center;
      justify-content:center;
      padding:14px;
    }
    .modal.on{display:flex}
    .modalCard{
      width:min(980px, 100%);
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background:linear-gradient(180deg, rgba(11,16,24,.92), rgba(11,16,24,.70));
      box-shadow:0 30px 120px rgba(0,0,0,.7);
      overflow:hidden;
    }
    .modalTop{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:12px 12px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .modalTop b{font-size:13px}
    .modalBody{padding:12px; display:grid; grid-template-columns: 1fr; gap:10px}
    .camStage{
      border-radius:16px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.35);
      position:relative;
      min-height:280px;
    }
    .camStage video{width:100%; height:100%; object-fit:cover; display:block}
    .camBar{
      display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:space-between;
    }
    .camBar .left, .camBar .right{display:flex; gap:8px; flex-wrap:wrap}
  </style>
</head>

<body>
  <div class="topbar">
    <div class="toprow">
      <div class="brand">
        <span class="dot" aria-hidden="true"></span>
        <span>CONSIA <span style="opacity:.7">‚àû</span></span>
      </div>

      <div class="toggle">
        <div class="badge" title="Estado del sistema">
          <span id="onlineDot" class="dot" style="width:8px;height:8px;opacity:.8"></span>
          <span id="onlineText">ONLINE</span>
          <span style="opacity:.5">¬∑</span>
          <span id="realtimeText">AUTO</span>
        </div>
        <div class="pill" id="btnTest">Test API</div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <!-- LEFT: Avatar from start -->
    <section class="hero" aria-label="Avatar">
      <div class="heroHeader">
        <div class="heroTitle">
          <b>Avatar / Inicio</b>
          <span>Voz ¬∑ Click ¬∑ Teclado ¬∑ Archivos ¬∑ C√°mara</span>
        </div>
        <div class="badge" style="gap:10px">
          <span class="kbd">Enter</span><span>enviar</span>
          <span style="opacity:.45">|</span>
          <span class="kbd">Shift</span><span>+</span><span class="kbd">Enter</span><span>salto</span>
        </div>
      </div>

      <div class="heroBody">
        <div class="avatarStage">
          <!-- PON√â TU ARCHIVO: /avatar.mp4 (en tu repo Pages) -->
          <video id="avatar" class="avatarVideo" autoplay muted loop playsinline preload="auto">
            <source src="./avatar.mp4" type="video/mp4" />
          </video>
          <div class="avatarOverlay"></div>

          <div class="avatarHUD">
            <div class="hudLeft">
              <div class="statusLine"><span class="liveDot"></span><span id="hudStatus">Realtime: conectando‚Ä¶</span></div>
              <div class="statusLine" style="opacity:.85"><span style="opacity:.75">API:</span> <span id="hudApi">api.consia.world</span></div>
            </div>
            <div class="kbdHint">
              Dec√≠ <b>‚ÄúHola CONSIA‚Äù</b> por voz o escrib√≠ abajo. <span>(si tu navegador soporta voz)</span>
            </div>
          </div>
        </div>

        <div class="tools">
          <label class="smallBtn" for="filePicker">üìé Subir archivo</label>
          <input id="filePicker" type="file" multiple
                 accept="image/*,video/*,audio/*,.pdf,.txt,.md,.doc,.docx,.xls,.xlsx,.ppt,.pptx,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-powerpoint,application/vnd.openxmlformats-officedocument.presentationml.presentation" />
          <div class="smallBtn" id="btnCamera">üì∑ C√°mara (vivo 10%)</div>
          <div class="smallBtn" id="btnMic">üéôÔ∏è Voz (hablar)</div>
          <div class="smallBtn" id="btnSpeak" title="Leer en voz alta la √∫ltima respuesta">üîä Voz (leer)</div>
        </div>

        <div class="subnote" id="voiceNote">Voz: preparando‚Ä¶</div>
      </div>
    </section>

    <!-- RIGHT: Chat + actions -->
    <section class="panel" aria-label="CONSIA Console">
      <div class="panelHeader">
        <div class="title">
          <b>CONSIA Console</b>
          <span>Click / Voz / Teclado + ejecuci√≥n</span>
        </div>
        <div class="badge"><span id="apiLabel">api.consia.world</span></div>
      </div>

      <div class="chips">
        <div class="chip" data-prompt="Guiame: dame 3 opciones y pedime lo m√≠nimo en 1 sola pregunta. Luego esper√° mi 1 frase y ejecut√°.">üß≠ Guiame (3)</div>
        <div class="chip" data-prompt="¬øQu√© puede hacer CONSIA hoy? List√° funciones reales disponibles (texto/voz/realtime/archivos/c√°mara) y pedime lo m√≠nimo.">üß† ¬øQu√© puede hacer?</div>
        <div class="chip" data-prompt="Hiperrealismo: dame 3 opciones (Imagen/Video/Avatar). Pedime lo m√≠nimo en 1 sola pregunta. Luego esper√° mi 1 frase y ejecut√°.">üñºÔ∏è Hiperrealismo</div>
        <div class="chip" data-prompt="Voz: activ√° modo asistente por voz. Hac√© preguntas cortas y confirmaciones s√≠/no.">üéôÔ∏è Voz</div>
        <div class="chip" data-prompt="FaceTime/C√°mara: pedime permiso y luego indicame 1 acci√≥n de an√°lisis en vivo (10%) y 1 salida esperada.">üì∑ C√°mara</div>
        <div class="chip" data-prompt="ASCEND: modo ultra. Respuestas cortas, plan de acci√≥n inmediato y checklist.">‚ö° ASCEND</div>
      </div>

      <div class="log" id="log"></div>

      <div class="composer">
        <div class="inputWrap">
          <textarea id="input" placeholder="Dec√≠ lo que quer√©s (o escrib√≠ '.')"></textarea>
          <div class="row2">
            <div class="meta">
              <span>Idioma: <b>ES</b></span>
              <span style="opacity:.45">¬∑</span>
              <span>Realtime: <b id="rtMode">auto</b></span>
            </div>
            <div style="display:flex; gap:8px; flex-wrap:wrap">
              <div class="smallBtn" id="btnClear">üßπ Limpiar</div>
              <div class="smallBtn" id="btnStopTTS">‚èπÔ∏è Stop voz</div>
            </div>
          </div>
        </div>
        <div class="send" id="send">Enviar</div>
      </div>
      <div class="subnote">Si no hay IA, igual responde (fallback) y deja logs. Archivos/c√°mara se env√≠an como ‚Äúcontexto‚Äù.</div>
    </section>
  </div>

  <!-- CAMERA MODAL -->
  <div class="modal" id="camModal" aria-hidden="true">
    <div class="modalCard">
      <div class="modalTop">
        <b>C√°mara en vivo (10% an√°lisis)</b>
        <div style="display:flex; gap:8px; flex-wrap:wrap">
          <div class="smallBtn" id="btnCamClose">‚úñ Cerrar</div>
        </div>
      </div>
      <div class="modalBody">
        <div class="camStage">
          <video id="camVideo" autoplay playsinline muted></video>
        </div>
        <div class="camBar">
          <div class="left">
            <div class="smallBtn" id="btnCamStart">‚ñ∂Ô∏è Iniciar c√°mara</div>
            <div class="smallBtn" id="btnCamStop" disabled>‚èπÔ∏è Detener</div>
            <div class="smallBtn" id="btnSnap" disabled>üì∏ Capturar 1 frame</div>
          </div>
          <div class="right">
            <div class="smallBtn" id="btnStream10" disabled>üß† Enviar 10% (frame)</div>
          </div>
        </div>
        <div class="subnote" id="camNote">Pedir√° permiso. Captura 1 frame y lo env√≠a para an√°lisis.</div>
      </div>
    </div>
  </div>

  <script>
    /**********************
     * CONFIG (edit if needed)
     **********************/
    const API_BASE = "https://api.consia.world";
    const ASK_URL  = API_BASE + "/ask";          // tu endpoint de chat
    const REALTIME_URL = API_BASE.replace("https://","wss://") + "/realtime"; // opcional
    const AVATAR_SRC = "./avatar.mp4";           // en tu Pages repo

    /**********************
     * UI helpers
     **********************/
    const $ = (id)=>document.getElementById(id);
    const logEl = $("log");
    const inputEl = $("input");
    const onlineText = $("onlineText");
    const realtimeText = $("realtimeText");
    const hudStatus = $("hudStatus");
    const voiceNote = $("voiceNote");

    function addMsg(kind, text){
      const div = document.createElement("div");
      div.className = "msg " + kind;
      const tag = document.createElement("span");
      tag.className = "tag";
      tag.textContent = kind.toUpperCase();
      const body = document.createElement("span");
      body.textContent = " " + (text ?? "");
      div.appendChild(tag);
      div.appendChild(body);
      logEl.appendChild(div);
      logEl.scrollTop = logEl.scrollHeight;
      return div;
    }

    function setOnline(ok){
      onlineText.textContent = ok ? "ONLINE" : "OFFLINE";
      $("onlineDot").style.background = ok ? "var(--ok)" : "var(--bad)";
      $("onlineDot").style.boxShadow = ok ? "0 0 16px rgba(25,211,125,.6)" : "0 0 16px rgba(255,77,77,.5)";
    }

    /**********************
     * Avatar init
     **********************/
    (function initAvatar(){
      const v = $("avatar");
      if(v){
        v.src = AVATAR_SRC;
        v.muted = true;
        v.playsInline = true;
        v.autoplay = true;
        v.loop = true;
        v.play().catch(()=>{ /* autoplay may be blocked until user gesture */ });
      }
      $("hudApi").textContent = API_BASE.replace("https://","");
      $("apiLabel").textContent = API_BASE.replace("https://","");
    })();

    /**********************
     * Realtime (optional)
     **********************/
    let ws = null;
    function connectRealtime(){
      try{
        hudStatus.textContent = "Realtime: conectando‚Ä¶";
        realtimeText.textContent = "AUTO";
        ws = new WebSocket(REALTIME_URL);
        ws.onopen = ()=>{
          hudStatus.textContent = "Realtime: conectado";
          addMsg("sys","Realtime conectado.");
        };
        ws.onmessage = (ev)=>{
          // si tu backend manda JSON, lo mostramos
          addMsg("sys", String(ev.data));
        };
        ws.onclose = ()=>{
          hudStatus.textContent = "Realtime: desconectado";
          addMsg("sys","Realtime desconectado.");
          ws = null;
        };
        ws.onerror = ()=>{
          hudStatus.textContent = "Realtime: error";
        };
      }catch(e){
        hudStatus.textContent = "Realtime: no disponible";
      }
    }
    connectRealtime();

    /**********************
     * Voice (SpeechRecognition + TTS)
     **********************/
    const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
    let rec = null;
    let listening = false;

    function initVoice(){
      if(!SpeechRec){
        voiceNote.textContent = "Voz: este navegador no soporta reconocimiento. Us√° escribir/click.";
        $("btnMic").setAttribute("disabled","disabled");
        return;
      }
      rec = new SpeechRec();
      rec.lang = "es-AR";
      rec.interimResults = true;
      rec.continuous = false;

      rec.onstart = ()=>{ listening = true; voiceNote.textContent = "Voz: escuchando‚Ä¶"; $("btnMic").textContent = "‚èπÔ∏è Voz (stop)"; };
      rec.onerror = (e)=>{ listening = false; voiceNote.textContent = "Voz: error ("+ (e?.error || "unknown") +")"; $("btnMic").textContent = "üéôÔ∏è Voz (hablar)"; };
      rec.onend = ()=>{ listening = false; voiceNote.textContent = "Voz: listo."; $("btnMic").textContent = "üéôÔ∏è Voz (hablar)"; };

      rec.onresult = (evt)=>{
        let finalTxt = "";
        let interim = "";
        for(let i=evt.resultIndex;i<evt.results.length;i++){
          const t = evt.results[i][0].transcript;
          if(evt.results[i].isFinal) finalTxt += t;
          else interim += t;
        }
        const combined = (finalTxt || interim).trim();
        if(combined) inputEl.value = combined;
        autosize(inputEl);
        if(finalTxt){
          sendNow(finalTxt.trim(), {source:"voice"});
        }
      };

      voiceNote.textContent = "Voz: listo. Toc√° üéôÔ∏è para hablar.";
    }
    initVoice();

    function startStopVoice(){
      if(!rec) return;
      if(listening){ try{rec.stop()}catch(e){} return; }
      try{ rec.start(); }catch(e){}
    }

    let lastAIText = "";
    function speak(text){
      try{
        if(!("speechSynthesis" in window)) return;
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = "es-AR";
        u.rate = 1.02;
        u.pitch = 1.0;
        window.speechSynthesis.speak(u);
      }catch(e){}
    }

    /**********************
     * File upload (as context)
     **********************/
    async function fileToDataURL(file){
      return new Promise((resolve,reject)=>{
        const r = new FileReader();
        r.onload = ()=>resolve(String(r.result));
        r.onerror = reject;
        r.readAsDataURL(file);
      });
    }

    let pendingAttachments = []; // {name,type,size,dataUrl}
    $("filePicker").addEventListener("change", async (e)=>{
      const files = Array.from(e.target.files || []);
      if(!files.length) return;

      addMsg("sys", "Adjuntando " + files.length + " archivo(s)‚Ä¶");
      pendingAttachments = [];
      for(const f of files){
        const dataUrl = await fileToDataURL(f);
        pendingAttachments.push({ name:f.name, type:f.type || "application/octet-stream", size:f.size, dataUrl });
      }
      addMsg("sys", "Listo: " + files.map(x=>x.name).join(", "));
      e.target.value = "";
    });

    /**********************
     * Camera live (10% frame)
     **********************/
    const camModal = $("camModal");
    const camVideo = $("camVideo");
    let camStream = null;

    function openCam(){ camModal.classList.add("on"); camModal.setAttribute("aria-hidden","false"); }
    function closeCam(){
      camModal.classList.remove("on"); camModal.setAttribute("aria-hidden","true");
      stopCam();
    }

    async function startCam(){
      try{
        camStream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:"environment" }, audio:false });
        camVideo.srcObject = camStream;
        $("btnCamStop").disabled = false;
        $("btnSnap").disabled = false;
        $("btnStream10").disabled = false;
        $("btnCamStart").disabled = true;
        $("camNote").textContent = "C√°mara activa. Captur√° 1 frame y envi√° a CONSIA.";
      }catch(e){
        $("camNote").textContent = "No se pudo acceder a la c√°mara.";
      }
    }
    function stopCam(){
      if(camStream){
        camStream.getTracks().forEach(t=>t.stop());
        camStream = null;
      }
      camVideo.srcObject = null;
      $("btnCamStop").disabled = true;
      $("btnSnap").disabled = true;
      $("btnStream10").disabled = true;
      $("btnCamStart").disabled = false;
    }

    function captureFrameDataURL(){
      const v = camVideo;
      if(!v || !v.videoWidth) return null;
      const c = document.createElement("canvas");
      // ‚Äú10%‚Äù => bajamos resoluci√≥n fuerte (performance)
      const w = Math.max(320, Math.round(v.videoWidth * 0.10));
      const h = Math.round(w * (v.videoHeight / v.videoWidth));
      c.width = w; c.height = h;
      const ctx = c.getContext("2d", { alpha:false });
      ctx.drawImage(v, 0, 0, w, h);
      return c.toDataURL("image/jpeg", 0.72);
    }

    async function sendCam10(){
      const frame = captureFrameDataURL();
      if(!frame){ addMsg("err","No hay frame para enviar."); return; }
      // lo agregamos como attachment temporal + prompt corto
      const prompt = "An√°lisis en vivo (10%): describ√≠ lo que ves y segu√≠ mis instrucciones. Respuesta corta + 1 pregunta m√≠nima.";
      const attachments = [{ name:"live_frame.jpg", type:"image/jpeg", size: frame.length, dataUrl: frame }];
      await sendNow(prompt, { source:"camera", attachments });
    }

    /**********************
     * Chat send
     **********************/
    let busy = false;

    async function sendNow(text, opts={}){
      const msg = (text || "").trim();
      if(!msg || busy) return;
      busy = true;

      addMsg("you", msg);

      const attachments = (opts.attachments || []).concat(pendingAttachments || []);
      // limpiamos pendingAttachments al enviar
      pendingAttachments = [];

      // payload simple: el backend puede ignorar attachments si no los usa
      const payload = {
        message: msg,
        lang: "es",
        realtime: true,
        source: opts.source || "text",
        attachments: attachments.length ? attachments : undefined
      };

      try{
        const res = await fetch(ASK_URL, {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        });

        setOnline(res.ok);

        const ct = (res.headers.get("content-type") || "");
        let data;
        if(ct.includes("application/json")) data = await res.json();
        else data = { reply: await res.text() };

        const reply = (data && (data.reply || data.text || data.message)) ? (data.reply || data.text || data.message) : JSON.stringify(data, null, 2);
        lastAIText = String(reply || "");
        addMsg("ai", lastAIText);

      }catch(e){
        setOnline(false);
        addMsg("err", "Error llamando API. " + (e?.message || ""));
      }finally{
        busy = false;
      }
    }

    /**********************
     * Autosize textarea
     **********************/
    function autosize(el){
      el.style.height = "auto";
      el.style.height = Math.min(180, el.scrollHeight) + "px";
    }
    inputEl.addEventListener("input", ()=>autosize(inputEl));

    /**********************
     * Buttons / events
     **********************/
    $("send").onclick = ()=>sendNow(inputEl.value, {source:"text"});
    inputEl.addEventListener("keydown",(e)=>{
      if(e.key==="Enter" && !e.shiftKey){
        e.preventDefault();
        sendNow(inputEl.value, {source:"text"});
      }
    });

    document.querySelectorAll(".chip").forEach(ch=>{
      ch.addEventListener("click", ()=>{
        const p = ch.getAttribute("data-prompt") || "";
        inputEl.value = p;
        autosize(inputEl);
        sendNow(p, {source:"click"});
      });
    });

    $("btnClear").onclick = ()=>{
      logEl.innerHTML = "";
      addMsg("sys","CONSIA UI listo. Input siempre visible. Idioma ES.");
    };

    $("btnMic").onclick = ()=>startStopVoice();
    $("btnSpeak").onclick = ()=>{ if(lastAIText) speak(lastAIText); };
    $("btnStopTTS").onclick = ()=>{ try{window.speechSynthesis.cancel()}catch(e){} };

    $("btnTest").onclick = async ()=>{
      addMsg("sys","Testeando API‚Ä¶");
      try{
        const r = await fetch(API_BASE, { method:"GET" });
        setOnline(r.ok);
        addMsg("sys","API status: " + r.status);
      }catch(e){
        setOnline(false);
        addMsg("err","API test fall√≥.");
      }
    };

    $("btnCamera").onclick = ()=>openCam();
    $("btnCamClose").onclick = ()=>closeCam();
    $("btnCamStart").onclick = ()=>startCam();
    $("btnCamStop").onclick = ()=>stopCam();
    $("btnSnap").onclick = ()=>{
      const frame = captureFrameDataURL();
      if(!frame){ $("camNote").textContent = "No se pudo capturar frame."; return; }
      $("camNote").textContent = "Frame capturado (10%). Listo para enviar.";
      // lo dejamos listo como attachment pending (sin mandar todav√≠a)
      pendingAttachments = [{ name:"live_frame.jpg", type:"image/jpeg", size: frame.length, dataUrl: frame }];
      addMsg("sys","Frame capturado y adjuntado como live_frame.jpg");
    };
    $("btnStream10").onclick = ()=>sendCam10();

    // Boot messages
    addMsg("sys","CONSIA UI HOTFIX activo. Input siempre visible. Idioma ES.");
    addMsg("sys","Realtime conectando‚Ä¶ (si tu backend lo soporta)");

    // keep RT label
    $("rtMode").textContent = "auto";

    // if realtime fails quickly, show
    setTimeout(()=>{ if(!ws){ hudStatus.textContent = "Realtime: no disponible"; } }, 1800);
  </script>
</body>
</html>
