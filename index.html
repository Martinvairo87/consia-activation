<!-- =========================
     CONSIA ‚Äî index.html (COMPLETO)
     ‚úÖ Avatar centrado (no cortado)
     ‚úÖ Voz (SpeechRecognition + TTS)
     ‚úÖ Texto + Click
     ‚úÖ Subir archivos (fotos/videos/docs)
     ‚úÖ C√°mara FRONTAL + vivo 100% (frames ‚Üí /ask)
     ‚úÖ Owner-Only panel (token local) + endpoints /owner/seal y /avatar/transform
     ========================= -->
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>CONSIA ‚àû</title>
  <style>
    :root{
      --bg:#05070b;
      --panel:#0b1220cc;
      --panel2:#0b1220f2;
      --stroke:#1f2a44;
      --soft:#94a3b8;
      --text:#e6eefc;
      --ok:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --chip:#0f1b33;
      --chip2:#0d172c;
      --glow: 0 0 40px rgba(80,160,255,.18);
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:radial-gradient(1200px 600px at 50% -20%, #0b1630 0%, var(--bg) 55%, #03040a 100%);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:1100px;margin:0 auto;padding:14px 14px 26px}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:12px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700;letter-spacing:.6px}
    .dot{width:10px;height:10px;border-radius:50%;background:var(--ok);box-shadow:0 0 18px rgba(34,197,94,.55)}
    .badge{display:flex;align-items:center;gap:10px;background:rgba(8,12,22,.7);border:1px solid var(--stroke);padding:8px 10px;border-radius:999px}
    .pill{display:flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:rgba(10,18,34,.8);border:1px solid var(--stroke)}
    .pill small{color:var(--soft)}
    .btn{cursor:pointer;user-select:none;border:1px solid var(--stroke);background:linear-gradient(180deg,var(--chip),var(--chip2));color:var(--text);padding:10px 12px;border-radius:999px;display:inline-flex;align-items:center;gap:8px;font-weight:600}
    .btn:active{transform:translateY(1px)}
    .btn.primary{border-color:#284a86;background:linear-gradient(180deg,#17325d,#0e1f3e)}
    .btn.danger{border-color:#7a1a1a;background:linear-gradient(180deg,#3a1010,#1a0b0b)}
    .btn.ok{border-color:#1f6a3c;background:linear-gradient(180deg,#0f2e1f,#0b1f16)}
    .btn.warn{border-color:#7a5b1a;background:linear-gradient(180deg,#2d2510,#1b160a)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .stage{
      background:linear-gradient(180deg,rgba(10,18,34,.85),rgba(6,10,18,.92));
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      box-shadow:var(--glow);
      overflow:hidden;
    }
    .hero{
      position:relative;
      width:100%;
      height:min(44vh,420px);
      min-height:260px;
      display:flex;
      align-items:center;
      justify-content:center;
      background:radial-gradient(900px 360px at 50% 40%, rgba(120,190,255,.15), transparent 60%);
    }
    .hero video{
      width:100%;
      height:100%;
      object-fit:contain; /* ‚úÖ NO CORTA */
      object-position:center center;
      filter:contrast(1.08) saturate(1.08);
      background:transparent;
    }
    .hero::after{
      content:"";
      position:absolute;inset:0;
      background:linear-gradient(180deg,rgba(0,0,0,.12),rgba(0,0,0,.55));
      pointer-events:none;
    }
    .heroHud{
      position:absolute;left:14px;bottom:14px;right:14px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      pointer-events:none;
    }
    .hudLeft{display:flex;flex-direction:column;gap:6px}
    .hudLeft .mini{display:flex;gap:10px;align-items:center;color:var(--soft);font-weight:600}
    .hudLeft .mini b{color:var(--text)}
    .hint{
      pointer-events:none;
      background:rgba(3,6,12,.55);
      border:1px solid rgba(31,42,68,.8);
      padding:10px 12px;border-radius:999px;color:#cbd5e1;
      max-width:min(520px, 78vw);
      text-overflow:ellipsis;overflow:hidden;white-space:nowrap;
    }
    .controls{
      padding:12px 12px 14px;
      border-top:1px solid rgba(31,42,68,.65);
      background:rgba(6,10,18,.75);
    }
    .log{
      margin-top:10px;
      background:rgba(4,7,12,.65);
      border:1px solid rgba(31,42,68,.55);
      border-radius:16px;
      padding:12px;
      min-height:250px;
      max-height:44vh;
      overflow:auto;
    }
    .msg{display:flex;gap:10px;margin:10px 0}
    .tag{
      min-width:44px;
      height:26px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border-radius:999px;
      border:1px solid rgba(31,42,68,.8);
      font-size:12px;
      font-weight:800;
      letter-spacing:.8px;
      opacity:.92;
    }
    .tag.sys{background:rgba(25,30,42,.65);color:#dbeafe}
    .tag.you{background:rgba(14,37,65,.72);color:#e0f2fe}
    .tag.ai{background:rgba(14,65,45,.55);color:#dcfce7}
    .bubble{
      flex:1;
      background:rgba(8,12,22,.75);
      border:1px solid rgba(31,42,68,.55);
      border-radius:14px;
      padding:10px 12px;
      color:#e5e7eb;
      white-space:pre-wrap;
      word-break:break-word;
    }
    .composer{
      margin-top:12px;
      display:flex;
      gap:10px;
      align-items:flex-end;
    }
    textarea{
      flex:1;
      resize:none;
      height:86px;
      border-radius:16px;
      border:1px solid rgba(31,42,68,.7);
      background:rgba(5,8,14,.85);
      color:var(--text);
      padding:12px 12px;
      outline:none;
      font-size:15px;
      line-height:1.25;
    }
    .send{
      min-width:140px;
      height:86px;
      border-radius:16px;
      border:1px solid rgba(40,74,134,.9);
      background:linear-gradient(180deg,#183765,#0d1f3f);
      color:var(--text);
      font-weight:900;
      letter-spacing:.6px;
    }
    .subrow{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px;color:var(--soft);font-weight:700}
    .kv{display:flex;gap:10px;flex-wrap:wrap}
    .kv span{opacity:.9}
    .ownerPanel{
      margin-top:10px;
      padding:12px;
      border:1px dashed rgba(148,163,184,.35);
      border-radius:16px;
      background:rgba(4,8,14,.45);
      display:none;
    }
    .ownerPanel.show{display:block}
    input[type="password"], input[type="text"]{
      height:42px;border-radius:12px;border:1px solid rgba(31,42,68,.7);
      background:rgba(5,8,14,.85);color:var(--text);padding:0 12px;outline:none;min-width:240px;
    }
    .camPreview{
      margin-top:10px;
      display:none;
      border:1px solid rgba(31,42,68,.6);
      border-radius:16px;
      overflow:hidden;
      background:rgba(0,0,0,.35);
    }
    .camPreview.show{display:block}
    .camPreview video{
      width:100%;
      height:220px;
      object-fit:cover;
    }
    @media (max-width:720px){
      .send{min-width:120px}
      .hero{height:320px}
    }
  </style>
</head>

<body>
<div class="wrap">

  <div class="topbar">
    <div class="brand">
      <div class="dot"></div>
      <div>CONSIA <span style="opacity:.65">‚àû</span></div>
    </div>
    <div class="badge">
      <div class="pill"><small id="rtLabel">Realtime</small> <b id="rtStatus">desconectado</b></div>
      <div class="pill"><small>API</small> <b id="apiLabel">api.consia.world</b></div>
      <button class="btn primary" id="btnTest">Test API</button>
    </div>
  </div>

  <div class="stage">
    <div class="hero">
      <video id="avatarVideo" autoplay muted playsinline loop preload="auto">
        <source src="avatar.mp4" type="video/mp4" />
      </video>

      <div class="heroHud">
        <div class="hudLeft">
          <div class="mini"><span class="dot" style="width:8px;height:8px"></span><span id="onlineText">ONLINE</span> <span style="opacity:.55">¬∑</span> <b id="modeText">auto</b></div>
          <div class="mini"><span style="opacity:.8">Dec√≠</span> <b>"Hola CONSIA"</b> <span style="opacity:.8">o escrib√≠ abajo</span></div>
        </div>
        <div class="hint" id="hintText">voz si el navegador soporta</div>
      </div>
    </div>

    <div class="controls">
      <div class="row">
        <button class="btn" id="btnGuide">üß≠ Guiame (3 opciones)</button>
        <button class="btn" id="btnWhat">üß† ¬øQu√© puede hacer?</button>
        <button class="btn" id="btnHyper">üñºÔ∏è Hiperrealismo</button>
        <button class="btn" id="btnVoice">üéôÔ∏è Voz</button>
        <button class="btn" id="btnCamera">üì∑ C√°mara</button>
        <button class="btn warn" id="btnAscend">‚ö° ASCEND</button>
      </div>

      <div class="row" style="margin-top:10px">
        <input type="file" id="fileInput" multiple style="display:none" />
        <button class="btn" id="btnUpload">üìé Subir archivo</button>
        <button class="btn" id="btnCamLive">üì∑ C√°mara (vivo 100%)</button>
        <button class="btn ok" id="btnTalk">üó£Ô∏è Hablar</button>
        <button class="btn" id="btnRead">üëÅÔ∏è Leer</button>
        <button class="btn" id="btnClear">üßπ Limpiar</button>
        <button class="btn danger" id="btnStopVoice">‚èπÔ∏è Stop voz</button>
        <button class="btn" id="btnOwner">üîí Owner</button>
      </div>

      <div class="subrow">
        <div class="kv">
          <span>Idioma: <b id="langLabel">ES</b></span>
          <span>Realtime: <b id="rtMode">auto</b></span>
          <span>Adjuntos: <b id="attCount">0</b></span>
          <span>C√°mara: <b id="camState">off</b></span>
        </div>
      </div>

      <div class="ownerPanel" id="ownerPanel">
        <div class="row">
          <input id="ownerToken" type="password" placeholder="OWNER TOKEN (solo Mart√≠n)" />
          <button class="btn ok" id="btnOwnerSave">Activar Owner</button>
          <button class="btn danger" id="btnOwnerOff">Salir Owner</button>
        </div>
        <div class="row" style="margin-top:10px">
          <input id="avatarPrompt" type="text" placeholder="Avatar prompt (ENTIDAD CONSIA...)" />
          <button class="btn primary" id="btnAvatarTransform">Actualizar Avatar (global)</button>
          <button class="btn primary" id="btnSeal">Sellar flags (global)</button>
        </div>
        <div class="subrow" style="margin-top:8px">
          <span>Owner activo: <b id="ownerOn">NO</b></span>
        </div>
      </div>

      <div class="camPreview" id="camPreview">
        <video id="camVideo" autoplay muted playsinline></video>
      </div>

      <div class="log" id="log"></div>

      <div class="composer">
        <textarea id="input" placeholder='Dec√≠ lo que quer√©s (o escrib√≠ ".")'></textarea>
        <button class="send" id="sendBtn">Enviar</button>
      </div>
    </div>
  </div>

</div>

<script>
  // ===== CONFIG =====
  const API = "https://api.consia.world";
  const ENDPOINT_ASK = API + "/ask";
  const ENDPOINT_UI  = API + "/ui";
  const ENDPOINT_AVATAR_LATEST = API + "/avatar/latest";
  const ENDPOINT_AVATAR_TRANSFORM = API + "/avatar/transform";
  const ENDPOINT_OWNER_SEAL = API + "/owner/seal";
  const ENDPOINT_WS = API.replace("https://","wss://") + "/realtime";

  const $ = (id)=>document.getElementById(id);

  // ===== STATE =====
  let attachments = [];
  let ownerToken = localStorage.getItem("CONSIA_OWNER_TOKEN") || "";
  let ownerActive = !!ownerToken;
  let ascend = false;

  let ws = null;
  let recognition = null;
  let speaking = false;

  // camera
  let camStream = null;
  let camLive = false;
  let camInterval = null;
  let lastCamFrameB64 = null;

  // avatar talk swap (opcional)
  const avatarVideo = $("avatarVideo");
  const avatarIdleSrc = "avatar.mp4";
  const avatarTalkSrc = "avatar_talk.mp4";

  function log(tag, text){
    const el = document.createElement("div");
    el.className = "msg";
    const t = document.createElement("div");
    t.className = "tag " + tag;
    t.textContent = tag.toUpperCase();
    const b = document.createElement("div");
    b.className = "bubble";
    b.textContent = text;
    el.appendChild(t); el.appendChild(b);
    $("log").appendChild(el);
    $("log").scrollTop = $("log").scrollHeight;
  }

  function setOwnerUI(){
    $("ownerOn").textContent = ownerActive ? "S√ç" : "NO";
    $("ownerPanel").classList.toggle("show", false);
  }

  function setRtStatus(ok){
    $("rtStatus").textContent = ok ? "conectado" : "desconectado";
    $("rtStatus").style.color = ok ? "var(--ok)" : "var(--soft)";
  }

  async function fetchUI(){
    try{
      const r = await fetch(ENDPOINT_UI);
      const j = await r.json();
      if(j?.ok){
        // avatar urls
        if(j.avatar?.url) {
          // no cortar: ya est√° en CSS
          // set only if exists
          const src = j.avatar.url.startsWith("http") ? j.avatar.url : j.avatar.url;
          avatarVideo.innerHTML = `<source src="${src}" type="video/mp4" />`;
          avatarVideo.load();
        }
      }
    }catch(e){}
  }

  // ===== Realtime WS =====
  function connectWS(){
    try{
      ws = new WebSocket(ENDPOINT_WS);
      ws.onopen = ()=> { setRtStatus(true); $("rtMode").textContent="auto"; log("sys","Realtime conectado."); };
      ws.onclose = ()=> { setRtStatus(false); log("sys","Realtime desconectado."); };
      ws.onerror = ()=> { setRtStatus(false); };
      ws.onmessage = (evt)=>{
        try{
          const m = JSON.parse(evt.data);
          if(m?.type==="hello") log("sys", evt.data);
        }catch{
          // ignore
        }
      }
    }catch(e){
      setRtStatus(false);
    }
  }

  // ===== Voice: TTS =====
  function speak(text){
    try{
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = "es-AR";
      u.rate = 1.02;
      u.pitch = 1.0;
      u.onstart = ()=>{
        speaking = true;
        // swap avatar to talk (si existe)
        try{
          avatarVideo.muted = true;
          const test = document.createElement("video");
          test.src = avatarTalkSrc;
          test.onloadeddata = ()=>{
            avatarVideo.innerHTML = `<source src="${avatarTalkSrc}" type="video/mp4" />`;
            avatarVideo.load();
            avatarVideo.play().catch(()=>{});
          };
          test.onerror = ()=>{};
        }catch(e){}
      };
      u.onend = ()=>{
        speaking = false;
        // back to idle
        avatarVideo.innerHTML = `<source src="${avatarIdleSrc}" type="video/mp4" />`;
        avatarVideo.load();
        avatarVideo.play().catch(()=>{});
      };
      window.speechSynthesis.speak(u);
    }catch(e){}
  }

  // ===== Voice: SpeechRecognition =====
  function setupRecognition(){
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SR) return null;
    const r = new SR();
    r.lang = "es-AR";
    r.interimResults = false;
    r.continuous = false;

    r.onresult = (evt)=>{
      const text = evt.results?.[0]?.[0]?.transcript?.trim() || "";
      if(!text) return;
      log("you", "üéôÔ∏è " + text);
      // wake phrase
      const lower = text.toLowerCase();
      if(lower.includes("hola consia")){
        $("input").value = "Guiame: dame 3 opciones y pedime lo m√≠nimo en 1 sola pregunta. Luego esper√° mi 1 frase y ejecut√°.";
        send();
        return;
      }
      $("input").value = text;
      send();
    };

    r.onerror = ()=>{};
    r.onend = ()=>{};
    return r;
  }

  // ===== Camera (FRONTAL) =====
  async function startCamera(){
    if(camStream) return;
    try{
      camStream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: "user", width: { ideal: 1280 }, height:{ ideal: 720 } }, // ‚úÖ FRONTAL
        audio: false
      });
      $("camVideo").srcObject = camStream;
      $("camPreview").classList.add("show");
      $("camState").textContent = "on";
    }catch(e){
      log("sys","C√°mara: permiso denegado o no disponible.");
      camStream = null;
      $("camState").textContent = "off";
    }
  }

  function stopCamera(){
    if(camInterval) clearInterval(camInterval);
    camInterval = null;
    camLive = false;
    if(camStream){
      camStream.getTracks().forEach(t=>t.stop());
      camStream = null;
    }
    $("camPreview").classList.remove("show");
    $("camState").textContent = "off";
  }

  function captureFrameBase64(){
    if(!camStream) return null;
    const v = $("camVideo");
    const w = 640;
    const h = Math.round((v.videoHeight / v.videoWidth) * w) || 360;
    const c = document.createElement("canvas");
    c.width = w; c.height = h;
    const ctx = c.getContext("2d");
    ctx.drawImage(v, 0, 0, w, h);
    // jpeg compact
    const dataUrl = c.toDataURL("image/jpeg", 0.72);
    return dataUrl.split(",")[1] || null;
  }

  async function toggleCamLive(){
    if(!camStream) await startCamera();
    if(!camStream) return;

    camLive = !camLive;
    if(camLive){
      log("sys","C√°mara vivo 100%: activo.");
      $("camState").textContent = "live";
      // 2 fps (suficiente, sin cortar)
      camInterval = setInterval(()=>{
        lastCamFrameB64 = captureFrameBase64();
      }, 500);
    } else {
      log("sys","C√°mara vivo 100%: off.");
      $("camState").textContent = "on";
      if(camInterval) clearInterval(camInterval);
      camInterval = null;
      lastCamFrameB64 = null;
    }
  }

  // ===== File uploads =====
  $("btnUpload").onclick = ()=> $("fileInput").click();
  $("fileInput").addEventListener("change", async (e)=>{
    const files = Array.from(e.target.files || []);
    if(!files.length) return;

    // limit: 8 files, each 1.5MB encoded target
    const picked = files.slice(0,8);
    attachments = [];

    for(const f of picked){
      const buf = await f.arrayBuffer();
      // hard cap raw 2.2MB to avoid huge base64
      if(buf.byteLength > 2_200_000){
        attachments.push({ name:f.name, type:f.type || "application/octet-stream", size:buf.byteLength, data_base64:"" });
        continue;
      }
      const b64 = arrayBufferToBase64(buf);
      attachments.push({ name:f.name, type:f.type || "application/octet-stream", size:buf.byteLength, data_base64:b64 });
    }

    $("attCount").textContent = String(attachments.length);
    log("sys", `Adjuntos listos: ${attachments.length}.`);
  });

  function arrayBufferToBase64(buffer){
    let binary = "";
    const bytes = new Uint8Array(buffer);
    const chunk = 0x8000;
    for(let i=0;i<bytes.length;i+=chunk){
      binary += String.fromCharCode.apply(null, bytes.subarray(i,i+chunk));
    }
    return btoa(binary);
  }

  // ===== Send =====
  async function send(){
    const text = $("input").value.trim();
    if(!text && !lastCamFrameB64 && !attachments.length){
      log("sys","Decime 1 frase.");
      return;
    }

    // owner command shortcut (voice/text): "OWNER: ..."
    const isOwnerCmd = text.toUpperCase().startsWith("OWNER:");
    if(isOwnerCmd && ownerActive){
      await ownerCommand(text.slice(6).trim());
      $("input").value = "";
      return;
    }

    log("you", text || "(c√°mara/adjuntos)");

    const payload = {
      text: ascend ? `ASCEND: ${text}` : text,
      attachments,
      camera_frames: lastCamFrameB64 ? [lastCamFrameB64] : []
    };

    const headers = { "content-type":"application/json", "x-consia-session":"web" };
    if(ownerActive) headers["x-consia-owner"] = ownerToken;

    try{
      const r = await fetch(ENDPOINT_ASK, { method:"POST", headers, body: JSON.stringify(payload) });
      const j = await r.json();
      if(!j?.ok){
        log("sys", "Error: " + (j?.error || "unknown"));
        return;
      }
      log("ai", j.reply || "OK.");
      // speak by default if voice enabled
      if($("btnVoice").dataset.on === "1"){
        speak(j.reply || "");
      }
    }catch(e){
      log("sys","No hay conexi√≥n con API.");
    }
  }

  $("sendBtn").onclick = send;
  $("input").addEventListener("keydown",(e)=>{
    if(e.key==="Enter" && !e.shiftKey){
      e.preventDefault();
      send();
    }
  });

  // ===== Owner Panel =====
  $("btnOwner").onclick = ()=>{
    $("ownerPanel").classList.toggle("show");
    $("ownerToken").value = ownerToken || "";
    $("ownerOn").textContent = ownerActive ? "S√ç" : "NO";
  };

  $("btnOwnerSave").onclick = ()=>{
    ownerToken = $("ownerToken").value.trim();
    ownerActive = !!ownerToken;
    if(ownerActive) localStorage.setItem("CONSIA_OWNER_TOKEN", ownerToken);
    $("ownerOn").textContent = ownerActive ? "S√ç" : "NO";
    log("sys", ownerActive ? "Owner: activo." : "Owner: off.");
  };

  $("btnOwnerOff").onclick = ()=>{
    ownerToken = "";
    ownerActive = false;
    localStorage.removeItem("CONSIA_OWNER_TOKEN");
    $("ownerOn").textContent = "NO";
    log("sys","Owner: off.");
  };

  $("btnAvatarTransform").onclick = async ()=>{
    if(!ownerActive) { log("sys","Owner requerido."); return; }
    const prompt = $("avatarPrompt").value.trim() || "ENTIDAD CONSIA ‚Äî hiperrealista top 1";
    try{
      const r = await fetch(ENDPOINT_AVATAR_TRANSFORM, {
        method:"POST",
        headers:{ "content-type":"application/json", "x-consia-owner": ownerToken },
        body: JSON.stringify({ prompt })
      });
      const j = await r.json();
      if(!j?.ok){ log("sys","Error avatar: " + (j?.error||"unknown")); return; }
      log("sys", j.reply || "Avatar actualizado.");
      // refresh
      await fetchUI();
    }catch(e){
      log("sys","No se pudo actualizar avatar.");
    }
  };

  $("btnSeal").onclick = async ()=>{
    if(!ownerActive) { log("sys","Owner requerido."); return; }
    const seal = {
      flags:{
        cameraLivePercent: 100,
        allowUploads:true,
        allowCamera:true,
        allowVoice:true,
        realtime:true
      }
    };
    try{
      const r = await fetch(ENDPOINT_OWNER_SEAL, {
        method:"POST",
        headers:{ "content-type":"application/json", "x-consia-owner": ownerToken },
        body: JSON.stringify(seal)
      });
      const j = await r.json();
      if(!j?.ok){ log("sys","Error seal: " + (j?.error||"unknown")); return; }
      log("sys","SELLADO: OK.");
    }catch(e){
      log("sys","No se pudo sellar.");
    }
  };

  async function ownerCommand(cmd){
    // minimal owner ‚Äúsuperpower‚Äù: set avatar prompt global
    // 1) "avatar: ..."
    // 2) "seal"
    const c = cmd.trim();
    if(!c) return;
    if(c.toLowerCase().startsWith("avatar:")){
      $("avatarPrompt").value = c.slice(7).trim();
      $("btnAvatarTransform").click();
      return;
    }
    if(c.toLowerCase()==="seal"){
      $("btnSeal").click();
      return;
    }
    log("sys","Owner cmd: OK (avatar: / seal).");
  }

  // ===== Buttons =====
  $("btnClear").onclick = ()=>{
    $("log").innerHTML = "";
    log("sys","CONSIA UI HOTFIX activo. Input siempre visible. Idioma ES.");
  };

  $("btnTest").onclick = async ()=>{
    try{
      const r = await fetch(API + "/health");
      const j = await r.json();
      log("sys", JSON.stringify(j, null, 2));
    }catch(e){
      log("sys","Health: sin conexi√≥n.");
    }
  };

  $("btnGuide").onclick = ()=>{
    $("input").value = "Guiame (3 opciones): dame 3 opciones y pedime lo m√≠nimo en 1 sola pregunta. Luego esper√° mi 1 frase y ejecut√°.";
    send();
  };

  $("btnWhat").onclick = ()=>{
    $("input").value = "¬øQu√© puede hacer CONSIA hoy? List√° funciones reales disponibles (texto/voz/realtime/archivos/c√°mara) y pedime lo m√≠nimo.";
    send();
  };

  $("btnHyper").onclick = ()=>{
    $("input").value = "Hiperrealismo con c√°mara: dame 3 opciones (Imagen/Video/Avatar) y pedime lo m√≠nimo en 1 sola pregunta. Luego esper√° mi 1 frase y ejecut√°.";
    send();
  };

  $("btnAscend").onclick = ()=>{
    ascend = !ascend;
    $("modeText").textContent = ascend ? "ASCEND" : "auto";
    log("sys", ascend ? "ASCEND: ON (respuestas ultra cortas)." : "ASCEND: OFF.");
  };

  $("btnVoice").onclick = ()=>{
    const on = $("btnVoice").dataset.on === "1";
    $("btnVoice").dataset.on = on ? "0" : "1";
    log("sys", on ? "Voz: OFF." : "Voz: ON.");
  };

  $("btnStopVoice").onclick = ()=>{
    try{ window.speechSynthesis.cancel(); }catch(e){}
    log("sys","Voz: stop.");
    // reset avatar to idle
    avatarVideo.innerHTML = `<source src="${avatarIdleSrc}" type="video/mp4" />`;
    avatarVideo.load();
    avatarVideo.play().catch(()=>{});
  };

  $("btnTalk").onclick = ()=>{
    if(!recognition){
      recognition = setupRecognition();
      if(!recognition){ log("sys","Voz: no soportada en este navegador."); return; }
    }
    try{
      recognition.start();
      log("sys","Voz: listo. Toc√° üó£Ô∏è Hablar y dec√≠ tu frase.");
    }catch(e){}
  };

  $("btnRead").onclick = ()=>{
    $("input").value = "Le√© y resum√≠ en bullets. Pedime 1 sola cosa si falta.";
    send();
  };

  $("btnCamera").onclick = async ()=>{
    if(camStream){ stopCamera(); log("sys","C√°mara: off."); }
    else { await startCamera(); }
  };

  $("btnCamLive").onclick = toggleCamLive;

  // ===== Init =====
  (function init(){
    $("apiLabel").textContent = API.replace("https://","");
    log("sys","CONSIA UI HOTFIX activo. Input siempre visible. Idioma ES.");
    connectWS();
    fetchUI();
    setOwnerUI();
    $("ownerOn").textContent = ownerActive ? "S√ç" : "NO";
  })();
</script>

</body>
</html>
