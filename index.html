<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>CONSIA LIVE · Teletransportación</title>
<style>
  :root{
    --glass: rgba(0,0,0,.55);
    --line: rgba(255,255,255,.18);
    --txt: rgba(255,255,255,.92);
    --muted: rgba(255,255,255,.70);
    --ok: rgba(190,255,220,.95);
    --sys: rgba(180,230,255,.92);
  }
  html,body{margin:0;height:100%;background:#000;overflow:hidden;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial,sans-serif;}
  #stage{position:fixed;inset:0;background:#000;}
  .layer{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;}
  #bgVideo, #bgImg, #avatarVideo, #avatarImg{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;}
  #bgVideo, #bgImg{filter:saturate(1.05) contrast(1.03);}
  #avatarVideo, #avatarImg{filter:saturate(1.08) contrast(1.04);}
  #bgImg, #avatarImg{display:none;}
  #fx{position:absolute;inset:0;width:100%;height:100%;pointer-events:none;mix-blend-mode:screen;opacity:.95;}

  /* transitions */
  .fadeIn{animation:fadeIn .55s ease both;}
  @keyframes fadeIn{from{opacity:0}to{opacity:1}}

  /* loader */
  #loader{
    position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
    background:#000;z-index:50;transition:opacity .35s ease;
  }
  #loader.hidden{opacity:0;pointer-events:none;}
  #brand{color:rgba(255,255,255,.75);letter-spacing:.5em;font-size:18px;}

  /* tap to start */
  #tap{
    position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:40;
    background:rgba(0,0,0,.45);backdrop-filter:blur(12px);
    padding: max(14px, env(safe-area-inset-top)) 14px max(14px, env(safe-area-inset-bottom));
  }
  #tap .card{
    background:var(--glass);border:1px solid var(--line);border-radius:18px;
    padding:18px 18px;max-width:360px;color:var(--txt);text-align:center;
  }
  #tap .hint{color:var(--muted);font-size:13px;margin-top:8px;line-height:1.25;}

  button, select{
    background:rgba(0,0,0,.55);border:1px solid var(--line);color:var(--txt);
    padding:12px 14px;border-radius:14px;backdrop-filter:blur(12px);
  }

  /* UI bar */
  #ui{
    position:fixed;left:50%;transform:translateX(-50%);
    bottom: calc(14px + env(safe-area-inset-bottom));
    display:flex;gap:10px;z-index:30;flex-wrap:wrap;justify-content:center;
    padding:0 12px;
  }

  /* chat */
  #chat{
    position:fixed;right:14px;
    bottom: calc(84px + env(safe-area-inset-bottom));
    width:min(420px,calc(100vw - 28px));
    height:min(360px,calc(100vh - 180px));
    z-index:30;background:var(--glass);border:1px solid var(--line);
    border-radius:18px;backdrop-filter:blur(16px);display:flex;flex-direction:column;overflow:hidden;
  }
  #chatHeader{
    padding:10px 12px;border-bottom:1px solid var(--line);
    display:flex;gap:8px;align-items:center;justify-content:space-between;
  }
  #leftHead{display:flex;gap:8px;align-items:center}
  #mode{color:rgba(255,255,255,.55);font-size:12px}
  #log{padding:10px 12px;flex:1;overflow:auto;color:var(--txt);font-size:14px;line-height:1.3}
  #inputRow{display:flex;gap:8px;padding:10px 12px;border-top:1px solid var(--line)}
  #msg{flex:1;border:none;border-radius:12px;padding:10px 10px;background:rgba(255,255,255,.10);color:var(--txt);outline:none}
  #send{min-width:78px}
  .sys{color:var(--sys)}
  .me{color:rgba(255,255,255,.92)}
  .c{color:var(--ok)}
  .small{font-size:12px;color:var(--muted)}

  /* status */
  #status{
    position:fixed;left:14px;bottom: calc(14px + env(safe-area-inset-bottom));z-index:30;
    padding:8px 10px;border-radius:12px;background:rgba(0,0,0,.35);border:1px solid var(--line);
    color:var(--muted);font-size:12px;backdrop-filter:blur(10px)
  }

  /* teleport pill */
  #telePill{
    position:fixed;left:14px;top: calc(14px + env(safe-area-inset-top));z-index:30;
    padding:8px 10px;border-radius:12px;background:rgba(0,0,0,.35);border:1px solid var(--line);
    color:var(--muted);font-size:12px;backdrop-filter:blur(10px)
  }

  /* camera modal */
  #camModal{
    position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:60;
    background:rgba(0,0,0,.7);backdrop-filter:blur(10px);
    padding: max(14px, env(safe-area-inset-top)) 14px max(14px, env(safe-area-inset-bottom));
  }
  #camBox{
    width:min(520px,calc(100vw - 28px));
    background:rgba(0,0,0,.6);
    border:1px solid var(--line);
    border-radius:18px;
    overflow:hidden;
  }
  #camTop{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--line)}
  #camVid{width:100%;height:340px;object-fit:cover;background:#000}
  @media (max-width: 640px){
    #chat{left:14px;right:14px;width:auto}
    #camVid{height:260px}
  }
</style>
</head>
<body>

<div id="stage">
  <!-- BACKGROUND (teleport) -->
  <video id="bgVideo" class="layer" playsinline muted loop preload="auto">
    <source src="./bg.mp4" type="video/mp4">
  </video>
  <img id="bgImg" class="layer" src="./bg.jpg" alt="Background"/>

  <!-- AVATAR -->
  <video id="avatarVideo" class="layer" playsinline muted loop preload="auto" poster="avatar-poster.jpg">
    <source src="./avatar.mp4" type="video/mp4">
  </video>
  <img id="avatarImg" class="layer" src="./avatar.jpg" alt="CONSIA"/>

  <canvas id="fx"></canvas>
</div>

<div id="loader"><div id="brand">CONSIA</div></div>

<div id="tap">
  <div class="card">
    <div style="font-size:16px;letter-spacing:.12em;margin-bottom:10px">CONSIA · LIVE</div>
    <button id="tapBtn">Un toque para iniciar</button>
    <div class="hint">Después queda 1-click. (Audio / micrófono / cámara pueden requerir 1 toque).</div>
  </div>
</div>

<div id="telePill">Teletransportación: <b id="teleState">ON</b></div>

<div id="chat">
  <div id="chatHeader">
    <div id="leftHead">
      <span class="sys">CONSIA</span>
      <span id="mode">LIVE · Voz Natural · Teleport</span>
    </div>
    <select id="lang" title="Idioma / Translate">
      <option value="auto" selected>Auto</option>
      <option value="es">ES</option>
      <option value="en">EN</option>
      <option value="pt">PT</option>
      <option value="fr">FR</option>
      <option value="it">IT</option>
      <option value="de">DE</option>
    </select>
  </div>
  <div id="log"></div>
  <div id="inputRow">
    <input id="msg" placeholder="Escribí o decí: ‘teletransportame a…’" />
    <button id="send">Enviar</button>
  </div>
</div>

<div id="ui">
  <button id="talk">Hablar</button>
  <button id="stop">Stop</button>
  <button id="audio">Ambiente</button>
  <button id="teleport">Teleport</button>
  <button id="sign">Señas</button>
  <button id="unlock">Face ID</button>
  <button id="captions">Subtítulos</button>
</div>

<div id="status">Inicializando…</div>

<!-- Modo señas (cámara) -->
<div id="camModal">
  <div id="camBox">
    <div id="camTop">
      <div class="sys">CONSIA · Modo Señas</div>
      <button id="camClose">Cerrar</button>
    </div>
    <video id="camVid" autoplay playsinline muted></video>
    <div style="padding:10px 12px;border-top:1px solid var(--line)" class="small">
      Mostrá señas o gestos. (La interpretación inteligente se activa vía tu API /scene cuando quieras.)
    </div>
  </div>
</div>

<script>
/* =========================
   CONFIG
========================= */
const API_URL = "https://api.consia.world/ask";
const SCENE_URL = "https://api.consia.world/scene"; // opcional: si no existe, usamos escenas locales
const AUDIO_PREFERRED = true;

/* =========================
   ELEMENTS
========================= */
const loader = document.getElementById("loader");
const tap = document.getElementById("tap");
const tapBtn = document.getElementById("tapBtn");
const logEl = document.getElementById("log");
const msgEl = document.getElementById("msg");
const sendBtn = document.getElementById("send");
const statusEl = document.getElementById("status");
const langEl = document.getElementById("lang");

const bgVideo = document.getElementById("bgVideo");
const bgImg = document.getElementById("bgImg");
const avatarVideo = document.getElementById("avatarVideo");
const avatarImg = document.getElementById("avatarImg");

const teleBtn = document.getElementById("teleport");
const teleStateEl = document.getElementById("teleState");

const camModal = document.getElementById("camModal");
const camVid = document.getElementById("camVid");
const camClose = document.getElementById("camClose");

/* =========================
   STATUS / LOG
========================= */
function setStatus(t){ statusEl.textContent = t; }
function addLine(cls, text){
  const d = document.createElement("div");
  d.className = cls;
  d.textContent = text;
  logEl.appendChild(d);
  logEl.scrollTop = logEl.scrollHeight;
}

/* =========================
   LOCALE
========================= */
function deviceLocale(){
  const nav = (navigator.language || "es").toLowerCase();
  if(nav.startsWith("pt")) return "pt";
  if(nav.startsWith("en")) return "en";
  if(nav.startsWith("fr")) return "fr";
  if(nav.startsWith("it")) return "it";
  if(nav.startsWith("de")) return "de";
  return "es";
}
function pickTargetLang(){
  const v = langEl.value;
  return (v === "auto") ? deviceLocale() : v;
}
function tz(){
  try { return Intl.DateTimeFormat().resolvedOptions().timeZone || ""; } catch(e){ return ""; }
}

/* =========================
   VOICE (best available)
========================= */
let VOICES = [];
function refreshVoices(){ VOICES = speechSynthesis.getVoices() || []; }
refreshVoices();
speechSynthesis.onvoiceschanged = refreshVoices;

function scoreVoice(voice, lang){
  const name = (voice.name || "").toLowerCase();
  const vlang = (voice.lang || "").toLowerCase();
  let s = 0;
  if(vlang.startsWith(lang+"-")) s += 60;
  if(vlang.startsWith(lang)) s += 55;
  if(name.includes("neural")) s += 45;
  if(name.includes("premium")) s += 35;
  if
