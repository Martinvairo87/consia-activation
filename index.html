<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#000000" />
  <title>CONSIA</title>

  <link rel="manifest" href="./manifest.webmanifest" />
  <link rel="icon" href="./icon-192.png" />
  <style>
    :root{
      --bg:#000;
      --glass: rgba(18,22,30,.55);
      --glass2: rgba(18,22,30,.35);
      --stroke: rgba(255,255,255,.10);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.65);
      --accent: rgba(120,180,255,.95);
      --danger: rgba(255,90,90,.92);
      --ok: rgba(90,255,170,.85);
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; background:var(--bg); color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    .bg {
      position:fixed; inset:0;
      display:flex; align-items:center; justify-content:center;
      overflow:hidden;
    }
    video#avatar {
      width:100%; height:100%; object-fit:cover;
      filter: contrast(1.05) saturate(1.05);
      opacity:.95;
    }
    .shade{
      position:fixed; inset:0;
      background: radial-gradient(ellipse at 50% 35%, rgba(0,0,0,.25), rgba(0,0,0,.75) 60%, rgba(0,0,0,.92));
      pointer-events:none;
    }
    .wrap{
      position:fixed; inset:0;
      display:flex; align-items:flex-end; justify-content:center;
      padding: 18px 14px calc(18px + env(safe-area-inset-bottom));
    }
    .panel{
      width:min(920px, 100%);
      border:1px solid var(--stroke);
      border-radius: 18px;
      background: linear-gradient(180deg, var(--glass), var(--glass2));
      backdrop-filter: blur(16px);
      box-shadow: 0 18px 60px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      padding: 14px 14px;
      border-bottom:1px solid var(--stroke);
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:700; letter-spacing:.22em;
    }
    .status{
      display:flex; align-items:center; gap:10px;
      font-size:12px; color:var(--muted);
    }
    .dot{ width:8px; height:8px; border-radius:50%; background:var(--danger); box-shadow:0 0 18px rgba(255,90,90,.55); }
    .dot.ok{ background:var(--ok); box-shadow:0 0 18px rgba(90,255,170,.45); }

    .controls{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .pill{
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.25);
      color: var(--text);
      border-radius: 999px;
      padding:10px 12px;
      font-size:13px;
      cursor:pointer;
      user-select:none;
    }
    .pill:active{ transform: translateY(1px); }
    select.pill{ padding:10px 10px; }

    .body{
      padding: 14px;
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    .quick{
      display:flex; gap:10px; flex-wrap:wrap;
    }
    .chat{
      height: 360px;
      overflow:auto;
      border:1px solid var(--stroke);
      border-radius: 14px;
      background: rgba(0,0,0,.18);
      padding: 12px;
    }
    .msg{ display:flex; margin: 10px 0; }
    .msg .bubble{
      max-width: 85%;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.20);
      padding: 10px 12px;
      border-radius: 14px;
      line-height:1.35;
      color: var(--text);
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .me{ justify-content:flex-end; }
    .me .bubble{
      background: rgba(120,180,255,.12);
      border-color: rgba(120,180,255,.22);
    }
    .sys .bubble{
      background: rgba(255,255,255,.06);
      color: var(--muted);
    }
    .err .bubble{
      border-color: rgba(255,90,90,.35);
      background: rgba(255,90,90,.10);
    }

    .composer{
      display:flex; gap:10px; align-items:center;
      border:1px solid var(--stroke);
      border-radius: 14px;
      padding:10px;
      background: rgba(0,0,0,.22);
    }
    input#input{
      flex:1;
      border:0; outline:0;
      background: transparent;
      color: var(--text);
      font-size: 15px;
      padding: 10px 8px;
    }
    .btn{
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.30);
      color: var(--text);
      border-radius: 12px;
      padding: 10px 12px;
      cursor:pointer;
      user-select:none;
      font-size: 14px;
      min-width: 44px;
      text-align:center;
    }
    .btn.primary{
      border-color: rgba(120,180,255,.30);
      background: rgba(120,180,255,.14);
    }
    .row{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      color: var(--muted); font-size: 12px;
    }
    .tog{ display:flex; gap:10px; align-items:center; }
    .mini{ opacity:.9; }
    .imgbox{
      display:none;
      border:1px solid var(--stroke);
      border-radius: 14px;
      overflow:hidden;
      background: rgba(0,0,0,.22);
    }
    .imgbox img{ width:100%; display:block; }
    @media (max-width:520px){
      .chat{ height: 48vh; }
    }
  </style>
</head>

<body>
  <div class="bg">
    <video id="avatar" autoplay muted loop playsinline>
      <source src="./avatar.mp4" type="video/mp4" />
    </video>
  </div>
  <div class="shade"></div>

  <div class="wrap">
    <div class="panel">
      <div class="topbar">
        <div class="brand">CONSIA</div>

        <div class="controls">
          <select id="lang" class="pill" title="Idioma (queda fijo, no se mezcla)">
            <option value="es">Espa√±ol</option>
            <option value="en">English</option>
            <option value="pt">Portugu√™s</option>
          </select>

          <div class="pill" id="btnRealtime">Realtime</div>
          <div class="pill" id="btnHyper">Hyperrealismo</div>
          <div class="pill" id="btnIphone">Control iPhone</div>
        </div>

        <div class="status">
          <span class="dot" id="dot"></span>
          <span id="st">OFFLINE</span>
        </div>
      </div>

      <div class="body">
        <div class="quick">
          <div class="pill" id="qGuide">Guiame (3 opciones)</div>
          <div class="pill" id="qWhat">¬øQu√© puedo hacer?</div>
          <div class="pill" id="qMagic">‚Äú.‚Äù magia</div>
          <div class="pill" id="qVoice">Voz (activar)</div>
        </div>

        <div class="chat" id="chat"></div>

        <div class="imgbox" id="imgbox">
          <img id="img" alt="CONSIA render" />
        </div>

        <div class="composer">
          <div class="btn" id="mic" title="Hablar">üéôÔ∏è</div>
          <input id="input" placeholder='Decime qu√© quer√©s. (o escrib√≠ ".")' />
          <div class="btn primary" id="send">Enviar</div>
        </div>

        <div class="row">
          <div class="tog">
            <span class="mini">Audio:</span>
            <div class="btn" id="audioToggle">ON</div>
            <span class="mini">Voz:</span>
            <div class="btn" id="voiceToggle">ON</div>
          </div>
          <div class="mini" id="hint">Un toque. Tres opciones. Cero fricci√≥n.</div>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  // === CONFIG ===
  // Your API domain:
  const API = "https://api.consia.world";
  const DEVICE = (localStorage.getItem("consia_device") || crypto.randomUUID());
  localStorage.setItem("consia_device", DEVICE);

  // === STATE ===
  const el = (id) => document.getElementById(id);
  const chat = el("chat");
  const dot = el("dot");
  const st  = el("st");
  const input = el("input");
  const langSel = el("lang");

  let AUDIO_ON = true;
  let VOICE_ON = true;

  // Lock language (never mix)
  const savedLang = localStorage.getItem("consia_lang");
  if (savedLang) langSel.value = savedLang;
  langSel.addEventListener("change", () => {
    localStorage.setItem("consia_lang", langSel.value);
    sysMsg(msgFor("Idioma fijado: ") + labelLang(langSel.value));
    ping();
  });

  el("audioToggle").onclick = () => {
    AUDIO_ON = !AUDIO_ON;
    el("audioToggle").textContent = AUDIO_ON ? "ON" : "OFF";
  };
  el("voiceToggle").onclick = () => {
    VOICE_ON = !VOICE_ON;
    el("voiceToggle").textContent = VOICE_ON ? "ON" : "OFF";
  };

  function labelLang(v){
    if (v==="en") return "English";
    if (v==="pt") return "Portugu√™s";
    return "Espa√±ol";
  }

  function msgFor(es){
    if (langSel.value==="en") {
      if (es==="Decime qu√© quer√©s. Yo me encargo.") return "Tell me what you want. I‚Äôll handle it.";
      if (es==="Un toque. Tres opciones. Cero fricci√≥n.") return "One tap. Three options. Zero friction.";
      if (es==="Idioma fijado: ") return "Language locked: ";
      if (es==="OFFLINE") return "OFFLINE";
      if (es==="ONLINE") return "ONLINE";
      if (es==="No pude responder. Prob√° de nuevo.") return "I couldn‚Äôt respond. Try again.";
      if (es==="Listo. Pod√©s hablar (üéôÔ∏è) o escribir en el chat.") return "Ready. You can speak (üéôÔ∏è) or type in chat.";
      if (es==="Dame 3 opciones cortas y pedime lo m√≠nimo.") return "Give me 3 short options and ask for the minimum.";
      if (es==="¬øQu√© pod√©s hacer? En 6 bullets ultra cortos y 3 opciones.") return "What can you do? 6 ultra-short bullets then 3 options.";
      if (es==="Hyperrealismo: ofreceme 3 opciones (imagen, video, avatar) y pedime lo m√≠nimo.") return "Hyperrealism: offer 3 options (image, video, avatar) and ask minimum.";
      if (es==="Realtime: activalo con 1 toque y decime 3 comandos ejemplo.") return "Realtime: enable in 1 tap and give 3 example commands.";
      if (es==="Control iPhone: decime c√≥mo lo hago con Atajos en 3 pasos.") return "iPhone control: tell me how with Shortcuts in 3 steps.";
      if (es==="Escrib√≠ tu pedido de hiperrealismo (ej: 'departamento premium con luz c√°lida, r√≠o de fondo')") return "Type your hyperrealism request (e.g. 'premium apartment, warm light, river in background').";
      return es;
    }
    if (langSel.value==="pt") {
      if (es==="Decime qu√© quer√©s. Yo me encargo.") return "Diga o que voc√™ quer. Eu cuido disso.";
      if (es==="Un toque. Tres opciones. Cero fricci√≥n.") return "Um toque. Tr√™s op√ß√µes. Zero fric√ß√£o.";
      if (es==="Idioma fijado: ") return "Idioma fixado: ";
      if (es==="OFFLINE") return "OFFLINE";
      if (es==="ONLINE") return "ONLINE";
      if (es==="No pude responder. Prob√° de nuevo.") return "N√£o consegui responder. Tente novamente.";
      if (es==="Listo. Pod√©s hablar (üéôÔ∏è) o escribir en el chat.") return "Pronto. Voc√™ pode falar (üéôÔ∏è) ou digitar no chat.";
      if (es==="Dame 3 opciones cortas y pedime lo m√≠nimo.") return "Me d√™ 3 op√ß√µes curtas e pe√ßa o m√≠nimo.";
      if (es==="¬øQu√© pod√©s hacer? En 6 bullets ultra cortos y 3 opciones.") return "O que voc√™ pode fazer? 6 bullets bem curtos e 3 op√ß√µes.";
      if (es==="Hyperrealismo: ofreceme 3 opciones (imagen, video, avatar) y pedime lo m√≠nimo.") return "Hiperrealismo: ofere√ßa 3 op√ß√µes (imagem, v√≠deo, avatar) e pe√ßa o m√≠nimo.";
      if (es==="Realtime: activalo con 1 toque y decime 3 comandos ejemplo.") return "Realtime: ative com 1 toque e me d√™ 3 comandos de exemplo.";
      if (es==="Control iPhone: decime c√≥mo lo hago con Atajos en 3 pasos.") return "Controle iPhone: como fazer com Atalhos em 3 passos.";
      if (es==="Escrib√≠ tu pedido de hiperrealismo (ej: 'departamento premium con luz c√°lida, r√≠o de fondo')") return "Digite seu pedido de hiperrealismo (ex: 'apartamento premium, luz quente, rio ao fundo').";
      return es;
    }
    return es;
  }

  function addMsg(who, text, cls="") {
    const row = document.createElement("div");
    row.className = `msg ${who==="me"?"me":who==="sys"?"sys":""} ${cls}`;
    const b = document.createElement("div");
    b.className = "bubble";
    b.textContent = text;
    row.appendChild(b);
    chat.appendChild(row);
    chat.scrollTop = chat.scrollHeight;
  }
  const sysMsg = (t) => addMsg("sys", t);
  const meMsg  = (t) => addMsg("me", t);
  const aiMsg  = (t) => addMsg("ai", t);
  const errMsg = (t) => addMsg("ai", t, "err");

  async function ping() {
    try {
      const r = await fetch(API + "/", { method:"GET" });
      if (!r.ok) throw 0;
      dot.classList.add("ok");
      st.textContent = msgFor("ONLINE");
    } catch {
      dot.classList.remove("ok");
      st.textContent = msgFor("OFFLINE");
    }
  }

  async function ask(message, opts={}) {
    try {
      const payload = {
        message,
        lang: langSel.value,
        audioWanted: (AUDIO_ON && VOICE_ON && !opts.noAudio) ? true : false,
        device: DEVICE
      };

      const r = await fetch(API + "/ask", {
        method:"POST",
        headers:{
          "Content-Type":"application/json",
          "x-consia-device": DEVICE,
          "x-consia-lang": langSel.value
        },
        body: JSON.stringify(payload)
      });

      const data = await r.json().catch(()=> ({}));
      if (!r.ok || data.error) throw new Error(data.detail || data.error || "error");

      if (data.text) aiMsg(data.text);
      if (data.audio_b64 && AUDIO_ON) playB64Audio(data.audio_b64, data.audio_mime || "audio/mpeg");
    } catch(e) {
      errMsg(msgFor("No pude responder. Prob√° de nuevo."));
    }
  }

  async function tts(text) {
    const r = await fetch(API + "/tts", {
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "x-consia-device": DEVICE,
        "x-consia-lang": langSel.value
      },
      body: JSON.stringify({ text, lang: langSel.value, device: DEVICE })
    });
    const data = await r.json().catch(()=> ({}));
    if (!r.ok || data.error) throw new Error(data.detail || data.error || "tts_error");
    if (data.audio_b64 && AUDIO_ON) playB64Audio(data.audio_b64, data.audio_mime || "audio/mpeg");
  }

  function playB64Audio(b64, mime) {
    const bin = atob(b64);
    const bytes = new Uint8Array(bin.length);
    for (let i=0;i<bin.length;i++) bytes[i]=bin.charCodeAt(i);
    const blob = new Blob([bytes], { type:mime });
    const url = URL.createObjectURL(blob);
    const a = new Audio(url);
    a.onended = () => URL.revokeObjectURL(url);
    a.play().catch(()=>{});
  }

  async function hyperImage(prompt) {
    try {
      sysMsg(msgFor("Escrib√≠ tu pedido de hiperrealismo (ej: 'departamento premium con luz c√°lida, r√≠o de fondo')"));
      const r = await fetch(API + "/image", {
        method:"POST",
        headers:{
          "Content-Type":"application/json",
          "x-consia-device": DEVICE,
          "x-consia-lang": langSel.value
        },
        body: JSON.stringify({ prompt, style:"reels", lang: langSel.value, device: DEVICE })
      });
      const data = await r.json().catch(()=> ({}));
      if (!r.ok || data.error) throw new Error(data.detail || data.error || "image_error");

      const imgbox = el("imgbox");
      const img = el("img");
      img.src = `data:${data.image_mime||"image/png"};base64,${data.image_b64}`;
      imgbox.style.display = "block";
      chat.scrollTop = chat.scrollHeight;
      aiMsg("‚úÖ");
    } catch(e) {
      errMsg(msgFor("No pude responder. Prob√° de nuevo."));
    }
  }

  // ==== Voice input (Web Speech API) ====
  let rec = null;
  function startSTT(){
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) { errMsg("STT no disponible en este navegador."); return; }
    rec = new SpeechRecognition();
    rec.lang = (langSel.value==="en") ? "en-US" : (langSel.value==="pt") ? "pt-BR" : "es-AR";
    rec.interimResults = false;
    rec.maxAlternatives = 1;
    rec.onresult = (ev) => {
      const t = ev.results?.[0]?.[0]?.transcript || "";
      if (t.trim()) {
        meMsg(t.trim());
        ask(t.trim());
      }
    };
    rec.onerror = () => {};
    rec.onend = () => {};
    rec.start();
  }

  // ==== Realtime (Phase A) minimal: get token only ====
  async function realtimeToken(){
    try{
      const r = await fetch(API + "/realtime-token", {
        method:"POST",
        headers:{
          "Content-Type":"application/json",
          "x-consia-device": DEVICE,
          "x-consia-lang": langSel.value
        },
        body: JSON.stringify({ lang: langSel.value, device: DEVICE })
      });
      const data = await r.json().catch(()=> ({}));
      if (!r.ok || data.error) throw new Error(data.detail || data.error || "realtime_token_error");
      sysMsg("Realtime token OK ‚úÖ");
      // We keep it simple: Phase 2 can wire WebRTC client fully.
      // (Token is the hard part for browser security.)
      return data.client_secret;
    }catch(e){
      errMsg("Realtime token fall√≥.");
      return null;
    }
  }

  // ==== iPhone Control (Phase C) ====
  function iphoneControl(){
    // Best practical: iOS Shortcuts + share sheet + URL scheme
    const url = "shortcuts://";
    sysMsg("iPhone: Us√° Atajos (Shortcuts). Te dejo lo m√≠nimo:");
    aiMsg("1) Cre√° un Atajo: 'CONSIA' (Entrada: Texto). \n2) En el Atajo: Abrir URL ‚Üí " + API + "/ (o tu app). \n3) Ejecut√° por Siri / Back Tap / Widget.");
    // Copy helper
    navigator.clipboard?.writeText(url).catch(()=>{});
  }

  // ==== UI actions ====
  el("send").onclick = () => {
    const t = input.value.trim();
    if (!t) return;
    input.value = "";
    meMsg(t);
    if (t === ".") {
      ask("Guiame con 3 opciones cortas y claras.");
    } else {
      ask(t);
    }
  };
  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter") el("send").click();
  });

  el("mic").onclick = () => startSTT();

  el("qGuide").onclick = () => ask(msgFor("Dame 3 opciones cortas y pedime lo m√≠nimo."));
  el("qWhat").onclick  = () => ask(msgFor("¬øQu√© pod√©s hacer? En 6 bullets ultra cortos y 3 opciones."));
  el("qMagic").onclick = () => ask("Activ√° modo '.' y guiame con 3 opciones.");
  el("qVoice").onclick = () => ask(msgFor("Listo. Pod√©s hablar (üéôÔ∏è) o escribir en el chat."), { noAudio:true });

  el("btnHyper").onclick = async () => {
    const p = prompt(msgFor("Escrib√≠ tu pedido de hiperrealismo (ej: 'departamento premium con luz c√°lida, r√≠o de fondo')"));
    if (p && p.trim()) hyperImage(p.trim());
  };
  el("btnRealtime").onclick = async () => {
    sysMsg("Realtime: preparando‚Ä¶");
    await realtimeToken();
    aiMsg(msgFor("Realtime: activalo con 1 toque y decime 3 comandos ejemplo."));
    // In Phase 2 we wire full WebRTC session with OpenAI calls endpoint.
  };
  el("btnIphone").onclick = () => iphoneControl();

  // init
  sysMsg(msgFor("Decime qu√© quer√©s. Yo me encargo."));
  sysMsg(msgFor("Un toque. Tres opciones. Cero fricci√≥n."));
  ping();
})();
</script>

<script>
  // Service worker (optional)
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./sw.js").catch(()=>{});
  }
</script>
</body>
</html>
