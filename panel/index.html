<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>CONSIA ‚Äî OWNER GLOBAL CONTROL</title>

  <!-- TOP UI FONTS -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;700;800&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#050607;
      --panel:#070a0b;
      --panel2:#060808;
      --text:#d7ffef;
      --muted:#7ee9c1;
      --muted2:#2ad79b;
      --line:#113b2d;
      --line2:#1b6a4d;
      --accent:#00ffb2;
      --accent2:#00c985;
      --warn:#ffd166;
      --bad:#ff4d6d;
      --ok:#1bffb2;
      --shadow: 0 0 0.8px rgba(0,255,178,.35), 0 0 18px rgba(0,255,178,.10);
      --shadow2: 0 0 0.8px rgba(0,255,178,.25), 0 0 30px rgba(0,255,178,.08);
      --radius:18px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background:
        radial-gradient(1200px 600px at 10% 10%, rgba(0,255,178,.10), transparent 55%),
        radial-gradient(900px 600px at 90% 15%, rgba(0,201,133,.10), transparent 55%),
        radial-gradient(700px 500px at 40% 90%, rgba(0,255,178,.08), transparent 55%),
        linear-gradient(180deg, #050607 0%, #030405 100%);
      color:var(--text);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      letter-spacing:.2px;
      overflow-x:hidden;
    }

    /* subtle scanlines */
    body:before{
      content:"";
      position:fixed; inset:0;
      pointer-events:none;
      background:
        repeating-linear-gradient(
          to bottom,
          rgba(255,255,255,0.03),
          rgba(255,255,255,0.03) 1px,
          transparent 1px,
          transparent 4px
        );
      opacity:.06;
      mix-blend-mode:overlay;
    }

    .wrap{
      max-width:1200px;
      margin:0 auto;
      padding:22px 16px 28px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:14px 14px;
      border:1px solid var(--line);
      border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(8,12,11,.92), rgba(6,8,8,.85));
      box-shadow: var(--shadow2);
    }

    .brand{
      display:flex; align-items:center; gap:12px;
      min-width:0;
    }

    .logo{
      width:38px; height:38px;
      border-radius:12px;
      border:1px solid rgba(0,255,178,.25);
      background:
        radial-gradient(16px 16px at 30% 30%, rgba(0,255,178,.35), transparent 60%),
        radial-gradient(16px 16px at 70% 70%, rgba(0,201,133,.25), transparent 60%),
        linear-gradient(180deg, rgba(0,255,178,.10), rgba(0,0,0,0));
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
    }
    .logo:after{
      content:"";
      position:absolute; inset:-40%;
      background: linear-gradient(90deg, transparent 30%, rgba(0,255,178,.20) 50%, transparent 70%);
      transform: rotate(35deg);
      animation: sheen 3.2s linear infinite;
    }
    @keyframes sheen{
      0%{ transform: translateX(-45%) rotate(35deg); opacity:.0; }
      15%{ opacity:.85; }
      55%{ opacity:.85; }
      100%{ transform: translateX(55%) rotate(35deg); opacity:.0; }
    }

    .title{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .title h1{
      margin:0;
      font-family: Orbitron, monospace;
      font-weight:800;
      letter-spacing:2px;
      font-size:18px;
      color:var(--accent);
      text-shadow: 0 0 14px rgba(0,255,178,.15);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .title .sub{
      font-family: Orbitron, monospace;
      font-size:12px;
      color:rgba(215,255,239,.75);
      letter-spacing:1.4px;
    }

    .pillrow{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .pill{
      border:1px solid rgba(0,255,178,.22);
      background: rgba(0,0,0,.25);
      padding:8px 10px;
      border-radius:999px;
      box-shadow: var(--shadow);
      display:flex;
      align-items:center;
      gap:8px;
      max-width: 100%;
    }
    .pill b{
      font-family: Orbitron, monospace;
      font-size:11px;
      letter-spacing:1px;
      color:rgba(215,255,239,.85);
    }
    .dot{
      width:8px; height:8px; border-radius:50%;
      background: var(--warn);
      box-shadow: 0 0 12px rgba(255,209,102,.25);
    }
    .dot.ok{ background: var(--ok); box-shadow: 0 0 14px rgba(27,255,178,.25); }
    .dot.bad{ background: var(--bad); box-shadow: 0 0 14px rgba(255,77,109,.20); }

    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1.1fr 1fr 1fr;
      gap:14px;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      .pillrow{ justify-content:flex-start; }
    }

    .card{
      border:1px solid var(--line);
      border-radius:var(--radius);
      background: linear-gradient(180deg, rgba(9,12,12,.92), rgba(6,7,7,.86));
      box-shadow: var(--shadow2);
      overflow:hidden;
      position:relative;
    }
    .card:before{
      content:"";
      position:absolute; inset:0;
      pointer-events:none;
      background:
        radial-gradient(900px 240px at 20% 0%, rgba(0,255,178,.08), transparent 55%),
        radial-gradient(700px 220px at 100% 0%, rgba(0,201,133,.06), transparent 60%);
      opacity:.7;
    }
    .card .head{
      padding:14px 14px 10px;
      border-bottom:1px solid rgba(0,255,178,.12);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      position:relative;
      z-index:1;
    }
    .card .head h2{
      margin:0;
      font-family: Orbitron, monospace;
      font-weight:800;
      letter-spacing:1.6px;
      font-size:14px;
      color:rgba(215,255,239,.92);
    }
    .card .body{
      padding:14px;
      position:relative;
      z-index:1;
    }

    .kv{
      display:grid;
      grid-template-columns: 140px 1fr;
      gap:8px 10px;
      align-items:center;
      font-size:13px;
    }
    .kv .k{
      color:rgba(215,255,239,.70);
      font-family: Orbitron, monospace;
      letter-spacing:1px;
      font-size:12px;
    }
    .kv .v{
      font-weight:700;
      color:rgba(215,255,239,.95);
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      letter-spacing:.2px;
    }

    .btnrow{ display:flex; gap:10px; flex-wrap:wrap; }
    .btn{
      appearance:none;
      border:1px solid rgba(0,255,178,.22);
      background: linear-gradient(180deg, rgba(0,255,178,.18), rgba(0,255,178,.06));
      color: var(--accent);
      padding: 12px 14px;
      border-radius: 14px;
      font-family: Orbitron, monospace;
      font-weight:800;
      letter-spacing:1.2px;
      font-size:12px;
      cursor:pointer;
      box-shadow: var(--shadow);
      transition: transform .08s ease, filter .2s ease, border-color .2s ease;
      user-select:none;
    }
    .btn:hover{ filter:brightness(1.06); border-color: rgba(0,255,178,.35); }
    .btn:active{ transform: translateY(1px) scale(.99); }
    .btn.secondary{
      background: rgba(0,0,0,.30);
      color: rgba(215,255,239,.88);
    }
    .btn.danger{
      border-color: rgba(255,77,109,.22);
      background: linear-gradient(180deg, rgba(255,77,109,.14), rgba(255,77,109,.06));
      color: rgba(255,77,109,.95);
      box-shadow: 0 0 0.8px rgba(255,77,109,.25), 0 0 22px rgba(255,77,109,.08);
    }

    .tokenbox{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .input{
      flex:1 1 240px;
      min-width: 220px;
      border:1px solid rgba(0,255,178,.18);
      background: rgba(0,0,0,.30);
      color: rgba(215,255,239,.95);
      padding: 12px 12px;
      border-radius: 14px;
      outline:none;
      box-shadow: inset 0 0 0.8px rgba(0,255,178,.10);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
    }
    .input::placeholder{ color: rgba(215,255,239,.45); }

    .bigstatus{
      margin-top:14px;
      border:1px solid rgba(0,255,178,.16);
      border-radius: var(--radius);
      padding: 14px;
      background: rgba(0,0,0,.22);
      box-shadow: var(--shadow);
      font-family: Orbitron, monospace;
      letter-spacing:1.8px;
      text-transform:uppercase;
      text-align:center;
      color: rgba(215,255,239,.88);
    }
    .bigstatus.ok{ border-color: rgba(27,255,178,.22); color: rgba(27,255,178,.95); }
    .bigstatus.bad{ border-color: rgba(255,77,109,.22); color: rgba(255,77,109,.95); }
    .bigstatus.warn{ border-color: rgba(255,209,102,.22); color: rgba(255,209,102,.95); }

    .logs{
      grid-column: 1 / -1;
    }
    .tablewrap{
      border:1px solid rgba(0,255,178,.14);
      border-radius: 16px;
      overflow:hidden;
      background: rgba(0,0,0,.22);
      box-shadow: var(--shadow);
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
    }
    thead th{
      text-align:left;
      padding:12px 12px;
      font-family: Orbitron, monospace;
      letter-spacing:1px;
      color: rgba(215,255,239,.80);
      border-bottom: 1px solid rgba(0,255,178,.12);
      background: rgba(0,0,0,.25);
      position:sticky; top:0;
      z-index:2;
    }
    tbody td{
      padding:10px 12px;
      border-bottom: 1px solid rgba(0,255,178,.08);
      color: rgba(215,255,239,.88);
      vertical-align:top;
    }
    tbody tr:hover td{ background: rgba(0,255,178,.03); }
    .tag{
      display:inline-flex;
      align-items:center;
      gap:7px;
      padding: 6px 10px;
      border-radius:999px;
      border:1px solid rgba(0,255,178,.14);
      background: rgba(0,0,0,.18);
      font-family: Orbitron, monospace;
      font-size:11px;
      letter-spacing:.8px;
      white-space:nowrap;
    }
    .tag.ok{ border-color: rgba(27,255,178,.18); color: rgba(27,255,178,.92); }
    .tag.warn{ border-color: rgba(255,209,102,.18); color: rgba(255,209,102,.92); }
    .tag.bad{ border-color: rgba(255,77,109,.18); color: rgba(255,77,109,.92); }

    .nodes{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .node{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 12px 12px;
      border-radius: 16px;
      border:1px solid rgba(0,255,178,.14);
      background: rgba(0,0,0,.22);
      box-shadow: var(--shadow);
    }
    .node .left{
      display:flex; flex-direction:column; gap:4px; min-width:0;
    }
    .node .name{
      font-family: Orbitron, monospace;
      letter-spacing:1px;
      font-weight:800;
      font-size:12px;
      color: rgba(215,255,239,.92);
    }
    .node .url{
      font-size:12px;
      color: rgba(215,255,239,.62);
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width: 70vw;
    }

    .footer{
      margin-top:14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 14px 14px;
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: rgba(0,0,0,.22);
      box-shadow: var(--shadow2);
      color: rgba(215,255,239,.62);
      font-size:12px;
    }
    .footer b{
      font-family: Orbitron, monospace;
      letter-spacing:1px;
      color: rgba(215,255,239,.82);
      font-weight:800;
    }
    a{ color: var(--accent); text-decoration:none; }
    a:hover{ text-decoration:underline; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div class="title">
          <h1>CONSIA ‚Äî OWNER GLOBAL CONTROL</h1>
          <div class="sub">CORE ‚Ä¢ AUTO-DECISION ‚Ä¢ LOGS ‚Ä¢ NODES ‚Ä¢ VAULT</div>
        </div>
      </div>
      <div class="pillrow">
        <div class="pill"><span id="dotApi" class="dot"></span><b id="pillApi">API: ‚Ä¶</b></div>
        <div class="pill"><span id="dotDo" class="dot"></span><b id="pillDo">DO: ‚Ä¶</b></div>
        <div class="pill"><span id="dotGlobal" class="dot"></span><b id="pillGlobal">GLOBAL: ‚Ä¶</b></div>
      </div>
    </div>

    <div class="grid">
      <!-- OWNER -->
      <div class="card">
        <div class="head">
          <h2>OWNER ACCESS</h2>
          <span class="tag" id="tagAuth">LOCKED</span>
        </div>
        <div class="body">
          <div class="tokenbox">
            <input id="ownerToken" class="input" placeholder="Peg√° OWNER_TOKEN aqu√≠ (se guarda en este dispositivo)" />
            <button class="btn" id="btnSaveToken">SAVE</button>
            <button class="btn secondary" id="btnClearToken">CLEAR</button>
          </div>
          <div style="height:12px"></div>
          <div class="btnrow">
            <button class="btn" id="btnRefresh">REFRESH ALL</button>
            <button class="btn secondary" id="btnOpenApi">OPEN API</button>
          </div>
        </div>
      </div>

      <!-- STATUS -->
      <div class="card">
        <div class="head">
          <h2>STATUS</h2>
          <span class="tag" id="tagStatus">LOADING</span>
        </div>
        <div class="body">
          <div class="kv">
            <div class="k">SERVICE</div><div class="v mono" id="s_service">‚Ä¶</div>
            <div class="k">VERSION</div><div class="v mono" id="s_version">‚Ä¶</div>
            <div class="k">STATE</div><div class="v mono" id="s_state">‚Ä¶</div>
            <div class="k">CORE</div><div class="v mono" id="s_core">‚Ä¶</div>
            <div class="k">AI</div><div class="v mono" id="s_ai">‚Ä¶</div>
            <div class="k">LOGS</div><div class="v mono" id="s_logs">‚Ä¶</div>
            <div class="k">TS</div><div class="v mono" id="s_ts">‚Ä¶</div>
          </div>
          <div class="bigstatus" id="bigGlobal">GLOBAL STATUS: ‚Ä¶</div>
        </div>
      </div>

      <!-- AI DECISION -->
      <div class="card">
        <div class="head">
          <h2>AUTO-DECISION</h2>
          <span class="tag" id="tagDecision">READY</span>
        </div>
        <div class="body">
          <div class="btnrow">
            <button class="btn" id="btnBest">EXECUTE GLOBAL BEST ACTION</button>
            <button class="btn secondary" id="btnOwnerPing">OWNER PING</button>
          </div>

          <div style="height:12px"></div>

          <div class="kv">
            <div class="k">LAST ACTION</div><div class="v mono" id="d_action">‚Ä¶</div>
            <div class="k">RESULT</div><div class="v mono" id="d_result">‚Ä¶</div>
          </div>

          <div style="height:12px"></div>

          <div class="btnrow">
            <button class="btn danger" id="btnVaultLock">VAULT LOCK</button>
            <button class="btn secondary" id="btnVaultRotate">VAULT ROTATE (MARK)</button>
          </div>
        </div>
      </div>

      <!-- NODES -->
      <div class="card">
        <div class="head">
          <h2>MULTI-NODE STATUS MAP</h2>
          <span class="tag" id="tagNodes">SYNC</span>
        </div>
        <div class="body">
          <div class="nodes" id="nodes"></div>
        </div>
      </div>

      <!-- VAULT -->
      <div class="card">
        <div class="head">
          <h2>SECURITY VAULT</h2>
          <span class="tag" id="tagVault">CHECK</span>
        </div>
        <div class="body">
          <div class="kv">
            <div class="k">LOCKED</div><div class="v mono" id="v_locked">‚Ä¶</div>
            <div class="k">ROTATIONS</div><div class="v mono" id="v_rot">‚Ä¶</div>
            <div class="k">LAST ROT</div><div class="v mono" id="v_last">‚Ä¶</div>
          </div>
        </div>
      </div>

      <!-- LOGS -->
      <div class="card logs">
        <div class="head">
          <h2>GLOBAL LOGS (DO)</h2>
          <div class="btnrow">
            <button class="btn secondary" id="btnLogs">REFRESH LOGS</button>
            <button class="btn secondary" id="btnAuto">AUTO: OFF</button>
          </div>
        </div>
        <div class="body">
          <div class="tablewrap" style="max-height: 420px; overflow:auto;">
            <table>
              <thead>
                <tr>
                  <th style="width:130px">TS</th>
                  <th style="width:110px">LEVEL</th>
                  <th style="width:180px">ACTION</th>
                  <th style="width:160px">DEVICE</th>
                  <th>META</th>
                </tr>
              </thead>
              <tbody id="logRows"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="footer">
      <div><b>CONSIA</b> ‚Ä¢ Owner-Only Control Plane ‚Ä¢ Fail-Closed</div>
      <div class="mono">API_BASE: <span id="apiBaseTxt">‚Ä¶</span></div>
    </div>
  </div>

  <script>
    // =========================
    // CONFIG
    // =========================
    const API_BASE = "https://api.consia.world"; // <-- TOP: dejalo as√≠
    const LS_TOKEN_KEY = "CONSIA_OWNER_TOKEN_V1";

    // nodes fallback (si el API no trae /owner/nodes)
    const DEFAULT_NODES = [
      { name: "API", url: "https://api.consia.world" },
      { name: "API (workers.dev)", url: "https://consia-api.jbdkb7r94d.workers.dev" }
    ];

    // =========================
    // DOM
    // =========================
    const $ = (id) => document.getElementById(id);

    const dotApi = $("dotApi");
    const dotDo = $("dotDo");
    const dotGlobal = $("dotGlobal");
    const pillApi = $("pillApi");
    const pillDo = $("pillDo");
    const pillGlobal = $("pillGlobal");

    const tagAuth = $("tagAuth");
    const tagStatus = $("tagStatus");
    const tagDecision = $("tagDecision");
    const tagNodes = $("tagNodes");
    const tagVault = $("tagVault");

    const ownerToken = $("ownerToken");
    const apiBaseTxt = $("apiBaseTxt");

    const s_service = $("s_service");
    const s_version = $("s_version");
    const s_state = $("s_state");
    const s_core = $("s_core");
    const s_ai = $("s_ai");
    const s_logs = $("s_logs");
    const s_ts = $("s_ts");
    const bigGlobal = $("bigGlobal");

    const d_action = $("d_action");
    const d_result = $("d_result");

    const v_locked = $("v_locked");
    const v_rot = $("v_rot");
    const v_last = $("v_last");

    const nodesWrap = $("nodes");
    const logRows = $("logRows");

    apiBaseTxt.textContent = API_BASE;

    // =========================
    // AUTH
    // =========================
    function getToken(){
      return (localStorage.getItem(LS_TOKEN_KEY) || "").trim();
    }
    function setToken(t){
      localStorage.setItem(LS_TOKEN_KEY, (t || "").trim());
    }
    function clearToken(){
      localStorage.removeItem(LS_TOKEN_KEY);
    }
    function isAuthed(){
      return !!getToken();
    }
    function paintAuth(){
      const ok = isAuthed();
      tagAuth.className = "tag " + (ok ? "ok" : "bad");
      tagAuth.textContent = ok ? "UNLOCKED" : "LOCKED";
    }

    // =========================
    // HTTP
    // =========================
    async function api(path, opts={}){
      const headers = Object.assign(
        { "Content-Type": "application/json" },
        opts.headers || {}
      );

      const t = getToken();
      if (t) headers["Authorization"] = "Bearer " + t;

      const res = await fetch(API_BASE + path, Object.assign({}, opts, { headers }));
      const text = await res.text();
      let data = null;
      try{ data = JSON.parse(text); } catch(e){ data = { raw: text }; }
      if (!res.ok){
        const err = new Error("HTTP " + res.status);
        err.status = res.status;
        err.data = data;
        throw err;
      }
      return data;
    }

    async function apiTry(path, opts){
      try{ return await api(path, opts); }
      catch(e){ return { ok:false, error: e.status ? ("HTTP "+e.status) : "ERR", detail: e.data || e.message }; }
    }

    function setDot(el, state){
      el.classList.remove("ok","bad");
      if (state === "ok") el.classList.add("ok");
      if (state === "bad") el.classList.add("bad");
    }

    function setTag(el, type, text){
      el.className = "tag " + (type || "");
      el.textContent = text || "";
    }

    function tsFmt(ts){
      if (!ts) return "‚Äî";
      const d = new Date(ts);
      const pad = (n)=> String(n).padStart(2,"0");
      return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }

    // =========================
    // STATUS
    // =========================
    let lastStatus = null;

    async function refreshStatus(){
      setTag(tagStatus, "warn", "LOADING");
      pillApi.textContent = "API: ‚Ä¶";
      setDot(dotApi, "warn");

      const st = await apiTry("/");

      // API ONLINE/OFFLINE
      const apiOnline = !!st && st.ok === true;
      setDot(dotApi, apiOnline ? "ok" : "bad");
      pillApi.textContent = "API: " + (apiOnline ? "ONLINE" : "OFFLINE");

      if (!apiOnline){
        setTag(tagStatus, "bad", "OFFLINE");
        s_service.textContent = "‚Äî";
        s_version.textContent = "‚Äî";
        s_state.textContent = "‚Äî";
        s_core.textContent = "‚Äî";
        s_ai.textContent = "‚Äî";
        s_logs.textContent = "‚Äî";
        s_ts.textContent = "‚Äî";
        bigGlobal.className = "bigstatus bad";
        bigGlobal.textContent = "GLOBAL STATUS: DEGRADED";
        setDot(dotGlobal, "bad");
        pillGlobal.textContent = "GLOBAL: DEGRADED";
        return;
      }

      lastStatus = st;

      s_service.textContent = st.service || "CONSIA";
      s_version.textContent = st.version || "‚Äî";
      s_state.textContent = st.state || st.status || "‚Äî";
      s_core.textContent = st.core || "‚Äî";
      s_ai.textContent = st.ai || "‚Äî";
      s_logs.textContent = (st.log_count ?? "‚Äî");
      s_ts.textContent = String(st.ts ?? "‚Äî");

      // DO assumed ok if log_count exists or core online
      const doOk = (st.core && String(st.core).toUpperCase().includes("ON")) || (typeof st.log_count === "number");
      setDot(dotDo, doOk ? "ok" : "warn");
      pillDo.textContent = "DO: " + (doOk ? "ACTIVE" : "CHECK");

      const globalText = (st.global || st.status || "UNKNOWN").toString();
      const isTop = globalText.toUpperCase().includes("TOP 1") || globalText.includes("üåç");
      const globalOk = isTop && apiOnline;

      setDot(dotGlobal, globalOk ? "ok" : "warn");
      pillGlobal.textContent = "GLOBAL: " + (globalOk ? "TOP 1 ACTIVE" : "DEGRADED");

      bigGlobal.className = "bigstatus " + (globalOk ? "ok" : "warn");
      bigGlobal.textContent = "GLOBAL STATUS: " + (globalOk ? "TOP 1 GLOBAL ACTIVE üåç" : "DEGRADED");

      setTag(tagStatus, globalOk ? "ok" : "warn", globalOk ? "TOP 1 ACTIVE" : "DEGRADED");
    }

    // =========================
    // OWNER + ACTIONS
    // =========================
    async function ownerPing(){
      setTag(tagDecision, "warn", "PING‚Ä¶");
      const r = await apiTry("/owner");
      const ok = r && r.ok === true;
      setTag(tagDecision, ok ? "ok" : "bad", ok ? "OWNER OK" : "UNAUTHORIZED");
      d_action.textContent = "owner_ping";
      d_result.textContent = ok ? "ACCESS GRANTED" : JSON.stringify(r).slice(0,160);
      return ok;
    }

    async function executeBest(){
      setTag(tagDecision, "warn", "EXECUTING‚Ä¶");
      d_action.textContent = "best_action";
      d_result.textContent = "‚Ä¶";

      // try multiple known endpoints (compat)
      let r = await apiTry("/owner/execute", {
        method:"POST",
        body: JSON.stringify({ action:"best" })
      });

      if (!r || r.ok !== true){
        r = await apiTry("/owner/ai/execute", {
          method:"POST",
          body: JSON.stringify({ action:"best" })
        });
      }
      if (!r || r.ok !== true){
        r = await apiTry("/owner/best", { method:"POST" });
      }

      const ok = r && r.ok === true;
      setTag(tagDecision, ok ? "ok" : "bad", ok ? "EXECUTED" : "FAILED");
      d_result.textContent = ok ? (r.result ? JSON.stringify(r.result) : "OK") : JSON.stringify(r).slice(0,220);

      // refresh after action
      await refreshStatus();
      await refreshLogs();
      await refreshVault();
    }

    async function vaultLock(){
      setTag(tagVault, "warn", "LOCKING‚Ä¶");
      const r = await apiTry("/owner/vault/lock", { method:"POST" });
      const ok = r && r.ok === true;
      setTag(tagVault, ok ? "ok" : "bad", ok ? "LOCKED" : "FAILED");
      d_action.textContent = "vault_lock";
      d_result.textContent = ok ? "LOCKED" : JSON.stringify(r).slice(0,220);
      await refreshVault();
      await refreshLogs();
    }

    async function vaultRotate(){
      setTag(tagVault, "warn", "ROTATE‚Ä¶");
      const r = await apiTry("/owner/vault/rotate", { method:"POST" });
      const ok = r && r.ok === true;
      setTag(tagVault, ok ? "ok" : "bad", ok ? "ROTATED" : "FAILED");
      d_action.textContent = "vault_rotate";
      d_result.textContent = ok ? "MARK UPDATED" : JSON.stringify(r).slice(0,220);
      await refreshVault();
      await refreshLogs();
    }

    // =========================
    // LOGS
    // =========================
    function levelTag(level){
      const L = (level || "").toString().toUpperCase();
      if (L.includes("ERROR") || L.includes("CRIT")) return "bad";
      if (L.includes("WARN")) return "warn";
      return "ok";
    }

    function safeStr(x){
      if (x === null || x === undefined) return "‚Äî";
      if (typeof x === "string") return x;
      try{ return JSON.stringify(x); } catch(e){ return String(x); }
    }

    async function refreshLogs(){
      const r = await apiTry("/owner/logs?limit=80");
      logRows.innerHTML = "";

      if (!r || r.ok === false){
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="5" class="mono">NO LOGS / UNAUTHORIZED</td>`;
        logRows.appendChild(tr);
        return;
      }

      const rows = (r.logs || r.items || r.data || []);
      if (!rows.length){
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="5" class="mono">EMPTY</td>`;
        logRows.appendChild(tr);
        return;
      }

      for (const it of rows){
        const ts = it.ts ? tsFmt(it.ts) : (it.time ? tsFmt(it.time) : "‚Äî");
        const level = (it.level || it.lvl || "INFO").toString();
        const action = (it.action || it.event || "‚Äî").toString();
        const device = (it.device || it.dev || "‚Äî").toString();
        const meta = safeStr(it.meta || it.data || it.payload || null);

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="mono">${ts}</td>
          <td><span class="tag ${levelTag(level)}">${level.toUpperCase()}</span></td>
          <td class="mono">${action}</td>
          <td class="mono">${device}</td>
          <td class="mono" style="max-width:560px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" title="${meta.replaceAll('"','&quot;')}">${meta}</td>
        `;
        logRows.appendChild(tr);
      }
    }

    // =========================
    // NODES
    // =========================
    async function refreshNodes(){
      setTag(tagNodes, "warn", "CHECK‚Ä¶");
      let r = await apiTry("/owner/nodes");
      let nodes = null;

      if (r && r.ok !== false && (r.nodes || r.items)){
        nodes = r.nodes || r.items;
      } else {
        // fallback to default nodes
        nodes = DEFAULT_NODES;
      }

      nodesWrap.innerHTML = "";
      const checks = await Promise.all(nodes.map(async n=>{
        const url = n.url;
        try{
          const res = await fetch(url.replace(/\/$/,'') + "/");
          const ok = res.ok;
          return { ...n, ok };
        }catch(e){
          return { ...n, ok:false };
        }
      }));

      for (const n of checks){
        const el = document.createElement("div");
        el.className = "node";
        el.innerHTML = `
          <div class="left">
            <div class="name">${n.name || "NODE"}</div>
            <div class="url mono">${n.url || ""}</div>
          </div>
          <div class="tag ${n.ok ? "ok" : "bad"}">${n.ok ? "ONLINE" : "OFFLINE"}</div>
        `;
        nodesWrap.appendChild(el);
      }

      const onlineCount = checks.filter(x=>x.ok).length;
      setTag(tagNodes, onlineCount ? "ok" : "bad", `${onlineCount}/${checks.length} ONLINE`);
    }

    // =========================
    // VAULT
    // =========================
    async function refreshVault(){
      setTag(tagVault, "warn", "CHECK‚Ä¶");
      let r = await apiTry("/owner/vault/health");

      // compat fallback (si no existe)
      if (!r || r.ok === false){
        // try status-only storage keys from /owner (optional)
        r = await apiTry("/owner/vault");
      }

      if (!r || r.ok === false){
        v_locked.textContent = "‚Äî";
        v_rot.textContent = "‚Äî";
        v_last.textContent = "‚Äî";
        setTag(tagVault, "warn", "NO DATA");
        return;
      }

      v_locked.textContent = safeStr(r.locked ?? r.vault_locked ?? false);
      v_rot.textContent = safeStr(r.rotations ?? r.vault_rotations ?? 0);
      v_last.textContent = safeStr(r.last_rotation_ts ?? r.vault_last_rotation_ts ?? "‚Äî");

      const locked = (r.locked === true) || (r.vault_locked === true);
      setTag(tagVault, locked ? "warn" : "ok", locked ? "LOCKED" : "UNLOCKED");
    }

    // =========================
    // MASTER REFRESH
    // =========================
    let auto = false;
    let timer = null;

    async function refreshAll(){
      paintAuth();
      await refreshStatus();
      await refreshNodes();
      await refreshVault();
      if (isAuthed()) await refreshLogs();
    }

    function setAuto(on){
      auto = !!on;
      const btn = $("btnAuto");
      btn.textContent = "AUTO: " + (auto ? "ON" : "OFF");
      btn.className = "btn " + (auto ? "" : "secondary");

      if (timer) clearInterval(timer);
      if (auto){
        timer = setInterval(()=>{ refreshAll(); }, 6000);
      }
    }

    // =========================
    // EVENTS
    // =========================
    $("btnSaveToken").onclick = () => {
      setToken(ownerToken.value);
      ownerToken.value = getToken();
      paintAuth();
      refreshAll();
    };

    $("btnClearToken").onclick = () => {
      clearToken();
      ownerToken.value = "";
      paintAuth();
      refreshAll();
    };

    $("btnRefresh").onclick = () => refreshAll();
    $("btnOpenApi").onclick = () => window.open(API_BASE + "/", "_blank");

    $("btnOwnerPing").onclick = async () => {
      paintAuth();
      await ownerPing();
      await refreshStatus();
    };

    $("btnBest").onclick = async () => {
      paintAuth();
      if (!isAuthed()){
        setTag(tagDecision, "bad", "TOKEN REQUIRED");
        return;
      }
      await executeBest();
    };

    $("btnVaultLock").onclick = async () => {
      paintAuth();
      if (!isAuthed()){
        setTag(tagVault, "bad", "TOKEN REQUIRED");
        return;
      }
      await vaultLock();
    };

    $("btnVaultRotate").onclick = async () => {
      paintAuth();
      if (!isAuthed()){
        setTag(tagVault, "bad", "TOKEN REQUIRED");
        return;
      }
      await vaultRotate();
    };

    $("btnLogs").onclick = async () => {
      paintAuth();
      if (!isAuthed()){
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="5" class="mono">TOKEN REQUIRED</td>`;
        logRows.innerHTML = "";
        logRows.appendChild(tr);
        return;
      }
      await refreshLogs();
    };

    $("btnAuto").onclick = () => setAuto(!auto);

    // =========================
    // BOOT
    // =========================
    ownerToken.value = getToken();
    paintAuth();
    refreshAll();
    setAuto(false);
  </script>
</body>
</html>
