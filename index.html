<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#06080d"/>
  <title>CONSIA ‚àû</title>

  <style>
    :root{
      --bg:#06080d;
      --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.04);
      --stroke:rgba(255,255,255,.12);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.65);
      --good:#38f08f;
      --warn:#ffd56b;
      --bad:#ff6b6b;
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --r:18px;
      --r2:14px;
    }

    *{box-sizing:border-box}
    html,body{height:100%; margin:0; background:var(--bg); color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;}
    body{overflow:hidden}

    /* HERO AVATAR (no cortado) */
    .hero{
      position:fixed; inset:0;
      display:flex; flex-direction:column;
      background: radial-gradient(1200px 700px at 60% 20%, rgba(110,160,255,.08), transparent 60%),
                  radial-gradient(900px 600px at 20% 70%, rgba(70,255,190,.06), transparent 55%),
                  linear-gradient(180deg, #05070b 0%, #070a12 100%);
    }

    .topbar{
      position:absolute; left:0; right:0; top:0;
      padding: 14px 18px;
      display:flex; align-items:center; justify-content:space-between;
      z-index:30;
      pointer-events:none;
    }
    .brand{
      display:flex; gap:10px; align-items:center;
      pointer-events:auto;
    }
    .dot{width:10px; height:10px; border-radius:999px; background:var(--good); box-shadow:0 0 18px rgba(56,240,143,.55)}
    .name{font-weight:700; letter-spacing:.2px}
    .badge{
      pointer-events:auto;
      display:flex; align-items:center; gap:10px;
    }
    .pill{
      padding:8px 12px; border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      font-size:12px; color:var(--muted);
      backdrop-filter: blur(10px);
    }
    .pill strong{color:var(--text); font-weight:700}
    .pill.btn{cursor:pointer; user-select:none}
    .pill.btn:active{transform:translateY(1px)}

    /* Avatar video container */
    .avatarWrap{
      position:relative;
      flex: 1 1 auto;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 58px 14px 10px;
      min-height: 40vh;
      z-index:10;
    }
    .avatarFrame{
      position:relative;
      width:min(1100px, 98vw);
      aspect-ratio: 21/9;
      border-radius: 24px;
      overflow:hidden;
      box-shadow: var(--shadow);
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.25);
    }
    video#avatarVideo{
      position:absolute; inset:0;
      width:100%; height:100%;
      object-fit: cover; /* NO CORTA el contenedor, mantiene "cinematic cover" */
      transform: scale(1.02);
      filter: contrast(1.06) saturate(1.06) brightness(1.03);
    }
    /* Vignette + glow */
    .avatarFrame::after{
      content:"";
      position:absolute; inset:0;
      background: radial-gradient(800px 300px at 70% 20%, rgba(150,200,255,.14), transparent 55%),
                  radial-gradient(700px 280px at 30% 80%, rgba(70,255,190,.10), transparent 55%),
                  linear-gradient(180deg, rgba(0,0,0,.25), rgba(0,0,0,.55));
      pointer-events:none;
    }

    /* HUD hint */
    .hint{
      position:absolute;
      right:18px; bottom:16px;
      padding:10px 12px;
      border-radius:999px;
      background:rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.12);
      color:rgba(255,255,255,.82);
      font-size:13px;
      backdrop-filter: blur(10px);
      z-index:40;
    }

    /* Panel */
    .panel{
      position:relative;
      flex: 0 0 auto;
      padding: 10px 14px 16px;
      z-index:20;
    }

    .row{
      display:flex; flex-wrap:wrap; gap:10px;
      align-items:center;
      justify-content:flex-start;
      margin: 10px auto 0;
      width:min(1100px, 98vw);
    }

    .btn{
      display:inline-flex; align-items:center; gap:10px;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      color: var(--text);
      cursor:pointer;
      user-select:none;
      backdrop-filter: blur(10px);
      font-size: 13px;
    }
    .btn:active{transform: translateY(1px)}
    .btn.small{padding:8px 10px; font-size:12px}
    .btn.primary{
      background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
      border-color: rgba(255,255,255,.18);
    }

    .status{
      display:flex; gap:10px; align-items:center;
      margin-left:auto;
    }
    .led{
      width:9px; height:9px; border-radius:999px;
      background: var(--bad);
      box-shadow: 0 0 16px rgba(255,107,107,.45);
    }
    .led.on{background:var(--good); box-shadow:0 0 18px rgba(56,240,143,.55)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}

    /* Chat */
    .chat{
      width:min(1100px, 98vw);
      margin: 10px auto 0;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      backdrop-filter: blur(10px);
      box-shadow: 0 14px 50px rgba(0,0,0,.45);
      overflow:hidden;
    }
    .log{
      padding: 14px;
      max-height: 30vh;
      overflow:auto;
    }
    .msg{
      padding: 10px 12px;
      border-radius: 14px;
      margin: 10px 0;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      color: rgba(255,255,255,.88);
      line-height:1.35;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .msg.you{background: rgba(20,60,120,.22)}
    .msg.ai{background: rgba(15,80,60,.20)}
    .msg.sys{background: rgba(255,255,255,.04); color: rgba(255,255,255,.78)}
    .inputbar{
      display:flex; gap:10px; align-items:center;
      padding: 12px;
      border-top:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
    }
    .inputbar input{
      flex:1;
      padding: 12px 14px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.25);
      color: rgba(255,255,255,.92);
      outline:none;
      font-size:14px;
    }
    .inputbar button{
      padding: 12px 14px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.07);
      color: rgba(255,255,255,.92);
      cursor:pointer;
    }
    .inputbar button:active{transform: translateY(1px)}

    /* Hidden inputs */
    input[type=file]{display:none}

    @media (max-width: 820px){
      .avatarFrame{aspect-ratio: 16/10;}
      .log{max-height: 32vh;}
    }
  </style>
</head>

<body>
  <div class="hero">
    <div class="topbar">
      <div class="brand">
        <div class="dot"></div>
        <div class="name">CONSIA ‚àû</div>
      </div>
      <div class="badge">
        <div class="pill"><strong id="netState">OFFLINE</strong> ¬∑ <span id="rtState">auto</span></div>
        <div class="pill btn" id="btnTestApi">Test API</div>
      </div>
    </div>

    <div class="avatarWrap">
      <div class="avatarFrame">
        <!-- AVATAR: us√° tu archivo avatar.mp4 en el mismo repo -->
        <video id="avatarVideo" autoplay playsinline muted loop preload="auto">
          <source src="avatar.mp4" type="video/mp4"/>
        </video>
        <div class="hint">Dec√≠ <b>"Hola CONSIA"</b> o escrib√≠ abajo. (voz si el navegador soporta)</div>
      </div>
    </div>

    <div class="panel">
      <div class="row">
        <div class="btn primary" data-prompt="Guiame: dame 3 opciones y pedime lo m√≠nimo en 1 sola pregunta. Luego esper√° mi 1 frase y ejecut√°.">üß≠ Guiame (3 opciones)</div>
        <div class="btn" data-prompt="¬øQu√© puede hacer CONSIA hoy? List√° funciones reales disponibles (texto/voz/realtime/archivos/c√°mara) y pedime lo m√≠nimo.">üß† ¬øQu√© puede hacer?</div>
        <div class="btn" data-prompt="Hiperrealismo: dame 3 opciones (Imagen/Video/Avatar). Pedime lo m√≠nimo en 1 sola pregunta. Luego esper√° mi 1 frase y ejecut√°.">üñºÔ∏è Hiperrealismo</div>

        <div class="btn" id="btnVoice">üéôÔ∏è Voz</div>
        <div class="btn" id="btnCam">üì∑ C√°mara</div>
        <div class="btn" id="btnAscend" data-prompt="ASCEND: modo ultra. Respuestas cortas, plan inmediato y checklist.">‚ö° ASCEND</div>

        <label class="btn small" for="fileInput">üìé Subir archivo</label>
        <div class="btn small" id="btnFrontCam">ü§≥ C√°mara (frontal)</div>
        <div class="btn small" id="btnSpeak">üó£Ô∏è Hablar</div>
        <div class="btn small" id="btnRead">üëÇ Leer</div>
        <div class="btn small" id="btnClear">üßπ Limpiar</div>
        <div class="btn small" id="btnStopVoice">‚õî Stop voz</div>

        <div class="status">
          <div class="led" id="led"></div>
          <div class="mono" style="font-size:12px; color:rgba(255,255,255,.65)">API: <span id="apiHost">api.consia.world</span></div>
        </div>
      </div>

      <div class="chat">
        <div class="log" id="log"></div>
        <div class="inputbar">
          <input id="textInput" placeholder='Dec√≠ lo que quer√©s (o escrib√≠ ".")' />
          <button id="sendBtn">Enviar</button>
        </div>
        <input id="fileInput" type="file" multiple />
      </div>
    </div>
  </div>

  <script>
    // ====== CONFIG ======
    const API_URL = "https://api.consia.world/ask"; // tu backend Worker
    const REALTIME_AUTO = true;                     // UI: muestra auto
    const DEFAULT_LANG = "ES";
    const MAX_ATTACH = 6;

    // ====== STATE ======
    const $ = (id)=>document.getElementById(id);
    const logEl = $("log");
    const led = $("led");
    const netState = $("netState");
    const rtState = $("rtState");
    const apiHost = $("apiHost");
    apiHost.textContent = (new URL(API_URL)).host;

    let mediaStream = null;
    let lastUtter = null;
    let recognizing = false;
    let recognition = null;
    let lastCaptured = null; // {type, dataUrl}

    // ====== UI HELPERS ======
    function addMsg(kind, text){
      const div = document.createElement("div");
      div.className = "msg " + kind;
      div.textContent = text;
      logEl.appendChild(div);
      logEl.scrollTop = logEl.scrollHeight;
    }
    function setOnline(on){
      led.classList.toggle("on", !!on);
      netState.textContent = on ? "ONLINE" : "OFFLINE";
    }

    // ====== VOICE (STT/TTS) ======
    function canSTT(){
      return ("webkitSpeechRecognition" in window) || ("SpeechRecognition" in window);
    }
    function canTTS(){
      return "speechSynthesis" in window;
    }

    function stopTTS(){
      if (!canTTS()) return;
      speechSynthesis.cancel();
    }

    function speak(text){
      if (!canTTS()) return;
      stopTTS();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = "es-ES";
      u.rate = 1.0;
      u.pitch = 1.0;
      lastUtter = u;
      speechSynthesis.speak(u);
    }

    function initSTT(){
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) return null;
      const r = new SR();
      r.lang = "es-ES";
      r.continuous = false;
      r.interimResults = false;
      r.onstart = ()=>{ recognizing=true; addMsg("sys","Voz: escuchando‚Ä¶"); };
      r.onend = ()=>{ recognizing=false; };
      r.onerror = (e)=>{ recognizing=false; addMsg("sys","Voz error: " + (e?.error||"")); };
      r.onresult = (e)=>{
        const t = e.results?.[0]?.[0]?.transcript || "";
        if (t.trim()){
          $("textInput").value = t.trim();
          sendText(t.trim(), {speakBack:true});
        }
      };
      return r;
    }

    recognition = initSTT();

    // ====== CAMERA ======
    async function stopCam(){
      if (mediaStream){
        mediaStream.getTracks().forEach(t=>t.stop());
        mediaStream = null;
      }
    }

    async function startCam(facingMode="user"){
      await stopCam();
      try{
        mediaStream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode },
          audio: false
        });
        addMsg("sys", "C√°mara activa (" + (facingMode==="user" ? "frontal" : "trasera") + "). Toc√° 'C√°mara' para capturar.");
        return true;
      }catch(e){
        addMsg("sys","C√°mara bloqueada/no disponible. Permit√≠ acceso en el navegador.");
        return false;
      }
    }

    async function captureFrame(){
      if (!mediaStream) {
        addMsg("sys","Primero activ√° c√°mara.");
        return null;
      }
      const track = mediaStream.getVideoTracks()[0];
      const settings = track.getSettings();
      const w = settings.width || 1280;
      const h = settings.height || 720;

      const video = document.createElement("video");
      video.srcObject = mediaStream;
      video.muted = true;
      await video.play();

      const canvas = document.createElement("canvas");
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(video, 0, 0, w, h);
      const dataUrl = canvas.toDataURL("image/jpeg", 0.92);
      lastCaptured = { type:"image/jpeg", dataUrl };
      addMsg("sys","Captura lista. Ahora ped√≠ 'Hiperrealismo' o escrib√≠ qu√© quer√©s hacer con esta imagen.");
      video.pause();
      return lastCaptured;
    }

    // ====== FILES ======
    async function fileToDataUrl(file){
      return new Promise((resolve,reject)=>{
        const r = new FileReader();
        r.onload = ()=>resolve(String(r.result||""));
        r.onerror = reject;
        r.readAsDataURL(file);
      });
    }

    async function collectAttachments(){
      const files = $("fileInput").files;
      const list = [];
      if (files && files.length){
        const max = Math.min(files.length, MAX_ATTACH);
        for (let i=0;i<max;i++){
          const f = files[i];
          const dataUrl = await fileToDataUrl(f);
          list.push({ name:f.name, type:f.type||"application/octet-stream", dataUrl });
        }
      }
      if (lastCaptured) list.push({ name:"camera.jpg", type:lastCaptured.type, dataUrl:lastCaptured.dataUrl });
      return list;
    }

    // ====== API ======
    async function sendText(text, {speakBack=false} = {}){
      addMsg("you", text);

      const attachments = await collectAttachments();
      if (attachments.length){
        addMsg("sys","Adjuntos: " + attachments.length + " (se env√≠an al backend /ask si lo soporta).");
      }

      try{
        setOnline(true);
        const res = await fetch(API_URL, {
          method:"POST",
          headers:{ "content-type":"application/json" },
          body: JSON.stringify({
            message: text,
            lang: DEFAULT_LANG,
            realtime: REALTIME_AUTO,
            attachments
          })
        });
        const data = await res.json().catch(()=>null);
        const reply = data?.reply ?? JSON.stringify(data, null, 2);
        addMsg("ai", reply);
        if (speakBack) speak(reply);
      }catch(e){
        setOnline(false);
        addMsg("sys","API error: " + (e?.message||String(e)));
      }
    }

    // ====== BUTTONS ======
    document.querySelectorAll("[data-prompt]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const p = btn.getAttribute("data-prompt");
        $("textInput").value = p;
        sendText(p, {speakBack:false});
      });
    });

    $("sendBtn").addEventListener("click", ()=>{
      const t = $("textInput").value.trim();
      if (!t) return;
      $("textInput").value = "";
      sendText(t, {speakBack:false});
    });

    $("textInput").addEventListener("keydown", (e)=>{
      if (e.key === "Enter"){
        e.preventDefault();
        $("sendBtn").click();
      }
    });

    $("btnTestApi").addEventListener("click", async ()=>{
      try{
        const res = await fetch(API_URL.replace(/\/ask$/,"/"));
        const t = await res.text();
        addMsg("sys","Test API: " + t.slice(0, 300));
        setOnline(res.ok);
      }catch(e){
        setOnline(false);
        addMsg("sys","Test API error: " + (e?.message||String(e)));
      }
    });

    $("btnVoice").addEventListener("click", ()=>{
      if (!canSTT()){
        addMsg("sys","Este navegador no soporta STT (SpeechRecognition). Us√° escribir o iOS Safari con permisos.");
        return;
      }
      if (!recognition) recognition = initSTT();
      try{ recognition.start(); }catch(_){}
    });

    $("btnSpeak").addEventListener("click", ()=> $("btnVoice").click());

    $("btnRead").addEventListener("click", ()=>{
      addMsg("sys","Lectura: activa. (CONSIA responde por texto; si quer√©s voz, toc√° Voz y luego habl√°)");
    });

    $("btnStopVoice").addEventListener("click", ()=>{
      stopTTS();
      addMsg("sys","Voz detenida.");
    });

    $("btnCam").addEventListener("click", async ()=>{
      // Si no hay stream, inicia trasera por defecto
      if (!mediaStream){
        await startCam("environment");
        return;
      }
      // si hay stream -> capturar frame
      await captureFrame();
    });

    $("btnFrontCam").addEventListener("click", async ()=>{
      await startCam("user"); // FRONTAL
    });

    $("btnClear").addEventListener("click", ()=>{
      logEl.innerHTML = "";
      $("fileInput").value = "";
      lastCaptured = null;
      addMsg("sys","CONSIA UI HOTFIX activo. Input siempre visible. Idioma ES.");
    });

    // ====== BOOT ======
    addMsg("sys","CONSIA UI HOTFIX activo. Input siempre visible. Idioma ES.");
    // Auto test light
    (async ()=>{
      try{
        const res = await fetch(API_URL.replace(/\/ask$/,"/"));
        setOnline(res.ok);
        rtState.textContent = REALTIME_AUTO ? "auto" : "off";
        if (res.ok) addMsg("sys","Realtime conectado.");
      }catch(e){
        setOnline(false);
        rtState.textContent = "auto";
        addMsg("sys","Realtime desconectado.");
      }
    })();
  </script>
</body>
</html>
