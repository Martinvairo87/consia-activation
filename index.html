<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#000000" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="CONSIA" />
  <title>CONSIA</title>

  <link rel="manifest" href="./manifest.webmanifest" />

  <style>
    :root{
      --bg:#000;
      --glass:rgba(10,14,18,.58);
      --glass2:rgba(10,14,18,.35);
      --line:rgba(255,255,255,.12);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.62);
      --accent:rgba(255,255,255,.88);
      --shadow: 0 20px 70px rgba(0,0,0,.55);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%; margin:0; background:var(--bg); color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;}
    body{overflow:hidden}

    /* Fullscreen stage */
    .stage{
      position:fixed; inset:0;
      display:flex; align-items:center; justify-content:center;
      background:#000;
    }

    /* Video avatar fullscreen cover */
    video#avatar{
      position:absolute; inset:0;
      width:100%; height:100%;
      object-fit:cover; /* <- se adapta al dispositivo */
      object-position:center;
      background:#000;
      filter:contrast(1.05) saturate(1.03);
    }

    /* Subtle vignette */
    .vignette{
      position:absolute; inset:0;
      background: radial-gradient(ellipse at center, rgba(0,0,0,0) 0%, rgba(0,0,0,.35) 70%, rgba(0,0,0,.75) 100%);
      pointer-events:none;
    }

    /* Splash */
    .splash{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      background:#000;
      z-index:5;
      opacity:1;
      transition:opacity .6s ease;
    }
    .splash.hidden{opacity:0; pointer-events:none}
    .logo{
      letter-spacing:.45em;
      font-weight:300;
      font-size:18px;
      color:rgba(255,255,255,.75);
      text-transform:uppercase;
    }

    /* HUD */
    .hud{
      position:absolute;
      right: min(26px, env(safe-area-inset-right));
      bottom: calc(min(26px, env(safe-area-inset-bottom)) + 10px);
      width:min(520px, calc(100vw - 28px));
      z-index:10;
      background: linear-gradient(180deg, var(--glass), var(--glass2));
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(18px);
      overflow:hidden;
    }

    .hudHeader{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      padding:12px 12px;
      border-bottom:1px solid var(--line);
    }
    .title{
      display:flex; flex-direction:column; gap:2px;
      min-width:0;
    }
    .title strong{
      font-size:12px; letter-spacing:.12em; font-weight:600;
      color:rgba(255,255,255,.86);
      text-transform:uppercase;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .title span{
      font-size:12px; color:var(--muted);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    .headerActions{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
    }

    .pill{
      border:1px solid var(--line);
      background:rgba(0,0,0,.25);
      color:rgba(255,255,255,.88);
      padding:8px 10px;
      border-radius:12px;
      font-size:12px;
      cursor:pointer;
      user-select:none;
    }
    .pill:active{transform:scale(.98)}
    .pill.on{border-color:rgba(255,255,255,.32)}
    select.pill{
      appearance:none;
      padding-right:28px;
      background-image:
        linear-gradient(45deg, transparent 50%, rgba(255,255,255,.6) 50%),
        linear-gradient(135deg, rgba(255,255,255,.6) 50%, transparent 50%);
      background-position:
        calc(100% - 16px) 50%,
        calc(100% - 11px) 50%;
      background-size:5px 5px, 5px 5px;
      background-repeat:no-repeat;
    }

    .chat{
      padding:12px;
      display:flex; flex-direction:column; gap:10px;
    }
    .bubble{
      border:1px solid var(--line);
      background:rgba(0,0,0,.22);
      border-radius:14px;
      padding:10px 12px;
      font-size:14px;
      line-height:1.35;
      color:rgba(255,255,255,.9);
    }
    .bubble.muted{color:var(--muted); font-size:13px}
    .row{
      display:flex; gap:10px;
    }
    .input{
      flex:1;
      border:1px solid var(--line);
      background:rgba(0,0,0,.28);
      color:rgba(255,255,255,.92);
      border-radius:14px;
      padding:12px 12px;
      outline:none;
      font-size:14px;
    }
    .send{
      width:44px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.08);
      cursor:pointer;
      color:rgba(255,255,255,.9);
      font-size:18px;
    }
    .send:active{transform:scale(.98)}

    .footer{
      padding:10px 12px;
      border-top:1px solid var(--line);
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      color:var(--muted);
      font-size:12px;
    }
    .toggles{display:flex; gap:8px; flex-wrap:wrap}
    .status{white-space:nowrap}

    /* Mobile tweaks */
    @media (max-width:520px){
      .hud{right:12px; bottom:12px; width: calc(100vw - 24px);}
    }
  </style>
</head>

<body>
  <div class="stage">
    <video id="avatar" autoplay playsinline muted loop preload="auto">
      <source src="./avatar.mp4" type="video/mp4" />
    </video>
    <div class="vignette"></div>

    <div id="splash" class="splash">
      <div class="logo">CONSIA</div>
    </div>

    <div class="hud">
      <div class="hudHeader">
        <div class="title">
          <strong>CONSIA</strong>
          <span id="subtitle">voz natural ¬∑ multi-idioma (idioma fijo)</span>
        </div>

        <div class="headerActions">
          <select id="langSelect" class="pill" title="Idioma (fijo)">
            <option value="es">ES</option>
            <option value="en">EN</option>
            <option value="pt">PT</option>
            <option value="it">IT</option>
            <option value="fr">FR</option>
            <option value="de">DE</option>
          </select>

          <button id="teleportBtn" class="pill">Teleport</button>
          <button id="resetBtn" class="pill">Reset</button>
        </div>
      </div>

      <div class="chat">
        <div id="consiaMsg" class="bubble muted">Listo. Pod√©s hablar (üéôÔ∏è) o escribir en el chat.</div>

        <div class="bubble">
          <div style="opacity:.7;font-size:12px;margin-bottom:6px;">Usuario</div>
          <div id="lastUser">‚Äî</div>
        </div>

        <div class="bubble">
          <div style="opacity:.7;font-size:12px;margin-bottom:6px;">CONSIA</div>
          <div id="lastConsia">‚Äî</div>
        </div>

        <div class="row">
          <input id="textInput" class="input" placeholder="Escrib√≠‚Ä¶" autocomplete="off" />
          <button id="micBtn" class="send" title="Hablar">üéôÔ∏è</button>
          <button id="sendBtn" class="send" title="Enviar">‚û§</button>
        </div>
      </div>

      <div class="footer">
        <div class="toggles">
          <button id="audioToggle" class="pill on">Audio: ON</button>
          <button id="voiceToggle" class="pill on">Voz: ON</button>
        </div>
        <div class="status" id="status">Estado: OK</div>
      </div>
    </div>
  </div>

<script>
(() => {
  // ===== CONFIG =====
  const API_BASE = "https://api.consia.world"; // tu Worker (api.consia.world)
  const ASK_URL  = API_BASE + "/ask";
  const TELEPORT_URL = API_BASE + "/teleport"; // opcional (si el worker lo soporta)
  const TTS_URL  = API_BASE + "/tts";

  // ===== STATE =====
  const LS_LANG_KEY = "consia_lang_fixed";
  const LS_AUDIO_KEY = "consia_audio_on";
  const LS_VOICE_KEY = "consia_voice_on";

  const splash = document.getElementById("splash");
  const avatar = document.getElementById("avatar");

  const consiaMsg = document.getElementById("consiaMsg");
  const lastUser = document.getElementById("lastUser");
  const lastConsia = document.getElementById("lastConsia");
  const statusEl = document.getElementById("status");

  const langSelect = document.getElementById("langSelect");
  const teleportBtn = document.getElementById("teleportBtn");
  const resetBtn = document.getElementById("resetBtn");

  const textInput = document.getElementById("textInput");
  const sendBtn = document.getElementById("sendBtn");
  const micBtn = document.getElementById("micBtn");

  const audioToggle = document.getElementById("audioToggle");
  const voiceToggle = document.getElementById("voiceToggle");

  let AUDIO_ON = (localStorage.getItem(LS_AUDIO_KEY) ?? "1") === "1";
  let VOICE_ON = (localStorage.getItem(LS_VOICE_KEY) ?? "1") === "1";
  let LANG = localStorage.getItem(LS_LANG_KEY) || "es"; // idioma fijo

  // ===== INIT UI =====
  langSelect.value = LANG;
  setToggleUI(audioToggle, AUDIO_ON, "Audio");
  setToggleUI(voiceToggle, VOICE_ON, "Voz");

  // Hide splash after first frame
  const hideSplash = () => splash.classList.add("hidden");
  setTimeout(hideSplash, 900);

  // Keep video playing on iOS
  avatar.addEventListener("canplay", () => {
    try { avatar.play().catch(()=>{}); } catch(e){}
  });

  // Register Service Worker
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./sw.js").catch(()=>{});
  }

  // ===== LANGUAGE LOCK (NO MIX) =====
  langSelect.addEventListener("change", () => {
    LANG = langSelect.value;
    localStorage.setItem(LS_LANG_KEY, LANG);
    toast(`Idioma fijo: ${LANG.toUpperCase()}`);
  });

  // ===== TOGGLES =====
  audioToggle.addEventListener("click", () => {
    AUDIO_ON = !AUDIO_ON;
    localStorage.setItem(LS_AUDIO_KEY, AUDIO_ON ? "1":"0");
    setToggleUI(audioToggle, AUDIO_ON, "Audio");
  });

  voiceToggle.addEventListener("click", () => {
    VOICE_ON = !VOICE_ON;
    localStorage.setItem(LS_VOICE_KEY, VOICE_ON ? "1":"0");
    setToggleUI(voiceToggle, VOICE_ON, "Voz");
  });

  // ===== CHAT SEND =====
  sendBtn.addEventListener("click", () => {
    const msg = (textInput.value || "").trim();
    if (!msg) return;
    textInput.value = "";
    runAsk(msg);
  });

  textInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") sendBtn.click();
  });

  // ===== VOICE INPUT =====
  let rec = null;
  let recognizing = false;

  micBtn.addEventListener("click", async () => {
    if (recognizing) {
      stopRec();
      return;
    }
    startRec();
  });

  function startRec() {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR) {
      toast("Voz no soportada en este navegador. Us√° chat.");
      return;
    }
    rec = new SR();
    rec.continuous = false;
    rec.interimResults = false;

    // Bloqueo fuerte de idioma (sin mezclar):
    rec.lang = mapLangToBCP47(LANG);

    recognizing = true;
    micBtn.textContent = "‚èπÔ∏è";
    status("Escuchando‚Ä¶");

    rec.onresult = (event) => {
      const txt = event.results?.[0]?.[0]?.transcript?.trim();
      if (txt) runAsk(txt);
    };
    rec.onerror = () => {
      status("Error mic");
      stopRec();
    };
    rec.onend = () => {
      stopRec();
    };
    try { rec.start(); } catch(e){ stopRec(); }
  }

  function stopRec() {
    recognizing = false;
    micBtn.textContent = "üéôÔ∏è";
    status("OK");
    try { rec && rec.stop(); } catch(e){}
    rec = null;
  }

  // ===== TELEPORT (simple UI trigger) =====
  teleportBtn.addEventListener("click", async () => {
    // UX: el usuario describe el nuevo fondo/escena, CONSIA responde + (opcional) cambia background si tu backend lo soporta
    const prompt = "Describ√≠ el nuevo fondo/escena y lo activo.";
    toast(prompt);
    textInput.focus();
  });

  // ===== RESET =====
  resetBtn.addEventListener("click", async () => {
    lastUser.textContent = "‚Äî";
    lastConsia.textContent = "‚Äî";
    consiaMsg.textContent = "Listo. Pod√©s hablar (üéôÔ∏è) o escribir en el chat.";
    status("OK");
  });

  // ===== ASK =====
  async function runAsk(message) {
    lastUser.textContent = message;
    lastConsia.textContent = "‚Ä¶";
    status("Procesando‚Ä¶");

    try {
      const res = await fetch(ASK_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-Consia-Lang": LANG,              // <- idioma fijo al backend
          "Accept-Language": LANG
        },
        body: JSON.stringify({
          message,
          lang: LANG,
          voice: VOICE_ON ? 1 : 0,
          audio: AUDIO_ON ? 1 : 0
        })
      });

      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(data?.error || "ask_failed");

      const text = data?.text || "No pude responder. Prob√° de nuevo.";
      lastConsia.textContent = text;
      status("OK");

      if (VOICE_ON && AUDIO_ON && data?.audio_b64) {
        playBase64Audio(data.audio_b64, data.audio_mime || "audio/mpeg");
      } else if (VOICE_ON && AUDIO_ON) {
        // fallback: pedir TTS
        try {
          const tts = await fetch(TTS_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Consia-Lang": LANG,
              "Accept-Language": LANG
            },
            body: JSON.stringify({ text, lang: LANG })
          });
          const ttsData = await tts.json().catch(() => ({}));
          if (tts.ok && ttsData?.audio_b64) playBase64Audio(ttsData.audio_b64, ttsData.audio_mime || "audio/mpeg");
        } catch(e){}
      }

    } catch (e) {
      lastConsia.textContent = "No pude responder. Prob√° de nuevo.";
      status("Error");
    }
  }

  function playBase64Audio(b64, mime) {
    try{
      const bin = atob(b64);
      const len = bin.length;
      const bytes = new Uint8Array(len);
      for (let i=0;i<len;i++) bytes[i] = bin.charCodeAt(i);
      const blob = new Blob([bytes], { type: mime });
      const url = URL.createObjectURL(blob);
      const a = new Audio(url);
      a.onended = () => URL.revokeObjectURL(url);
      a.play().catch(()=>{});
    }catch(e){}
  }

  function setToggleUI(el, on, label){
    el.classList.toggle("on", on);
    el.textContent = `${label}: ${on ? "ON" : "OFF"}`;
  }

  function status(t){ statusEl.textContent = "Estado: " + t; }
  function toast(t){ consiaMsg.textContent = t; }

  function mapLangToBCP47(l){
    // bloque fuerte para el SpeechRecognition
    if (l === "es") return "es-ES";
    if (l === "en") return "en-US";
    if (l === "pt") return "pt-BR";
    if (l === "it") return "it-IT";
    if (l === "fr") return "fr-FR";
    if (l === "de") return "de-DE";
    return "es-ES";
  }

})();
</script>
</body>
</html>
