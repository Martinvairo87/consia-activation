<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>CONSIA ∞</title>
  <style>
    html,body{margin:0;height:100%;background:#000;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    #stage{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;overflow:hidden}
    video,canvas{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
    #overlay{position:absolute;inset:0;background:radial-gradient(circle at 50% 30%,rgba(255,255,255,.06),rgba(0,0,0,.75))}
    #hud{position:fixed;left:0;right:0;bottom:0;padding:12px 12px calc(12px + env(safe-area-inset-bottom));display:flex;gap:8px;flex-wrap:wrap;background:linear-gradient(to top,rgba(0,0,0,.85),rgba(0,0,0,0))}
    .btn{border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.06);color:#fff;border-radius:14px;padding:10px 12px;font-size:14px}
    .btn:active{transform:scale(.98)}
    #input{flex:1;min-width:180px;border:1px solid rgba(255,255,255,.18);background:rgba(0,0,0,.35);color:#fff;border-radius:14px;padding:10px 12px;font-size:14px}
    #log{position:fixed;top:0;left:0;right:0;max-height:38vh;overflow:auto;padding:10px 12px;background:linear-gradient(to bottom,rgba(0,0,0,.85),rgba(0,0,0,0));font-size:13px;white-space:pre-wrap}
    #brand{position:fixed;top:10px;left:12px;font-weight:700;letter-spacing:.08em;font-size:12px;opacity:.9}
    #status{position:fixed;top:10px;right:12px;font-size:12px;opacity:.8}
    #avatar{position:absolute;inset:0}
    #intro{position:absolute;inset:0;display:none}
    #intro video{object-fit:cover}
  </style>
</head>
<body>
  <div id="stage">
    <!-- INTRO (opcional): si subís intro.mp4 al repo, se activa -->
    <div id="intro"><video id="introVid" muted playsinline></video></div>

    <!-- CAMERA (frontal) -->
    <video id="cam" autoplay playsinline muted></video>

    <!-- COSMIC canvas -->
    <canvas id="cosmic"></canvas>

    <!-- AVATAR layer (video) -->
    <video id="avatar" autoplay playsinline muted loop></video>

    <div id="overlay"></div>
  </div>

  <div id="brand">CONSIA ∞</div>
  <div id="status">INIT</div>
  <div id="log"></div>

  <div id="hud">
    <input id="input" placeholder="Escribí: Hola CONSIA…" />
    <button class="btn" id="send">Enviar</button>
    <button class="btn" id="mic">Voz</button>
    <button class="btn" id="camBtn">Cámara</button>
    <button class="btn" id="uploadBtn">Subir</button>
    <button class="btn" id="teleportBtn">Teleport</button>
  </div>

  <input id="file" type="file" multiple hidden />

<script>
/* =========================
   CONFIG
========================= */
const API_BASE = "https://api.consia.world"; // <-- CAMBIAR SI TU API ES OTRA
const DEVICE = localStorage.getItem("consia_device") || (crypto.randomUUID?.() || String(Date.now()));
localStorage.setItem("consia_device", DEVICE);
const LANG = "ES"; // Lock idioma UI (no mezcla)

/* =========================
   UI HELPERS
========================= */
const $ = (id)=>document.getElementById(id);
const logEl = $("log");
const statusEl = $("status");
function log(s){ logEl.textContent = (s + "\n" + logEl.textContent).slice(0,8000); }
function status(s){ statusEl.textContent = s; }

function safeText(t){ return (t||"").toString(); }

/* =========================
   INTRO AUTOPLAY (si existe intro.mp4)
========================= */
async function tryIntro(){
  try{
    const r = await fetch("./intro.mp4", { method:"HEAD" });
    if(!r.ok) return;
    $("intro").style.display="block";
    $("introVid").src="./intro.mp4";
    $("introVid").play().catch(()=>{});
    setTimeout(()=>{ $("intro").style.display="none"; }, 6000);
  }catch{}
}

/* =========================
   REALTIME WS
========================= */
let ws;
function wsConnect(){
  try{
    ws = new WebSocket(API_BASE.replace("https://","wss://").replace("http://","ws://") + "/realtime?device=" + encodeURIComponent(DEVICE));
    ws.onopen = ()=> status("REALTIME ON");
    ws.onmessage = (ev)=>{
      try{
        const d = JSON.parse(ev.data);
        if(d.type==="hello") log("WS: "+d.text);
        if(d.type==="avatar" && d.avatar){
          // si el avatar tiene url, úsalo
          if(d.avatar.url){
            $("avatar").src = d.avatar.url;
          }
          log("Avatar update v"+d.avatar.version);
        }
      }catch{}
    };
    ws.onclose = ()=> { status("REALTIME OFF"); setTimeout(wsConnect, 1500); };
  }catch(e){
    status("REALTIME ERR");
  }
}

/* =========================
   CAMERA (frontal)
========================= */
let camOn = false;
async function cameraStart(){
  const cam = $("cam");
  const stream = await navigator.mediaDevices.getUserMedia({
    video: { facingMode: "user", width: { ideal: 1280 }, height: { ideal: 720 }, frameRate: { ideal: 30, max: 60 } },
    audio: false
  });
  cam.srcObject = stream;
  camOn = true;
  status("CAM ON");
}
function cameraStop(){
  const cam = $("cam");
  const s = cam.srcObject;
  if(s){ s.getTracks().forEach(t=>t.stop()); }
  cam.srcObject = null;
  camOn = false;
  status("CAM OFF");
}

/* =========================
   COSMIC RENDER (simple)
   — placeholder: fondo dinámico + “teleport” por prompt
========================= */
const canvas = $("cosmic");
const ctx = canvas.getContext("2d");
function resize(){
  canvas.width = innerWidth * devicePixelRatio;
  canvas.height = innerHeight * devicePixelRatio;
}
addEventListener("resize", resize); resize();

let cosmicSeed = 0;
function cosmicLoop(){
  const w = canvas.width, h = canvas.height;
  cosmicSeed += 0.01;
  ctx.clearRect(0,0,w,h);
  // estrellas
  for(let i=0;i<200;i++){
    const x = (Math.sin(i*12.9898+cosmicSeed*3)*0.5+0.5)*w;
    const y = (Math.cos(i*78.233+cosmicSeed*2)*0.5+0.5)*h;
    const a = (Math.sin(cosmicSeed+i)*0.5+0.5);
    ctx.globalAlpha = 0.15 + a*0.35;
    ctx.fillStyle = "#fff";
    ctx.fillRect(x,y,2*devicePixelRatio,2*devicePixelRatio);
  }
  ctx.globalAlpha = 1;
  requestAnimationFrame(cosmicLoop);
}
cosmicLoop();

function teleport(prompt){
  log("TELEPORT: " + prompt);
  // Efecto simple: aumenta intensidad cósmica
  cosmicSeed += 1.0;
}

/* =========================
   LIPSYNC HOOK (realista simple)
   - mueve “intensidad” por amplitude (placeholder)
   - para lipsync real: se integra motor externo (Audio2Face/Wav2Lip)
========================= */
let audioCtx, analyser, micStream;
async function startMicLipsync(){
  audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
  micStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
  const src = audioCtx.createMediaStreamSource(micStream);
  analyser = audioCtx.createAnalyser();
  analyser.fftSize = 2048;
  src.connect(analyser);
  status("MIC ON");
  lipsyncLoop();
}
function stopMicLipsync(){
  if(micStream){ micStream.getTracks().forEach(t=>t.stop()); micStream=null; }
  analyser=null;
  status("MIC OFF");
}
function lipsyncLoop(){
  if(!analyser) return;
  const data = new Uint8Array(analyser.fftSize);
  analyser.getByteTimeDomainData(data);
  let sum=0;
  for(let i=0;i<data.length;i++){
    const v = (data[i]-128)/128;
    sum += v*v;
  }
  const rms = Math.sqrt(sum/data.length);
  // Simula “boca” aumentando contraste del avatar
  $("avatar").style.filter = `contrast(${1 + rms*1.5}) brightness(${1 + rms*0.6})`;
  requestAnimationFrame(lipsyncLoop);
}

/* =========================
   API CALLS
========================= */
async function consiaAsk(message, files=null){
  status("ASK…");
  if(files && files.length){
    const fd = new FormData();
    fd.append("message", message);
    fd.append("lang", LANG);
    for(const f of files) fd.append("file", f, f.name);
    const res = await fetch(API_BASE + "/ask", {
      method:"POST",
      headers:{ "x-consia-device": DEVICE },
      body: fd
    });
    const j = await res.json();
    status("OK");
    return j;
  }else{
    const res = await fetch(API_BASE + "/ask", {
      method:"POST",
      headers:{ "content-type":"application/json", "x-consia-device": DEVICE },
      body: JSON.stringify({ message, lang: LANG })
    });
    const j = await res.json();
    status("OK");
    return j;
  }
}

async function industrialLead(payload){
  const res = await fetch(API_BASE + "/industrial/lead",{
    method:"POST",
    headers:{ "content-type":"application/json", "x-consia-device": DEVICE },
    body: JSON.stringify({ device: DEVICE, ...payload })
  });
  return await res.json();
}

/* =========================
   UI EVENTS
========================= */
$("send").onclick = async ()=>{
  const msg = $("input").value.trim() || "Hola CONSIA";
  $("input").value="";
  log("YOU: " + msg);
  const r = await consiaAsk(msg);
  log("CONSIA: " + safeText(r.reply));
};

$("mic").onclick = async ()=>{
  if(!analyser){
    await startMicLipsync();
  }else{
    stopMicLipsync();
  }
};

$("camBtn").onclick = async ()=>{
  try{
    if(!camOn) await cameraStart();
    else cameraStop();
  }catch(e){
    log("CAM ERR: " + e.message);
  }
};

$("uploadBtn").onclick = ()=> $("file").click();
$("file").onchange = async ()=>{
  const files = Array.from($("file").files || []);
  if(!files.length) return;
  const msg = "Analizá estos archivos y guiame.";
  log("UPLOAD: " + files.map(f=>f.name).join(", "));
  const r = await consiaAsk(msg, files);
  log("CONSIA: " + safeText(r.reply));
};

$("teleportBtn").onclick = ()=>{
  const prompt = promptText();
  teleport(prompt);
};

function promptText(){
  const t = $("input").value.trim();
  return t || "Teleport a un entorno futurista premium";
}

// Quick-start: WS + Intro
(async function init(){
  status("INIT");
  await tryIntro();
  wsConnect();
  // Avatar default: si tenés un video avatar en el repo, ponelo como ./avatar.mp4
  try{
    const r = await fetch("./avatar.mp4", { method:"HEAD" });
    if(r.ok) $("avatar").src = "./avatar.mp4";
  }catch{}
  status("READY");
  log("CONSIA ∞ READY — Decí: Hola CONSIA");
})();
</script>
</body>
</html>
